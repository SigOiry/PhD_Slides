---
format:
  revealjs:
    transition: slide
    theme:
      - default
      - style.scss
    footer: ""
    width: 2400
    height: 1350
    auto-animate: true
    auto-play-media: true
    backgroundTransition: fade
    controls-tutorial: true
    controls: true
    controls-layout: bottom-right
    slide-number: true
    include-after-body: moving-text.js
    # includes:
    #   before_body: custom.js
    simplemenu:
        barhtml:
            header: "<div class='menubar'></a><ul class='menu'></ul><div class='slide-number'></div><div>"
        scale: 0.8
  revealjs-options:
        preloadIframes: true
        viewDistance: 5
        pdfSeparateFragments: true

revealjs-plugins:
  - simplemenu
editor_options: 
  chunk_output_type: console
---

```{r library}
#| cache: true
#| echo: false
#| eval: true
#| warning: false

library(tidyverse)
library(Utilities.Package)
library(sf) 
library(rnaturalearth) 
library(rnaturalearthdata) 
library(rnaturalearthhires)
library(leaflet)
library("leaflet.extras")
```


```{r update gitignore}
#| cache: true
#| echo: false
#| warning: false
#| eval: false

library(fs)

# Define the size threshold in bytes (100 MB)
size_threshold <- 100 * 1024 * 1024

# Get a list of all files in the repository
files <- dir_ls(path = "Slides", recurse = TRUE, type = "file")

# Filter files larger than the size threshold
large_files <- files[file_info(files)$size > size_threshold]

# Check if there are large files
if (length(large_files) > 0) {
  # Read the existing .gitignore file if it exists
  gitignore_path <- ".gitignore"
  gitignore_content <- if (file_exists(gitignore_path)) {
    readLines(gitignore_path)
  } else {
    character(0)
  }
  
  # Identify files not already in .gitignore
  files_to_add <- large_files[!large_files %in% gitignore_content]
  
  # Append new large files to .gitignore
  if (length(files_to_add) > 0) {
    writeLines(c(gitignore_content, files_to_add), gitignore_path)
    message(length(files_to_add), " file(s) added to .gitignore.")
  } else {
    message("No new files to add to .gitignore.")
  }
} else {
  message("No files larger than 100 MB found.")
}
```


## {.hide data-state="hide-menubar"}

::: {.gradient_box style="text-align: center; position: absolute; left: 50%; top: 22%; width: 1800px; transform: translate(-50%, -50%)"}
[PhD Thesis Presentation]{style="color: black; font-size: 80px; font-weight: bold; line-height: 1em; margin: 0px; text-align: justify-all;"}
:::

::: {.gradient_box style="text-align: center; position: absolute; left: 50%; top: 37%; width: 1800px; transform: translate(-50%, -50%)"}
[Characterisation of Intertidal Vegetation on European Coasts Using MultiScale Remote Sensing in Response to Natural and Anthropogenic Pressures]{style="color: black; font-size: 60px; line-height: 1em; margin: 0px; text-align: justify-all;"}
:::

<!-- ::: {style="text-align: left; position: absolute; left: 25%; top: 50%; width: 1200px; transform: translate(-50%, -50%)"} -->
<!-- [Date & Time:]{style="color: black; font-size: 35px; font-weight: bold;"} -->
<!-- ::: -->
::: {style="text-align: left; position: absolute; right: 0%; top: 93%; transform: translate(-50%, -50%)"}
[The 15th of May 2025]{style="color: black; font-size: 50px;"}
:::

<!-- ::: {style="text-align: left; position: absolute; left: 25%; top: 53%; width: 1200px; transform: translate(-50%, -50%)"} -->
<!-- [Location: ]{style="color: black; font-size: 35px; font-weight: bold;"} -->
<!-- ::: -->
<!-- ::: {style="text-align: left; position: absolute; left: 40%; top: 53%; width: 1200px; transform: translate(-50%, -50%)"} -->
<!-- [Amphitéatre Pasteur, Nantes Université (France)]{style="color: black; font-size: 35px;"} -->
<!-- ::: -->

::: {style="text-align: left; position: absolute; left: 25%; top: 50%; width: 1200px; transform: translate(-50%, -50%)"}
[Thesis supervisor: ]{style="color: black; font-size: 35px; font-weight: bold;"}
:::
::: {style="text-align: left; position: absolute; left: 40%; top: 50%; width: 1200px; transform: translate(-50%, -50%)"}
[Laurent Barillé, Professor]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 25%; top: 53%; width: 1200px; transform: translate(-50%, -50%)"}
[Co-supervisor: ]{style="color: black; font-size: 35px; font-weight: bold;"}
:::
::: {style="text-align: left; position: absolute; left: 40%; top: 53%; width: 1200px; transform: translate(-50%, -50%)"}
[Pierre Gernez, Lecturer]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 25%; top: 59%; width: 1200px; transform: translate(-50%, -50%)"}
[Jury members:]{style="color: black; font-size: 35px; font-weight: bold;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 64%; width: 1200px; transform: translate(-50%, -50%)"}
[Antoine Collin]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 69%; width: 1200px; transform: translate(-50%, -50%)"}
[Rodney Forster]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 74%; width: 1200px; transform: translate(-50%, -50%)"}
[Evangelos Spyrakos]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 79%; width: 1200px; transform: translate(-50%, -50%)"}
[Bárbara Ondiviela]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 84%; width: 1200px; transform: translate(-50%, -50%)"}
[Federica Braga]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 89%; width: 1200px; transform: translate(-50%, -50%)"}
[Laurent Barillé]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 28%; top: 94%; width: 1200px; transform: translate(-50%, -50%)"}
[Pierre Gernez]{style="color: black; font-size: 35px;"}
:::


::: {style="text-align: left; position: absolute; left: 43%; top: 64%; width: 1200px; transform: translate(-50%, -50%)"}
[Lecturer]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 69%; width: 1200px; transform: translate(-50%, -50%)"}
[Professor]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 74%; width: 1200px; transform: translate(-50%, -50%)"}
[Professor]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 79%; width: 1200px; transform: translate(-50%, -50%)"}
[Senior scientist]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 84%; width: 1200px; transform: translate(-50%, -50%)"}
[Senior Researcher]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 89%; width: 1200px; transform: translate(-50%, -50%)"}
[Professor]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 43%; top: 94%; width: 1200px; transform: translate(-50%, -50%)"}
[Lecturer]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 64%; width: 1200px; transform: translate(-50%, -50%)"}
[École Pratique des Hautes Études (EPHE), Dinard, France]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 69%; width: 1200px; transform: translate(-50%, -50%)"}
[University of Hull, United Kingdom]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 74%; width: 1200px; transform: translate(-50%, -50%)"}
[University of Stirling, United Kingdom]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 79%; width: 1200px; transform: translate(-50%, -50%)"}
[Universidad de Cantabria, Spain]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 84%; width: 1200px; transform: translate(-50%, -50%)"}
[CNR-ISMAR, Venice, Italy]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 89%; width: 1200px; transform: translate(-50%, -50%)"}
[Nantes Université, France]{style="color: black; font-size: 35px;"}
:::

::: {style="text-align: left; position: absolute; left: 58%; top: 94%; width: 1200px; transform: translate(-50%, -50%)"}
[Nantes Université, France]{style="color: black; font-size: 35px;"}
:::


::: {.absolute top="65%" right="-10%" style="transform: translate(-50%, -50%);"}
![](Images/Profile_SImon.png){height="600"}
:::

::: {.gradient_box style="text-align: center; position: absolute; right: -3%; top: 86%; width: 500px; transform: translate(-50%, -50%)"}
[Simon Oiry]{style="color: black; font-size: 60px; line-height: 1em; margin: 0px; text-align: justify-all;"}
:::

::: {.absolute top="10%" left="5%" style="transform: translate(-50%, -50%);"}
![](Images/nantes-universite.png){height="300"}
:::

::: {.absolute top="10%" right="-5%" style="transform: translate(-50%, -50%);"}
![](Images/rsbe2.png){height="300"}
:::

::: {.absolute top="10%" left="50%" style="transform: translate(-50%, -50%);"}
![](Images/LogoED.png){height="150"}
:::

<!-- ## Preface {data-state="hide-menubar"} -->

<!-- ::: {.notes} -->
<!-- Between 2021 & 2024 -->

<!-- BiCOME: Developing tools for biodiversity monitoring -->

<!-- REWRITE: Ongoing, Founded by Europe, Rewilding of intertidal areas accross Europe -->

<!-- InvaSea: Ongoing, Mapping of Invasive macroalgae, focusing on *G. vermiculophylla* -->

<!-- ::: -->

<!-- ::: {.fragment .fade-out fragment-index="2"} -->
<!-- ::: {.absolute bottom="0%" left="0%"} -->
<!-- ![](Images/Preface/Photo_Labo.jpg){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute top="3%" right="0%"} -->
<!-- ![](Images/Preface/logo_footer_UN.png){height="200"} -->
<!-- ::: -->

<!-- ::: {.absolute top="0%" left="30%" } -->
<!-- ![](Images/Preface/Boutons_Laboratoires_Isomer.png){height="300"} -->
<!-- ::: -->



<!-- ::: {.absolute style="text-align: center; position: absolute; left: 48%; top: 47%; width: 1000px; transform: translate(-50%, -50%)"} -->
<!-- [Remote Sensing, Benthic Ecology and Ecotoxicology]{style="color: black; font-size: 80px; font-weight: bold; line-height: 1em; margin: 0px; text-align: justify-all;"} -->
<!-- ::: -->

<!-- ::: {.absolute top="25%" right="0%" } -->
<!-- ![](Images/Preface/rsbe2.png){height="500"} -->
<!-- ::: -->

<!-- ::: {.absolute left="25%" top="65%" style="font-size: 50px; width: 900px;"} -->
<!-- - Benthic ecology and shellfish aquaculture -->
<!-- - Biodiversity of benthic primary producers -->
<!-- - Hyperspectral, multispectral and drone remote sensing -->
<!-- ::: -->

<!-- ::: {.absolute right="-5%" top="65%" style="font-size: 50px; width: 900px;"} -->
<!-- - Ecotoxicology and emerging pollutants -->
<!-- - Marine optics and ocean colour remote sensing -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.watercolor-container .fragment .fade-in fragment-index="2"} -->

<!-- ![](Images/Preface/Watercolor_background.png){.watercolor-img} -->

<!-- ::: {.watercolor-text} -->
<!-- PhD related projects -->
<!-- ::: -->

<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="2%" top="0%" style="opacity: 0.2;"} -->

<!-- ![](Images/Preface/Watercolor_background_green.png){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="1%" top="2%" style="z-index: -1;"} -->

<!-- ![](Images/Others/BiCOME Logo.png){height="300"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="12%" top="10%" style="font-size: 50px;"} -->
<!-- BiCOME Project -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="15%" top="15%" style="font-size: 30px;"} -->
<!-- 2021-2024 -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" width="600" left="5%" top="25%" style="font-size: 40px;"} -->
<!-- - Develop Observation tools -->
<!-- - Assess impacts of land/sea use, pollution and climate change -->
<!-- - identify regions of resilience or sensitivity -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="10%" top="52%" style="font-size: 40px;"} -->
<!-- Project funded by: -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" left="11%" top="55%"} -->
<!-- ![](Images/Preface/ESA_Logo.png){height="350"} -->
<!-- ::: -->


<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="0%" top="0%" style="opacity: 0.2;"} -->

<!-- ![](Images/Preface/Watercolor_background_yellow.png){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="-2%" top="2%"} -->

<!-- ![](Images/Preface/rewrite-logo.png){height="100"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="12%" top="10%" style="font-size: 50px;"} -->
<!-- REWRITE Project -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="15%" top="15%" style="font-size: 30px;"} -->
<!-- 2024-Actual -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" width="600" right="5%" top="25%" style="font-size: 40px;"} -->
<!-- Aims to revitalize Europe's intertidal areas through rewilding, promoting climate resilience, biodiversity, and societal benefits along the European shoreline. -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="10%" top="50%" style="font-size: 40px;"} -->
<!-- Project funded by: -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="4" right="9%" top="55%"} -->
<!-- ![](Images/Preface/EU_Logo.png){height="180"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" left="30%" bottom="0%" style="opacity: 0.2;"} -->

<!-- ![](Images/Preface/Watercolor_background_red.png){height="650"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" left="30%" top="52%" style="font-size: 50px;"} -->
<!-- InvaSea Project -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" left="33%" top="57%" style="font-size: 30px;"} -->
<!-- 2024-Actual -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" width="800" left="35%" top="62%" style="font-size: 40px;"} -->
<!-- - Assessing the Capacity of Remote Sensing to Map Invasive Red Algae -->
<!-- - Mapping *G. vermiculophylla* along the French coastline -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" left="30%" top="80%" style="font-size: 40px;"} -->
<!-- Project funded by: -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="5" left="50%" top="75%"} -->
<!-- ![](Images/Preface/cnes_logo.png){height="300"} -->
<!-- ::: -->

<!-- - thesis took place in ISOMER Nantes between 2021 and 2024 -->
<!-- - It has been found by the french government blabla --> 
<!-- - It was closely related to a ESA founded project called BiCOME --> 



# Introduction {data-stack-name="Introduction" background-image="Images/Intro/title_background.png"}
- [Coastal Environments](#coastal-environments)
- [Human Activities](#human-activities)
- [Environmental Impacts](#environmental-impacts)
- [Interidal Habitats](#intertidal-habitats)
- [Remote Sensing](#remote-sensing) 
- [Objectives of this work](#objectives-of-this-work)

## Coastal Environments

::: {.absolute top="6.5%"}
*Areas where the land masses meet the seas*
:::

::: {.notes}
1st: Map of Brittany, North West of France
2nd: Map of Bourgneuf Bay, near Nantes

:::

```{r map dens_pop}
#| echo: false
#| eval: false
#| warning: false

library(sf)
library(tidyverse)

TDC <- read_sf("Data/Intro/Trait_de_cote.shp")
coms <- read_sf("Data/Intro/commune.shp")
coms_buf_50km <- read_sf("Data/Intro/Coms_50km.shp")
coms_buf_25km <- read_sf("Data/Intro/Coms_25km.shp")

TDC_buf <- st_buffer(TDC, dist = 10)

x_ref <- 403256
y_ref <- 6511916

#### COMS ####
centroids <- st_centroid(coms)
coords <- st_coordinates(centroids)
top_left <- coords[,1] < x_ref & coords[,2] > y_ref
coms_cropped <- coms[top_left, ]

#### COMS 50km####
centroids <- st_centroid(coms_buf_50km)
coords <- st_coordinates(centroids)
top_left <- coords[,1] < x_ref & coords[,2] > y_ref
coms_50km_cropped <- coms_buf_50km[top_left, ]

#### COMS 25km####
centroids <- st_centroid(coms_buf_25km)
coords <- st_coordinates(centroids)
top_left <- coords[,1] < x_ref & coords[,2] > y_ref
coms_25km_cropped <- coms_buf_25km[top_left, ]

if(file.exists("Data/Intro/Coms_on_the_sea.shp")){
  Coms_on_the_sea<- read_sf("Data/Intro/Coms_on_the_sea.shp")

}else{
  intersects <- st_intersects(coms_cropped, TDC_buf, sparse = FALSE)
  Coms_on_the_sea <- coms_cropped[apply(intersects, 1, any), ]
  
  write_sf(Coms_on_the_sea.shp, "Data/Intro/Coms_on_the_sea.shp")  
}


nantes_lonlat <- st_sfc(st_point(c(-1.5536, 47.2184)), crs = 4326)
nantes_l93 <- st_transform(nantes_lonlat, crs = 2154)  # Lambert-93


plot_France <- ggplot() +
  geom_sf(data = coms_cropped, fill = "#89a979", color = "#89a979") + 
    geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

plot_coms_by_the_sea <- ggplot() +
  geom_sf(data = coms_cropped, fill = "#89a979", color = "#89a979") +  # original polygons (lighter)
  geom_sf(data = Coms_on_the_sea, fill = "#596f50", color = "#596f50") + 
  geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +

  # selected polygons
  coord_sf(expand = F)+
  theme_void()

colscale <- c("50km" = "#7f9a6f", "25km" = "#739069", "0km"="#596f50" )

plot_bands <- ggplot() +
  geom_sf(data = coms_cropped, fill = "#89a979", color = "#89a979") +  
  geom_sf(data = coms_50km_cropped, aes(fill = "50km", color = "50km"),show.legend = F) + 
  geom_sf(data = coms_25km_cropped, aes(fill = "25km", color = "25km"),show.legend = F) + 
  geom_sf(data = Coms_on_the_sea, aes(fill = "0km", color = "0km"),show.legend = F) +
  scale_fill_manual(values = colscale)+
  scale_color_manual(values = colscale)+
  geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +

  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Coms_France.png", plot_France, height=1350*4, width = 950*4, units = "px")

ggsave("Images/Intro/Coms_by_the_Sea.png", plot_coms_by_the_sea, height=1350*4, width = 950*4, units = "px")

ggsave("Images/Intro/Coms_bands.png", plot_bands, height=1350*4, width = 950*4, units = "px")

dens_pop_map <- ggplot() +
  geom_sf(data = coms_cropped, aes(color = dens_pop, fill = dens_pop)) +
  # scale_fill_manual(values = colscale)+
  # scale_color_manual(values = colscale)+
  geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
  # tidyterra::scale_fill_grass_c(palette = "batlow", use_grass_range = F,limits = c(1, 6000), trans = "log10")+
  # tidyterra::scale_color_grass_c(palette = "batlow", use_grass_range = F,limits = c(1, 6000), trans = "log10")+
  scico::scale_fill_scico(name = "People/km²",palette = "vik", limits = c(1, 4000), trans = "log10")+
  scico::scale_color_scico(name = "People/km²",palette = "vik", limits = c(1, 4000), trans = "log10")+
  # selected polygons
  coord_sf(expand = F)+
  theme_void() +
  theme(
    legend.position = c(0.25, 0.25),
    legend.key.height = unit(2, "cm"),    # taller legend
    legend.text = element_text(size = 20),  # bigger numbers
    legend.title = element_text(size = 22, face = "bold") # bigger title
  )

ggsave("Images/Intro/dens_pop_map.png", dens_pop_map, height=1350*4, width = 950*4, units = "px")

```

<!-- ::: {.fragment .fade-out fragment-index="3"} -->
<!-- ::: {.absolute bottom="-3%" right="-11%"} -->
<!-- ![](Images/Intro/Coms_France.png){height="1350"} -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.absolute bottom="-3%" right="-11%" .fragment .fade-in-then-out fragment-index="1"} -->
<!-- ![](Images/Intro/Coms_by_the_Sea.png){height="1350"} -->
<!-- ::: -->

::: {.absolute bottom="-3%" right="-11%" .fragment .fade-out fragment-index="3"}
![](Images/Intro/Coms_bands.png){height="1350"}
:::

::: {.absolute bottom="-3%" right="-11%" .fragment .fade-in fragment-index="3"}
![](Images/Intro/dens_pop_map.png){height="1350"}
:::

::: {.absolute bottom="5%" left="15%" .fragment .fade-in fragment-index="4"}
![](Images/Intro/CoastalPopulation.png){height="700"}
:::

::: {.absolute left="0%" bottom="0%" style="font-size: 60px;"}
Interface regions where land and sea meet
:::

::: {.fragment .fade-out fragment-index="3"}
::: {.absolute left="10%" top="15%" style="font-size: 50px; width: 900px; color: #596f50;"}
- Directly in contact with the sea
:::

::: {.absolute left="10%" top="21%" style="font-size: 50px; width: 900px; color: #739069;"}
- 25km away from the sea
:::

::: {.absolute left="10%" top="27%" style="font-size: 50px; width: 900px; color: #7f9a6f;"}
- 50km away from the sea
:::
:::

::: {.absolute left="0%" top="15%" .fragment .fade-in fragment-index="3" style="font-size: 50px;"}
-   French Coast are densely populated:
:::

::: {.absolute .fragment .fade-in fragment-index="3" left="10%" top="21%" style="font-size: 40px;"}
-   4% of the French territory
:::

::: {.absolute .fragment .fade-in fragment-index="3" left="10%" top="27%" style="font-size: 40px;"}
-   10% of the French population
:::

::: {.absolute left="0%" top="35%" .fragment .fade-in fragment-index="4" style="font-size: 50px;"}
-   Globally: 
:::

::: {.absolute right="5%" bottom="0%" .fragment .fade-in fragment-index="4" style="font-size: 30px;"}
*Source:* [*Cosby et al. (2024)*](https://doi.org/10.1038/s41598-024-73287-x) *,* [*Reimann et al., (2023)*](https://doi.org/10.1017/cft.2023.3) 
:::

::: {.absolute left="30%" bottom="45%" .fragment .fade-in fragment-index="4" style="font-size: 40px;"}
1 billion people (15%) within 10km (4%)
:::

::: {.absolute left="30%" bottom="40%" .fragment .fade-in fragment-index="4" style="font-size: 40px;"}
~3 billion by 2100
:::

## Human activities {data-transition="fade"}

::: {.absolute top="6.5%"}
*Hotspots of Economic Growth*
:::


::: {.notes}

These economic activities also come with environmental costs, impacting habitats, water quality, and marine life
:::

::: {.absolute right="0%" top="0%" style="font-size: 30px; color: black; z-index: 9999;"}
[*source: developpement-durable.gouv.fr*](https://www.geolittoral.developpement-durable.gouv.fr/telechargement-en-ligne-donnees-geolittoral-a802.html)
:::

```{r maps coastal activities}
#| echo: false
#| eval: false
#| warning: false

library(sf)
library(tidyverse)

coms <- read_sf("Data/Intro/commune.shp")


# Create bounding box as an sf object
bbox <- st_as_sfc(st_bbox(c(xmin = 252579, xmax = 323049,
                            ymin = 6655218, ymax = 6708566),
                          crs = st_crs(coms)))
cropped_coms <- st_intersection(coms, bbox)

dragage <- read_sf("Data/Intro/N_zones_homogenes_dragage_S_metropole_EPSG2154.shp")%>% 
  st_transform(st_crs(cropped_coms)) %>% 
  st_intersection(bbox) 

Port <- read_sf("Data/Intro/N_carenage_P_epsg3857_20220630.shp") %>% 
  st_transform(st_crs(cropped_coms))%>% 
  st_intersection(bbox) 

Immersion_sed <- read_sf("Data/Intro/N_immersion_S_metropole_epsg2154_2005-2020.shp") %>% 
  st_transform(st_crs(cropped_coms))%>% 
  st_intersection(bbox) 

Aquaculture <- read_sf("Data/Intro/cadastre_emprise_2025.shp") %>% 
  st_transform(st_crs(cropped_coms))%>% 
  st_intersection(bbox)

Eol <- read_sf("Data/Intro/parc_emr_autorise_en_projet.shp") %>% 
  st_transform(st_crs(cropped_coms))%>% 
  st_intersection(bbox)

Ouvrage <- read_sf("Data/Intro/N_ouvrages_littoraux_metropole_epsg2154_L.shp") %>% 
  st_transform(st_crs(cropped_coms))%>% 
  st_intersection(bbox)
  
# Crop the polygon with the bounding box

plot <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") + 
    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB.png", plot, width = 10, height=8.12, dpi=150)


plot_port <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") +
  geom_sf(data = Port, color = "darkred") +
    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB_port.png", plot_port, width = 10, height=8.12, dpi=150)


plot_dragage <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") +
  geom_sf(data = Port, color = "darkred") +
  geom_sf(data = dragage, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Immersion_sed, color = "goldenrod3", fill = "goldenrod3") +

    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB_dragage.png", plot_dragage, width = 10, height=8.12, dpi=150)

plot_aquaculture <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") +
  geom_sf(data = Port, color = "darkred") +
  geom_sf(data = dragage, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Immersion_sed, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Aquaculture, color = "darkblue", fill = "darkblue") +

    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB_Aquaculture.png", plot_aquaculture, width = 10, height=8.12, dpi=150)

plot_Eol <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") +
  geom_sf(data = Port, color = "darkred") +
  geom_sf(data = dragage, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Immersion_sed, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Aquaculture, color = "darkblue", fill = "darkblue") +
  geom_sf(data = Eol, color = "gold", fill = "gold") +

  
    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB_Eol.png", plot_Eol, width = 10, height=8.12, dpi=150)

plot_ouvrage <- ggplot() +
  geom_sf(data = cropped_coms, fill = "#89a979", color = "#89a979") +
  geom_sf(data = Port, color = "darkred") +
  geom_sf(data = dragage, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Immersion_sed, color = "goldenrod3", fill = "goldenrod3") +
  geom_sf(data = Aquaculture, color = "darkblue", fill = "darkblue") +
  geom_sf(data = Eol, color = "gold", fill = "gold") +
  geom_sf(data = Ouvrage, color = "black", fill = "black", linewidth = 2) +

    # geom_sf(data = nantes_l93, fill = "red", color = "black",shape = 21,size = 8) +
# original polygons (lighter)
  # geom_sf(data = intersecting_polygons, fill = "#6e8962", color = "#6e8962") + 
  # selected polygons
  coord_sf(expand = F)+
  theme_void()

ggsave("Images/Intro/Map_BB_ouvrage.png", plot_ouvrage, width = 10, height=8.12, dpi=150)


```

::: {.absolute bottom="-6%" right="-11%"}
![](Images/Intro/Map_BB.png){height="1400"}
:::

::: {.absolute bottom="-6%" right="-11%" .fragment .fade-in-then-out fragment-index="1"}
![](Images/Intro/Map_BB_port.png){height="1400"}
:::

::: {.absolute bottom="-6%" right="-11%" .fragment .fade-in-then-out fragment-index="2"}
![](Images/Intro/Map_BB_dragage.png){height="1400"}
:::

::: {.absolute bottom="-6%" right="-11%" .fragment .fade-in-then-out fragment-index="3"}
![](Images/Intro/Map_BB_Aquaculture.png){height="1400"}
:::

::: {.absolute bottom="-6%" right="-11%" .fragment .fade-in-then-out fragment-index="4"}
![](Images/Intro/Map_BB_Eol.png){height="1400"}
:::

::: {.absolute bottom="-6%" right="-11%" .fragment .fade-in fragment-index="5"}
![](Images/Intro/Map_BB_ouvrage.png){height="1400"}
:::

::: {.absolute top="15%" left="0%" .fragment .fade-in fragment-index="1"}
![](Images/Intro/Seaport.png){height="500"}
:::

::: {.absolute top="55%" left="0%" .fragment .fade-in fragment-index="2"}
![](Images/Intro/Dragage.png){height="500"}
:::

::: {.absolute top="15.8%" left="21%" .fragment .fade-in fragment-index="3"}

<video src="Video/Intro/Oyster_farm.mp4" height="525" autoplay loop muted playsinline></video>

:::

::: {.absolute top="55%" left="21%" .fragment .fade-in fragment-index="4"}
![](Images/Intro/Eolienne.png){height="500"}
:::

::: {.absolute top="15%" left="42%" .fragment .fade-in fragment-index="5"}
![](Images/Intro/Gois.png){height="500"}
:::

::: {.absolute left="6%" top="11%" .fragment .fade-in fragment-index="1" style="font-size: 50px; color: #78170e;"}
Seaport
:::

::: {.absolute left="5%" bottom="0%" .fragment .fade-in fragment-index="2" style="font-size: 50px; color: #a98a36;"}
Dredging
:::

::: {.absolute left="26%" top="11%" .fragment .fade-in fragment-index="3" style="font-size: 50px; color: #130985;"}
Aquaculture
:::

::: {.absolute left="23%" bottom="0%" .fragment .fade-in fragment-index="4" style="font-size: 50px; color: #ffd700;"}
Energy Production
:::

::: {.absolute left="46%" top="11%" .fragment .fade-in fragment-index="5" style="font-size: 50px; color: black;"}
Artificialisation
:::

::: {.absolute left="43%" top="56%" .fragment .fade-in fragment-index="6" style="font-size: 50px; color: black;"}
- Fishing activities
- Tourism
- Industries
- ...
:::



## Environmental Impacts {data-transition="fade"}
::: {.absolute top="6.5%"}
*The mark of human activity on nature*
:::

::: {.absolute right="0%" top="0%" style="font-size: 30px; color: black; z-index: 9999;"}
[*developpement-durable.gouv.fr*](https://www.geolittoral.developpement-durable.gouv.fr/telechargement-en-ligne-donnees-geolittoral-a802.html)
:::

::: {.absolute bottom="-6%" right="-11%"}
![](Images/Intro/Map_BB_ouvrage.png){height="1400"}
:::

::: {.absolute top="15%" left="0%"}
![](Images/Intro/Spills.png){height="500"}
:::

::: {.absolute top="55%" left="0%"}
![](Images/Intro/Erosion.png){height="500"}
:::

::: {.absolute top="15.8%" left="21%"}
<video src="Video/Intro/Oyster_reef2.mp4" height="525" autoplay loop muted playsinline></video>

:::

::: {.absolute top="55%" left="21%"}
![](Images/Intro/energy.png){height="500"}
:::

::: {.absolute top="15%" left="42%"}
![](Images/Intro/habitat_destruction.png){height="500"}
:::

::: {.absolute left="6%" top="11%" style="font-size: 50px; color: #78170e;"}
Oil spills
:::

::: {.absolute left="5%" bottom="0%" style="font-size: 50px; color: #a98a36;"}
Erosion
:::

::: {.absolute left="19%" top="11%" style="font-size: 50px; color: #130985;"}
Alien Species Introduction
:::

::: {.absolute left="23%" bottom="0%" style="font-size: 50px;"}
Climate change
:::

::: {.absolute left="43%" top="11%" style="font-size: 50px; color: black;"}
Habitat destruction
:::

::: {.absolute left="43%" top="56%" style="font-size: 50px; color: black;"}
- Fishing activities
- Pollutions
- ...
:::

## Intertidal habitats

::: {.absolute top="6.5%"}
*Living on the edge of land and sea*
:::

::: {.notes}
... and many more habitats like Coralline algal reefs or Cobble or gravel beaches

Seagrass: Blue Carbon Habitat
Hypocamp of the Gulf of Morbihan 
Dugong of the Indo-Pacific
Brent Goose of Noirmoutier

Green and red algae, nutrient sequestration, but can be a threat for ecosystems
:::

::: {.fragment .fade-out fragment-index="1"}

::: {.absolute top="13%" left="0%"}
Areas between high and low tide
:::


::: {.absolute top="17%" left="0%"}
![](Images/Intro/saltmarsh.jpg){height="500"}
:::

::: {.absolute top="17%" left="28%"}
![](Images/Intro/mangroves.jpg){height="500"}
:::

::: {.absolute top="17%" left="59%"}
![](Images/Intro/polychaete_reef.jpg){height="500"}
:::

::: {.absolute bottom="3%" left="39%"}
![](Images/Intro/mudflat.png){height="500"}
:::

::: {.absolute bottom="3%" left="67.2%"}
![](Images/Intro/Oyster_reefs.png){height="500"}
:::

<!-- ::: {.absolute bottom="3%" left="0%"} -->
<!-- ![](Video/Intro/Philippe_Vigo.mp4){height="500"} -->
<!-- ::: -->

::: {.absolute bottom="3%" left="0%"}
<video src="Video/Intro/Philippe_Vigo.mp4" height="530" autoplay loop muted playsinline></video>
:::

::: {.absolute left="1%" top="19%" style="font-size: 40px; color: black;"}
Saltmarshes
:::

::: {.absolute left="29%" top="19%" style="font-size: 40px; color: white;"}
Mangroves
:::

::: {.absolute left="60%" top="19%" style="font-size: 40px; color: black;"}
Polychaete reefs
:::

::: {.absolute left="1%" top="57%" style="font-size: 40px; color: black;"}
Rocky reefs
:::

::: {.absolute left="40%" top="89%" style="font-size: 40px; color: white;"}
Tidal flats
:::

::: {.absolute left="68.2%" top="57%" style="font-size: 40px; color: black;"}
Oyster reefs
:::

::: {.absolute bottom="0%" right="6%"}
*A rich variety of intertidal habitats*
:::
:::

::: {.fragment .fade-out fragment-index="4"}
::: {style="position:absolute; top:10%; left:0%; transition: top 1s ease;" .fragment .fade-in fragment-index="1"}
::: {.absolute bottom="-5%" .fragment .fade-out fragment-index="2"}
Soft-bottom substrates
:::
::: {.absolute bottom="-2%" right="7%" style="font-size: 30px;"}
*Guadalquivir River, Spain*
:::
<video src="Video/Intro/soft_bottom.mp4" height="650" autoplay loop muted playsinline></video>


::: {.absolute left="60%" top="110%" .fragment .fade-in-then-out fragment-index="2"}
- A - Magnoliopsida
- B - Bacillariophyceae
- C - Phaeophyceae
- D - Florideophyceae
- E - Chlorophyceae
:::

::: {.absolute left="5%" top="115%" .fragment .fade-in-then-out fragment-index="2" style="font-size: 60px;"}
Five Taxonomic Classes
:::

::: {.absolute left="14%" top="125%" .fragment .fade-in-then-out fragment-index="2" style="font-size: 60px;"}
of Vegetation
:::

:::
:::

::: {.absolute top="10%" right="0%" .fragment .fade-in-then-out fragment-index="1"}
::: {.absolute bottom="-5%"}
Hard-bottom substrates
:::
::: {.absolute bottom="-2%" right="7%" .fragment .fade-out fragment-index="2" style="font-size: 30px;"}
*Vigo, Spain*
:::
<video src="Video/Intro/site_2_vigo_1bis.mp4" height="650" autoplay loop muted playsinline></video>

:::

::: {.absolute top="0%" right="10%" .fragment .fade-in-then-out fragment-index="2"}
![](Images/Intro/Figs_vegetations.png){height="1370"}
:::

::: {.fragment .fade-out fragment-index="7"}

::: {.absolute top="5%" left="48%" .fragment .fade-in fragment-index="3"}
::: {.absolute top="-5%" right="10%" style="font-size: 30px; color: black;"}
[*Hope et al. 2019*](https://doi.org/10.1111/1365-2745.13322)
:::

![](Images/Intro/MPB-Biofilm.jpg){height="500"}

:::

::: {style="position:absolute; top:10%; left:0%;" .fragment .fade-in fragment-index="4"}
![](Images/Intro/Carbon_seagrass.jpg){height="650"}
:::

::: {.absolute top="5%" right="16%" .fragment .fade-in fragment-index="5"}
![](Images/Intro/seagrass_hypo.png){height="500"}
:::

::: {.absolute top="5%" right="0%" .fragment .fade-in fragment-index="5"}
![](Images/Intro/seagrass_dugong.png){height="500"}
:::

::: {.absolute top="59%" left="22.7%" .fragment .fade-in fragment-index="5"}
![](Images/Intro/bernache_seagrass.png){height="462"}
:::

::: {.absolute top="43%" right="-2%" .fragment .fade-in fragment-index="6"}
::: {.absolute bottom="-3%" right="8%" style="font-size: 30px; color: black;"}
*Saja estuary, Spain*
:::
<video src="Video/Intro/Santander_green_and_red_algae.mp4" height="730" autoplay loop muted playsinline></video>
:::

::: {.absolute left="1%" top="60%" .fragment .fade-in fragment-index="3" style="font-size: 60px;"}
Ecosystem Services
:::

::: {.absolute left="2%" top="65%" .fragment .fade-in fragment-index="3"}
- Protection against Erosion
:::

::: {.absolute left="2%" top="70%" .fragment .fade-in fragment-index="4"}
- Carbon fixation
:::

::: {.absolute left="2%" top="75%" .fragment .fade-in fragment-index="5"}
- Nursery & Shelter
:::

::: {.absolute left="2%" top="80%" .fragment .fade-in fragment-index="6"}
- Eutrophication mitigation
:::
:::

::: {.absolute left="2%" top="15%" .fragment .fade-in fragment-index="7" style="font-size: 60px;"}
~ $30 trillion per year 
:::

::: {.absolute left="2%" top="25%" .fragment .fade-in fragment-index="7" style="font-size: 50px;"}
Protect these ecosystems:
:::

::: {.absolute left="5%" top="30%" .fragment .fade-in fragment-index="7" style="font-size: 50px;"}
  - Habitat Directive (1992)
  - Water framework Directive (2001)
  - Marine Strategy Framework Directive (2008)
  - Birds Directive (2009)
  - Nature Restoration Law (2024)
:::

::: {.absolute right="0%" bottom="0%" .fragment .fade-in fragment-index="7" style="font-size: 30px;"}
[Source: Koundouri et al., 2023](https://doi.org/10.3389/frevc.2023.1160118)
:::

::: {.absolute left="45%" top="10%" .fragment .fade-in fragment-index="7"}
![](Images/Intro/MSFD-logo.jpg){height="500"}
:::

::: {.absolute left="70%" top="0%" .fragment .fade-in fragment-index="7"}
![](Images/Intro/Natura2000.png){height="500"}
:::

::: {.absolute left="2%" bottom="20%" .fragment .fade-in fragment-index="7" style="font-size: 55px;"}
Good knowledge and monitoring to inform policies
:::

::: {.absolute right="0%" bottom="5%" .fragment .fade-in fragment-index="7"}
![](Images/Intro/NatureRestorationLax.png){height="500"}
:::





## Remote Sensing  {auto-animate=true transition="slide-in fade-out"}
::: {.absolute top="6.5%" .fragment .fade-out fragment-index="2"}
*A tool to map them all !*
:::


::: {.absolute top="-4%" right="-10%" }
<video src="Video/Intro/Oyster_reef_intertidal1.mp4" height="1450" autoplay loop muted playsinline></video>
:::

::: {.absolute top="-4%" right="-10%" .fragment .fade-in fragment-index="1"}
<video src="Video/Intro/Drone_Flight.mp4" height="1450" autoplay loop muted playsinline></video>
:::

::: {.absolute .fragment .fade-out fragment-index="2" left="2%" top="15%" style="font-size: 50px;"}
Traditional sampling methods: 
:::

::: {.absolute .fragment .fade-out fragment-index="2" left="5%" top="20%"}
  - Expensive
  - Time consuming
  - Low extent and temporal resolution
  - Hard to access
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" left="2%" top="45%" style="font-size: 50px;"}
Remote Sensing: 
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" left="5%" top="50%"}
  - Cost effective
  - Good coverage/Time ratio
  - Synchronous broad-scale view
  - Simplifies the field work
:::

::: {.absolute top="6.5%" .fragment .fade-in fragment-index="2"} 
*From the sky to the sea *
:::

::: {.absolute top="15%" .fragment .fade-in fragment-index="2"} 
The science of obtaining information about objects or areas from a distance
:::


::: {.absolute top="22%" left="0%" .fragment .fade-in fragment-index="2"}
![](Images/Intro/eyes.png){height="400" .circular-fade}
:::

::: {.absolute top="22%" left="17%" .fragment .fade-in fragment-index="2"}
![](Images/Intro/Bats.png){height="400" .circular-fade}
:::

::: {.absolute top="22%" left="34%" .fragment .fade-in fragment-index="2" style="z-index: 9999;"}
![](Images/Intro/james_webb.png){height="400" .circular-fade}
:::

::: {.absolute top="22%" left="51%" .fragment .fade-in fragment-index="2"}
![](Images/Intro/IRM.png){height="400" .circular-fade}
:::

::: {.absolute top="59%" .fragment .fade-in fragment-index="3"} 
Applied to Earth Observation: 
:::

::: {.absolute top="65%" left="0%" .fragment .fade-in fragment-index="3" data-id="box1" }
![](Images/Intro/Sentinel2_1.png){height="400" .circular-fade}
:::

::: {.absolute top="65%" left="17%" .fragment .fade-in fragment-index="3" data-id="box2" }
![](Images/Intro/Airbornn.png){height="400" .circular-fade}
:::

::: {.absolute top="65%" left="34%" .fragment .fade-in fragment-index="3" data-id="box3" }
![](Images/Intro/Drone_MPB1.png){height="400" .circular-fade}
:::

::: {.absolute top="65%" left="51%" .fragment .fade-in fragment-index="3" data-id="box4" }
![](Images/Intro/Bede_ASD.png){height="400" .circular-fade}
:::

## Remote Sensing  {auto-animate=true visibility="uncounted" transition="none"}

<!-- ::: {.fragment .fade-out fragment-index="2"} -->
<!-- ::: {.absolute top="6.5%"} -->
<!-- *From the sky to the sea * -->
<!-- ::: -->

<!-- ::: {.absolute left="2%" top="18%" style="font-size: 50px;"} -->

<!-- *Resolution Trade-offs* -->
<!-- ::: -->

<!-- ::: {.absolute top="25%" left="0%" data-id="box1" } -->
<!-- ![](Images/Intro/Sentinel2_1.png){height="550" .circular-fade} -->
<!-- ::: -->

<!-- ::: {.absolute top="25%" left="24%" data-id="box3" } -->
<!-- ![](Images/Intro/Drone_MPB1.png){height="550" .circular-fade} -->
<!-- ::: -->



<!-- ::: {.absolute top="10%" right="-0%"} -->
<!-- ![](Images/Intro/Satellite_resolution.png){height="1100"} -->
<!-- ::: -->

<!-- ::: {.absolute left="0%" top="70%" style="font-size: 40px;"}  -->
<!-- **Sentinel-2**  -->
<!-- ::: -->

<!-- ::: {.absolute left="25%" top="70%" style="font-size: 40px;"}  -->
<!-- **Drone** -->
<!-- ::: -->

<!-- ::: {.absolute left="1%" top="75%" style="font-size: 35px;"} -->

<!-- 10–60 m spatial resolution -->

<!-- 100 000 km²/image -->

<!-- 5-day revisit -->

<!-- ::: -->

<!-- ::: {.absolute left="26%" top="75%" style="font-size: 35px;"} -->

<!-- cm resolution -->

<!-- Adapted to small-scale studies -->

<!-- Flight planning flexibility -->
<!-- ::: -->
<!-- ::: -->

::: {.absolute top="6.5%"}
*Fieldwork remains essential to make sense of what satellites see*
:::


::: {.absolute top="-3.5%" right="-10%"}

<video src="Video/Intro/Fildwork_santander2.mp4" height="1450" autoplay loop muted playsinline></video>

:::

::: {.absolute top="15%" left="0%"}
::: {.absolute bottom="-5%" left="30%"}
Radiometric calibration
:::
::: {.absolute top="-5%" right="10%" style="font-size: 25px;"}
*Aven, France*
:::



![](Images/Intro/Bede_asd1.jpg){height="450" .circular-fade}
:::

::: {.absolute top="15%" left="40%"}
::: {.absolute bottom="-5%" left="25%"}
Ground truthing
:::
::: {.absolute top="-5%" right="10%" style="font-size: 25px;"}
*Noirmoutier, France*
:::



![](Images/Intro/Quadrats.jpg){height="450" .circular-fade}
:::

::: {.absolute top="60%" left="0%"}
::: {.absolute bottom="-5%" left="10%"}
Features georeferencing
:::

::: {.absolute top="-5%" right="10%" style="font-size: 25px;"}
*Tainaron, Greece*
:::



![](Images/Intro/Greece_RTK.jpg){height="450" .circular-fade}
:::

::: {.absolute top="60%" left="27%"}
::: {.absolute bottom="-5%" left="40%"}
Sampling
:::

::: {.absolute top="-5%" right="10%" style="font-size: 25px;"}
*Cadiz, Spain*
:::


![](Images/Intro/MPB_sampling.jpg){height="450" .circular-fade}
:::

<!-- ::: {.absolute top="6.5%" .fragment .fade-in fragment-index="3"} -->
<!-- *Monitoring coastal change from space* -->
<!-- ::: -->


<!-- ```{r animation paper per year} -->
<!-- #| cache: true -->
<!-- #| echo: false -->
<!-- #| warning: false -->
<!-- #| eval: false -->


<!-- library(gganimate) -->
<!-- library(tidyverse) -->
<!-- library(Polychrome)  # if not installed -->

<!-- my_colors <- createPalette(24, seedcolors = c("#CC6677", "#4477AA"),range = c(60, 120)) -->

<!-- df <- read.csv("Data/Intro/trend_paper_coastalRS.csv")%>% -->
<!--   rename(Count = `Document.Count`, Year = `Publication.Year`, Type = `Document.Type`)  -->

<!-- year_breaks <- seq(1970, max(df$Year), by = 10) -->

<!-- # Match color palette to document types -->
<!-- type_levels <- unique(df$Type) -->
<!-- n_types <- length(type_levels) -->
<!-- type_colors <- setNames(my_colors[1:n_types], type_levels) -->

<!-- p <- df %>%  -->
<!--   ggplot(aes(x = as.factor(Year), y = Count, fill = Type))+ -->
<!--   geom_col()+ -->
<!--   scale_fill_manual(values = type_colors) + -->
<!--   scale_x_discrete(breaks = as.character(year_breaks)) + -->
<!--   labs(x = "Year", y = "Number of Documents") + -->
<!--   theme_minimal(base_size = 40) +  # Base size for all text -->
<!--   theme( -->
<!--     axis.text.x = element_text(angle = 45, hjust = 1), -->
<!--     legend.position = c(0.2, 0.6)) + -->
<!--   transition_reveal(as.integer(Year)) -->

<!-- rendered <- animate(p, duration = 2, fps = 20, width = 1920, height = 1080, end_pause = 20, rewind = FALSE, renderer = gifski_renderer(loop = FALSE)) -->

<!-- anim_save("Images/Intro/document_trend.gif", animation = rendered) -->

<!-- ``` -->

<!-- ::: {.absolute top="12%" .fragment .fade-in fragment-index="3"} -->
<!-- Coastal Remote Sensing: A trendy topic ! -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="3" top="18%"} -->

<!-- ![](Images/Intro/document_trend.gif){height="650"} -->
<!-- ::: -->

<!-- ::: {.absolute top="5%" left="50%" .fragment .fade-in fragment-index="4"} -->
<!-- ![](Images/Intro/Pereira2013.png){height="300"} -->
<!-- ::: -->

<!-- ::: {.absolute top="70%" .fragment .fade-in fragment-index="4"} -->
<!--  - Standardized measurements or indicators to monitor biodiversity -->
<!-- ::: -->

<!-- ::: {.absolute top="80%" .fragment .fade-in fragment-index="5" style="font-size: 60px;"} -->
<!--  - Adapted for remote sensing applications -->
<!-- ::: -->

<!-- ::: {.absolute top="28%" right="0%" .fragment .fade-in fragment-index="5"} -->
<!-- ![](Images/Intro/MullerKarger.png){width="1300"} -->
<!-- ::: -->

<!-- ::: {.absolute top="55%" right="8%" .fragment .fade-in fragment-index="5"} -->
<!-- ![](Images/Intro/muller_slide4.png){width="900"} -->
<!-- ::: -->




## Objectives of this work {data-background-image="Images/Intro/background_obj.png"}

::: {style="text-align: center; position: absolute; left: 50%; top: 20%; width:2300px; transform: translate(-50%, -50%)"}
[Show how remote sensing can effectively map intertidal habitats and assess effects of pressures]{style="font-size: 80px"}
:::

::: {.fragment .fade-in fragment-index="1" style="text-align: center; position: absolute; left: 50%; top: 40%; width:2300px; transform: translate(-50%, -50%)"}
[Analysing the potential of multispectral sensors to distinguish macrophytes in soft-bottom intertidal zones at low tide]{style="font-size: 60px"}
:::

::: {.fragment .fade-in fragment-index="2" style="text-align: center; position: absolute; left: 50%; top: 60%; width:2300px; transform: translate(-50%, -50%)"}
[Building an algorithm that discriminates the most common taxonomic classes of vegetation found on soft bottom intertidal sediment]{style="font-size: 60px"}
:::

::: {.fragment .fade-in fragment-index="3" style="text-align: center; position: absolute; left: 50%; top: 80%; width:2300px; transform: translate(-50%, -50%)"}
[Investigate the capacity of remote sensing to monitor intertidal vegetation under abiotic and biotic pressures]{style="font-size: 60px"}
:::

## Table of Contents {.toc-page data-state="hide-menubar" background-image="Images/Background_TOC.png"}

:::{.absolute top="25%" style="font-size: 60px;"}
- [Challenges and Solutions](#developing-advanced-methodologies-for-intertidal-vegetation-monitoring)  
:::

:::{.absolute top="45%" style="font-size: 60px;"}
- [Case Study 1 – Facing Biological Invasions](#case-study-1-facing-biological-invasions)  
:::

:::{.absolute top="65%" width="1200px" style="font-size: 60px;"}
- [Case Study 2 – Mapping the impact of Heatwaves on intertidal seagrasses](#case-study-2-mapping-the-impact-of-heatwaves-on-intertidal-seagrasses)
:::

:::{.absolute top="85%" style="font-size: 60px;"}
- [General conclusions](#discussion-and-overview)  
:::


# Developing Advanced Methodologies for Intertidal Vegetation Monitoring {data-stack-name="Challenges and Solutions" background-image="Images/Part1/Background_First_slide.png" style="width: 1300px;"}

- [Challenges to map intertidal vegetation](#challenges-to-map-intertidal-vegetation)
- [Material & Methods](#material-methods)
- [Results](#results)
- [Discussion](#discussion)




## Challenges to map intertidal vegetation

::: {.absolute top="6.5%"}
*Introduction to Spectroradiometry*
:::

```{r Fig STDvsRAW}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(gganimate)
library(Utilities.Package)

##### Zost 

Zos <- read.table("Data/Part1/hyperspectral_zoster.txt", header=F)

names(Zos) <- c("Wavelength", paste0("Zos_",2:ncol(Zos)-1))



Zos <- Zos %>% 
  pivot_longer(-Wavelength, names_to = "SpectraID", values_to = "Ref")

id_ranking <- Zos %>%
  dplyr::filter(Wavelength == 665) %>%
  arrange(Ref) %>%
  mutate(ID = row_number()) %>%
  select(SpectraID, ID) 

Zos <- Zos %>% 
  left_join(id_ranking, by = "SpectraID") %>% 
  group_by(SpectraID) %>% 
  mutate(Ref_STD = (Ref-min(Ref))/(max(Ref)-min(Ref))) %>% 
  pivot_longer(-c(Wavelength, ID ,SpectraID), names_to = "Metric", values_to = "values")%>%
  ungroup() %>% 
  mutate(Biomass = max(ID) - ID + 1) 

plot_std <- Zos  %>% 
  ggplot(aes(x = Wavelength, y = values, color = Biomass, group = ID)  ) +
  geom_line()+
  scale_color_viridis_c(
    name = "Biomass",
    option = "D",
    breaks = c(min(Zos$Biomass), max(Zos$Biomass)),
    labels = c("Low", "High")
  )+
  ylab("Standardised Reflectance")+
  xlab("Wavelength")+
  transition_states(Metric,
                    transition_length = 2,
                    state_length = 1,
                    wrap = FALSE)+ 
  view_follow()+
  theme_Bede()+
  theme(legend.position = c(0.2,0.7),
        axis.title = element_text(face = "bold")
        )

rendered <- animate(plot_std, duration = 4, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 20, rewind = F, renderer = gifski_renderer(loop = F))

anim_save("Images/Part1/Fig_STD.gif", animation = rendered)

plot <- Zos  %>% 
  dplyr::filter(Metric == "Ref") %>% 
  ggplot() +
  geom_line(aes(x = Wavelength, y = values, color = Biomass, group = ID)  )+
  scale_color_viridis_c(
    name = "Biomass",
    option = "D",
    breaks = c(min(Zos$Biomass), max(Zos$Biomass)),
    labels = c("Low", "High")
  )+
  ylab("Refletance")+
  xlab("Wavelength")+
  theme_Bede()+
  theme(legend.position = c(0.2,0.8),
        axis.title = element_text(face = "bold")
        )

ggsave("Images/Part1/Fig_STD_static.png", plot,width = 8, height = 6, units = "in", dpi = 300)



```

```{r plots for spectral presentation}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(signal)
library(Utilities.Package)
library(gganimate)

rhodo <- "Data/Part1/BELON_STD.csv" %>%
    read.csv() %>% 
    dplyr::filter(Letter == "C") %>% 
    group_by(Wavelength) %>% 
    reframe(Rhodophyceae = mean(mean_STD))


# Apply Savitzky-Golay smoothing
# Choose polynomial order and window size
sgolay_order <- 2
sgolay_window <- 11  # Must be odd and >= order + 2

# Make sure window size is not larger than number of rows
sgolay_window <- min(sgolay_window, nrow(rhodo))
if (sgolay_window %% 2 == 0) sgolay_window <- sgolay_window - 1  # Ensure it's odd

rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)


ggplot(rhodo)+
  geom_line(aes(x = Wavelength, y = Rhodophyceae))

log_func <- function(x) {
  0.7 + 0.3 * log(x / 400) / log(900 / 400)
}

speclib <- "Data/Part1/spec_lib.csv" %>% 
    read.csv() %>% 
    select(-c(X,OSM,Bare.Sediment,Xanthophyceae)) %>% 
    left_join(rhodo, by = "Wavelength") %>%
    pivot_longer(-Wavelength, names_to = "Class",values_to = "Ref")  %>% 
    mutate(Class = case_when(Class == "Magnoliosida" ~ "C - Magnoliopsida",
                             Class == "Ulvophyceae" ~ "B - Chlorophyceae",
                             Class == "Rhodophyceae" ~ "E - Florideophyceae",
                             Class == "Bacillariophyceae" ~ "D - Bacillariophyceae",
                             Class == "Phaeophyceae" ~ "A - Phaeophyceae",
                             TRUE ~ Class)) %>% 
    group_by(Class) %>% 
    reframe(Wavelength = Wavelength,
            Ref = (Ref-min(Ref))/(max(Ref)-min(Ref))) %>% 
  mutate(Ref = case_when(Class == "B - Chlorophyceae" ~ log_func(Wavelength)*Ref,
                         T ~ Ref))
    
speclib$Class <- factor(speclib$Class, levels = c(
  "A - Phaeophyceae",
  "B - Chlorophyceae",
  "C - Magnoliopsida",
  "D - Bacillariophyceae",
  "E - Florideophyceae"
))

colscale <- c("D - Bacillariophyceae" = "#DAA520", 
              "B - Chlorophyceae" = "#b3ff1a", 
              "C - Magnoliopsida" = "#389318", 
              "A - Phaeophyceae" = "#873e23", 
              "E - Florideophyceae" = "#b3002d")



#### default plot

(init_plot <- speclib %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)

ggsave("Images/Part1/Figure_Hyperspectral.png", init_plot, width = 8, height = 6)

#### Zooming animation


# Step 1: create a variable for the animation state (frame)
# Let's assume `speclib` has a Wavelength range larger than 400-680
n_frames <- 20

# Séquence de zooms (xmax diminue vers 680)
xmax_seq <- seq(from = max(speclib$Wavelength), to = 665, length.out = n_frames)
xmin_seq <- seq(from = min(speclib$Wavelength), to = 450, length.out = n_frames)  # xmin reste constant

# Générer les données avec les limites x intégrées
animated_data <- lapply(1:n_frames, function(i) {
  speclib %>%
    mutate(frame = i,
           x_min = xmin_seq[i],
           x_max = xmax_seq[i])
}) %>% bind_rows()

p <- ggplot(animated_data) +
  geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5) +
  scale_color_manual(values = colscale) +
  theme_Bede() +
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,

    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  ) +
  transition_manual(frame, parameters = list(x_min = animated_data$x_min, x_max = animated_data$x_max)) +
  ease_aes('cubic-in-out')+
  coord_cartesian(xlim = c(400, 900))  # valeur initiale temporaire


frames <- unique(animated_data$frame)


list.files("Data/Part1/temp_frames/", full.names = T) %>% 
  file.remove()

# Create and save plots
for (f in seq_len(n_frames)) {
  x_max <- xmax_seq[f]
  x_min <- xmin_seq[f]
  df <- dplyr::filter(speclib, Wavelength >= x_min, Wavelength <= x_max)
  
  p <- ggplot(df) +
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5) +
    scale_color_manual(values = colscale) +
    theme_Bede() +
    ylab("Standardised Reflectance") +
    xlab("Wavelength (nm)") +
    coord_cartesian(xlim = c(x_min, x_max)) +
    # ggtitle(paste("Zoom jusqu’à", round(x_max), "nm")) +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 12),
      legend.text.align = 0,
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12)
    )
  
  ggsave(sprintf("Data/Part1/temp_frames/frame_%03d.png", f), p, width = 8, height = 6)
}

# Create animation from saved frames
imgs <- list.files("Data/Part1/temp_frames", full.names = TRUE, pattern = "*.png")
img_list <- magick::image_read(imgs)
animation <- magick::image_animate(magick::image_join(img_list), fps = 100,  loop = 1, optimize = T)

# Preview
# print(animation)

magick::image_write(animation, "Images/Part1/x_axis_zoom.gif", quality = 100)


#### Faded and animate

fade_class <- speclib %>% 
  dplyr::filter(!Class %in% c("Chlorophyceae", "Magnoliopsida"),
                Wavelength >= 450, 
                Wavelength <= 665 ) %>% 
  rename(Class1 = "Class")


faded <- speclib %>% 
  dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida"),
                Wavelength >= 450, 
                Wavelength <= 665) %>% 
  ggplot()+
    geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = 1L), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
    ylab("Standardised Reflectance")+
    xlab("Wavelength (nm)")+
    theme(legend.position = c(0.15, 0.8),
          legend.text = element_text(size = 12),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12))+
    coord_cartesian(xlim = c(450, 665)) +
    # ggtitle(paste("Zoom jusqu’à", round(x_max), "nm")) +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12)
    )+ 
  transition_states(Class,
                    transition_length = 2,
                    state_length = 1)

rendered <- animate(faded, duration = 2, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_Hyperspectral_Faded.gif", animation = rendered)


colscale_disc <- c("Chlorophyceae" = "#b3ff1a", 
              "Magnoliopsida" = "#389318")

faded_zoomed_out <- speclib %>% 
  dplyr::filter(Class %in% c("B - Chlorophyceae", "C - Magnoliopsida")) %>%
  mutate(Class = case_when(Class == "B - Chlorophyceae" ~ "Chlorophyceae", 
                           Class == "C - Magnoliopsida" ~ "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = 1L), linewidth = 1.5)+

    scale_color_manual(values=colscale_disc)+
    theme_Bede()+
    ylab("Standardised Reflectance")+
    xlab("Wavelength (nm)")+
    theme(legend.position = c(0.15, 0.8),
          legend.text = element_text(size = 12),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12))+
    coord_cartesian(xlim = c(450, 900)) +
    # ggtitle(paste("Zoom jusqu’à", round(x_max), "nm")) +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12)
    )+ 
  transition_states(Class,
                    transition_length = 2,
                    state_length = 1)

rendered_zoomed_out <- animate(faded_zoomed_out, duration = 2, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_Hyperspectral_Faded_zoomed_out.gif", animation = rendered_zoomed_out)

# ggsave("Images/Part1/Figure_Hyperspectral_Faded.png", faded, width = 8, height = 6)
```

::: {.fragment .fade-out fragment-index="3"}
::: {.absolute bottom="0%" left="4%" .fragment .fade-in fragment-index="1"}
![](Images/Part1/SPC_gradient.png){height="233"}
:::
:::

::: {.absolute top="10%" right="0%" .fragment .fade-out fragment-index="1"}
![](Images/Part1/FigLightPath.png){height="900"}
:::

::: {.absolute top="10%" right="0%" .fragment .fade-in-then-out fragment-index="1"}
![](Images/Part1/FigLightPath2.png){height="900"}
:::

:::{.absolute bottom="5%" right="33%" .fragment .fade-in-then-out fragment-index="1"}

$$R(\lambda) = \frac{L_{\text{u}}(\lambda)}{L_{\text{d}}(\lambda)}$$

:::

:::{.absolute bottom="2%" right="0%" .fragment .fade-in-then-out fragment-index="1"}
- $\lambda$ is the Wavelength
- $L_{\text{u}}$ is the upwelling radiance
- $L_{\text{d}}$ is the downwelling radiance
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="1"}
![](Images/Part1/Fig_STD_static.png){height="900"}
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="2"}
![](Images/Part1/Fig_STD.gif){height="900"}
:::

:::{.absolute top="30%" left="60%" .fragment .fade-in-then-out fragment-index="2"}

$$R_i^*(\lambda) = \frac{R_i(\lambda) - \min(R_i)}{\max(R_i) - \min(R_i)}$$

:::

:::{.absolute top="55%" left="52%" .fragment .fade-in-then-out fragment-index="2"}
- $R_i(\lambda)$ is the reflectance the the wavelength $\lambda$ of the spectrum $R_i$ 
- $min(R_i)$ and $max(R_i)$ are the minimum and maximum reflectance of the spectrum $R_i$
:::

:::{.absolute top="80%" left="52%" .fragment .fade-in-then-out fragment-index="2"}
- Each spectrum is between 0 and 1
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="3"}
![](Images/Part1/Figure_Hyperspectral.png){height="1000"}
:::
::: {.fragment .fade-out fragment-index="5"}
::: {.absolute top="10%" right="0%" .fragment .fade-in fragment-index="3"}
![](Images/Part1/Figs_vegetations_2.png){width="1100"}
:::

::: {.absolute bottom="0%" right="0%" .fragment .fade-in fragment-index="3"}
![](Images/Part1/Figure13.png){width="1100"}
:::
:::

::: {.absolute bottom="0%" right="0%" .fragment .fade-in-then-out fragment-index="5"}
![](Images/Part1/Figure13_Florideo.png){width="1100"}
:::

::: {.absolute top="10%" right="0%" .fragment .fade-in-then-out fragment-index="5"}
![](Images/Part1/Figs_vegetations_2_Florideo.png){width="1100"}
:::

::: {.absolute top="10%" right="0%" .fragment .fade-in-then-out fragment-index="6"}
![](Images/Part1/Figs_vegetations_2_Bacillario.png){width="1100"}
:::

::: {.fragment .fade-out fragment-index="8"}

::: {.absolute top="10%" right="0%" .fragment .fade-in-then-out fragment-index="7"}
![](Images/Part1/Figs_vegetations_2_Green.png){width="1100"}
:::
:::

::: {.absolute bottom="0%" right="0%" .fragment .fade-in-then-out fragment-index="6"}
![](Images/Part1/Figure13_Bacillario.png){width="1100"}
:::

::: {.fragment .fade-out fragment-index="8"}

::: {.absolute bottom="0%" right="0%" .fragment .fade-in-then-out fragment-index="7"}
![](Images/Part1/Figure13_Green.png){width="1100"}
:::
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="4"}
![](Images/Part1/x_axis_zoom.gif){height="1000"}
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="5"}
![](Images/Part1/x_axis_zoom_Florideo.png){height="1000"}
:::

::: {.absolute top="10%" left="0%" .fragment .fade-in-then-out fragment-index="6"}
![](Images/Part1/x_axis_zoom_Bacillario.png){height="1000"}
:::

::: {.fragment .fade-out fragment-index="8"}
::: {.absolute top="10%" left="0%" .fragment .fade-in fragment-index="7"}
![](Images/Part1/Figure_Hyperspectral_Faded.gif){height="1000"}
:::
:::


```{r Spectra resampling}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(signal)
library(Utilities.Package)
library(gganimate)

rhodo <- "Data/Part1/BELON_STD.csv" %>%
    read.csv() %>% 
    dplyr::filter(Letter == "C") %>% 
    group_by(Wavelength) %>% 
    reframe(Rhodophyceae = mean(mean_STD))


# Apply Savitzky-Golay smoothing
# Choose polynomial order and window size
sgolay_order <- 2
sgolay_window <- 11  # Must be odd and >= order + 2

# Make sure window size is not larger than number of rows
sgolay_window <- min(sgolay_window, nrow(rhodo))
if (sgolay_window %% 2 == 0) sgolay_window <- sgolay_window - 1  # Ensure it's odd

rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)


ggplot(rhodo)+
  geom_line(aes(x = Wavelength, y = Rhodophyceae))

log_func <- function(x) {
  0.7 + 0.3 * log(x / 400) / log(900 / 400)
}

speclib <- "Data/Part1/spec_lib.csv" %>% 
    read.csv() %>% 
    select(-c(X,OSM,Bare.Sediment,Xanthophyceae)) %>% 
    left_join(rhodo, by = "Wavelength") %>%
    pivot_longer(-Wavelength, names_to = "Class",values_to = "Ref")  %>% 
    mutate(Class = case_when(Class == "Magnoliosida" ~ "C - Magnoliopsida",
                             Class == "Ulvophyceae" ~ "B - Chlorophyceae",
                             Class == "Rhodophyceae" ~ "E - Florideophyceae",
                             Class == "Bacillariophyceae" ~ "D - Bacillariophyceae",
                             Class == "Phaeophyceae" ~ "A - Phaeophyceae",
                             TRUE ~ Class)) %>% 
    group_by(Class) %>% 
    reframe(Wavelength = Wavelength,
            Ref = (Ref-min(Ref))/(max(Ref)-min(Ref))) %>% 
  mutate(Ref = case_when(Class == "B - Chlorophyceae" ~ log_func(Wavelength)*Ref,
                         T ~ Ref))
    
speclib$Class <- factor(speclib$Class, levels = c(
  "A - Phaeophyceae",
  "B - Chlorophyceae",
  "C - Magnoliopsida",
  "D - Bacillariophyceae",
  "E - Florideophyceae"
))

colscale <- c("D - Bacillariophyceae" = "#DAA520", 
              "B - Chlorophyceae" = "#b3ff1a", 
              "C - Magnoliopsida" = "#389318", 
              "A - Phaeophyceae" = "#873e23", 
              "E - Florideophyceae" = "#b3002d")



#### default plot

(init_plot <- speclib %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)")  +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)


####### PRISMA 
RSF_Prisma <-readxl::read_excel("Data/Part1/prisma_SRF.xlsx") %>% 
  as_tibble() %>% 
  pivot_longer(-Wavelength, names_to = "Bands", values_to = "SRF") %>% 
  mutate(SRF = as.numeric(SRF))

Prisma_Band_Max <- RSF_Prisma %>% 
  group_by(Bands) %>% 
  dplyr::filter(SRF == max(SRF))

for (i in unique(RSF_Prisma$Bands)) {
  
  band_i <- RSF_Prisma %>% 
    dplyr::filter(Bands == i) %>% 
    dplyr::select(-Bands)
  
  Joined_lib_SRF <- speclib %>% 
    left_join(band_i, by = "Wavelength")
  
  Ref_Prisma_band_i <- Joined_lib_SRF %>% 
    group_by(Class) %>% 
    reframe(Ref = weighted.mean(Ref,SRF)) %>% 
    mutate(Wavelength = Prisma_Band_Max %>% dplyr::filter(Bands == i) %>% pull(Wavelength))
  
  if(i == "Band 1"){
    Ref_Prisma = Ref_Prisma_band_i
  }else{
    Ref_Prisma = rbind(Ref_Prisma,Ref_Prisma_band_i)
  }
}

Ref_Prisma <- Ref_Prisma %>% 
  dplyr::filter(Wavelength > 400, 
                Wavelength < 900) %>% 
  group_by(Class) %>% 
  mutate(Ref = (Ref-min(Ref))/(max(Ref)-min(Ref)),
         Sensor = "Prisma")



(init_plot_PRISMA <- Ref_Prisma %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)


### Sentinel-2

RSF_S2 <-readxl::read_excel("Data/Part1/S2_SRF.xlsx") %>% 
  as_tibble() %>% 
  pivot_longer(-Wavelength, names_to = "Bands", values_to = "SRF") %>% 
  mutate(SRF = as.numeric(SRF),
         Bands = gsub(".*_","",Bands))

S2_Band_Max <- data.frame(Bands = unique(RSF_S2$Bands),
                          Wavelength = c(443,490,560,665,705,740,783,742,865,945,1375,1610,2190))

for (i in unique(RSF_S2$Bands)) {
  
  band_i <- RSF_S2 %>% 
    dplyr::filter(Bands == i) %>% 
    dplyr::select(-Bands)
  
  Joined_lib_SRF <- speclib %>% 
    left_join(band_i, by = "Wavelength")
  
  Ref_S2_band_i <- Joined_lib_SRF %>% 
    group_by(Class) %>% 
    reframe(Ref = weighted.mean(Ref,SRF)) %>% 
    mutate(Wavelength = S2_Band_Max %>% dplyr::filter(Bands == i) %>% pull(Wavelength))
  
  if(i == "B1"){
    Ref_S2 = Ref_S2_band_i
  }else{
    Ref_S2 = rbind(Ref_S2,Ref_S2_band_i)
  }
}

Ref_S2 <- Ref_S2 %>% 
  dplyr::filter(Wavelength > 400, 
                Wavelength < 900) %>% 
  group_by(Class) %>% 
  mutate(Ref = (Ref-min(Ref))/(max(Ref)-min(Ref)),
         Sensor = "Sentinel-2")%>% 
   dplyr::filter(Wavelength != 742)
  

unique(Ref_S2$Wavelength)

(init_plot_S2 <- Ref_S2  %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)


########### Pleiades

 df <-read.table("Data/Part1/pleiades_a_SRF.txt")
 
 names(df)<- c("Wavelength", paste0("B", 1:4))
 
 RSF_Pleiades<- df %>% 
  as_tibble() %>% 
   mutate(Wavelength = Wavelength *1000)
 
 new_wavelengths <- seq(min(RSF_Pleiades$Wavelength), max(RSF_Pleiades$Wavelength), by = 1)

 
 interpolated_df <- tibble(Wavelength = new_wavelengths)

 for (i in 2:ncol(RSF_Pleiades)) {
  col_name <- paste0("B", i-1)
  interpolated_df[[col_name]] <- approx(RSF_Pleiades$Wavelength, RSF_Pleiades[[col_name]], xout = new_wavelengths, rule = 2)$y
}
 
 
 RSF_Pleiades <- interpolated_df %>% 
  pivot_longer(-Wavelength, names_to = "Bands", values_to = "SRF") %>% 
  mutate(SRF = as.numeric(SRF),
         Bands = gsub(".*_","",Bands), 
         Wavelength = as.numeric(Wavelength))

Pleiades_Band_Max <- data.frame(Bands = unique(RSF_Pleiades$Bands),
                          Wavelength = c(mean(c(550,430)), mean(c(610,490)),mean(c(720,600)), mean(c(950,750))))

for (i in unique(RSF_Pleiades$Bands)) {
  
  band_i <- RSF_Pleiades %>% 
    dplyr::filter(Bands == i) %>% 
    dplyr::select(-Bands)
  
  Joined_lib_SRF <- speclib %>% 
    left_join(band_i, by = "Wavelength") %>% 
    mutate(SRF = case_when(is.na(SRF) ~ 0,
                           T ~SRF ))
  
  Ref_Pleiades_band_i <- Joined_lib_SRF %>% 
    group_by(Class) %>% 
    reframe(Ref = weighted.mean(Ref,SRF)) %>% 
    mutate(Wavelength = Pleiades_Band_Max %>% dplyr::filter(Bands == i) %>% pull(Wavelength))
  
  if(i == "B1"){
    Ref_Pleiades = Ref_Pleiades_band_i
  }else{
    Ref_Pleiades = rbind(Ref_Pleiades,Ref_Pleiades_band_i)
  }
}

Ref_Pleiades <- Ref_Pleiades %>% 
  dplyr::filter(Wavelength > 400, 
                Wavelength < 900) %>% 
  group_by(Class) %>% 
  mutate(Ref = (Ref-min(Ref))/(max(Ref)-min(Ref)),
         Sensor = "Pleiades")
  



(init_plot_Pleiades <- Ref_Pleiades %>% 
   # dplyr::filter(Wavelength != 742) %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)

##### ALL

speclib_Resampled <-  speclib %>% 
  mutate(Sensor = "ASD") %>% 
  rbind(Ref_Prisma, Ref_S2, Ref_Pleiades) %>% 
  mutate(y = case_when(Sensor == "ASD" ~ 0,
                       Sensor == "Prisma" ~ 0.05,
                       Sensor == "Sentinel-2" ~ 0.1,
                       Sensor == "Pleiades" ~ 0.15))


unique(speclib_Resampled$Sensor)

speclib_Resampled$Sensor <- factor(speclib_Resampled$Sensor, levels = c(
  "ASD",
  "Prisma",
  "Sentinel-2",
  "Pleiades"
))


Plot_animated_resampled <- speclib_Resampled %>% 
  mutate(Sensor_fading = Sensor) %>% 
  ggplot(aes(x = Wavelength, y = Ref, color = Class, group = Class)) +

    # Smooth transitioning spectra
    geom_line(
      linewidth = 1.5
    ) +

    # Text that only fades in/out
    geom_text(
      aes(x = 800, y = 0.05, label = Sensor, group = Sensor_fading),
      size = 10,
      inherit.aes = FALSE
    ) +

    # Small ticks at each Wavelength (bottom side only)
    geom_rug(
      aes(x = Wavelength, group = Sensor),
      sides = "b",           # bottom only
      color = "red",
      length = unit(6, "pt"),
      linewidth = 1 # short tick
    ) +

    # Color scale and labels
    scale_color_manual(values = colscale) +
    ylab("Standardised Reflectance") +
    xlab("Wavelength (nm)") +
    xlim(c(400, 900)) +

    # Animate sensor changes globally
    transition_states(Sensor,
                      transition_length = 5,
                      state_length = 30) +
    ease_aes("sine-in-out") +

    # Theme and styling
    theme_Bede() +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 12),
      legend.text.align = 0,
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12)
    )

rendered <- animate(Plot_animated_resampled, duration = 5, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_SRF_all.gif", animation = rendered)



#### ZOOMED


Plot_animated_resampled_zoomed <- speclib_Resampled %>% 
  mutate(Sensor_fading = Sensor) %>% 
  dplyr::filter(Wavelength < 670) %>% 
  ggplot(aes(x = Wavelength, y = Ref, color = Class, group = Class)) +

    # Smooth transitioning spectra
    geom_line(
      linewidth = 1.5
    ) +

    # Text that only fades in/out
    geom_text(
      aes(x = 600, y = 0.9, label = Sensor, group = Sensor_fading),
      size = 10,
      inherit.aes = FALSE
    ) +

    # Small ticks at each Wavelength (bottom side only)
    geom_rug(
      aes(x = Wavelength, group = Sensor),
      sides = "b",           # bottom only
      color = "red",
      length = unit(6, "pt"),
      linewidth = 1 # short tick
    ) +

    # Color scale and labels
    scale_color_manual(values = colscale) +
    ylab("Standardised Reflectance") +
    xlab("Wavelength (nm)") +
    xlim(c(400, 670)) +

    # Animate sensor changes globally
    transition_states(Sensor,
                      transition_length = 5,
                      state_length = 30) +
    ease_aes("sine-in-out") +

    # Theme and styling
    theme_Bede() +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 12),
      legend.text.align = 0,
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12)
    )

rendered_zoomed <- animate(Plot_animated_resampled_zoomed, duration = 5, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_SRF_all_zoomed.gif", animation = rendered_zoomed)

```

::: {.absolute top="15%" left="0%" .fragment .fade-in-then-out fragment-index="8"}
![](Images/Part1/Figure_SRF_all_ASD.png){height="1000"}
:::

::: {.absolute top="15%" right="15%" .fragment .fade-in-then-out fragment-index="8"}
![](Images/Part1/ASD_show.jpeg){height="1000"}
:::

:::{.absolute top="15%" right="3%" .fragment .fade-in-then-out fragment-index="8" style="width: 300px; text-align: left;  font-size: 60px;"}
ASD FieldSpec Handheld 2
:::

:::{.absolute top="45%" right="3%" .fragment .fade-in-then-out fragment-index="8" style="width: 300px; text-align: left;  font-size: 60px;"}
Hyperspectral Sensor
:::

:::{.absolute bottom="8%" right="3%" .fragment .fade-in-then-out fragment-index="8" style="width: 300px; text-align: left;  font-size: 60px;"}
A lot of Narrow Spectral Bands
:::

::: {.absolute top="15%" left="0%" .fragment .fade-in fragment-index="9"}
![](Images/Part1/Figure_SRF_all.gif){height="1000"}
:::

<!-- ::: {.absolute top="15%" left="0%" .fragment .fade-in fragment-index="10"} -->
<!-- ![](Images/Part1/Figure_SRF_all_zoomed.gif){height="1000"} -->
<!-- ::: -->

::: {.fragment .fade-out fragment-index="11"}
::: {.absolute top="15%" right="0%" .fragment .fade-in fragment-index="9"}
![](Images/Part1/Fig_SpectralResolution.png){height="1000"}
:::
:::

:::{.absolute bottom="15%" left="55%" .fragment .fade-in fragment-index="11" style="width: 1200px; text-align: left;  font-size: 80px;"}
- Is it possible to discriminate **green macrophytes** using remote sensing techniques ? 

:::

:::{.absolute top="20%" left="55%" .fragment .fade-in fragment-index="11" style="width: 1200px; text-align: left;  font-size: 80px;"}
- What is the impact of the **spectral resolution** on the discrimination accuracy ?
:::

## Material & Methods


```{r Map Spectral library}
#| echo: false
#| eval: false
#| warning: false

library(sf)
library(tidyverse)
library(Utilities.Package)


land_mask <- read_sf("Data/Part1/Maks_land_SPain_Portugal_France.shp")

Sampling_points <- tibble(
  Country = c("France", "France","France","France", "France","France", "Portugal", "Portugal", "Spain", "Spain"),
  Site = c("Mont Saint Michel Bay","Auray Estuary", "Morbihan Gulf","Traict of Merquel", "Bourgneuf Bay", "Marennes-Oléron Bay", "Aveiro Coastal Lagoon","Tagus Estuary", "Cadiz Bay", "Baiona Beach"),
  x = c( -1.616884,-2.956158,  -2.811063, -2.464984, -2.108862, -1.147721, -8.693682, -9.059694, -6.223569, -5.773462),
  y = c(48.661632,47.627424,47.580383, 47.418887,47.008546,45.926925,40.679758,38.756048,36.492337, 36.087565)) 

# plot(Sampling_points)
# 
# ggplot()+
#   geom_sf(data = land_mask)+
#   geom_sf(data = Sampling_points)

my_sf_simple <- rmapshaper::ms_simplify(land_mask, keep = 0.05)  # Simplify to 5% of points


bbox <- st_bbox(c(xmin = -15, xmax = 0, ymin = 35, ymax = 50), crs = st_crs(land_mask)) %>% 
  st_as_sfc()

# Crop using st_intersection
land_mask <- st_intersection(land_mask, bbox)


(
Sampling_plot <-
ggplot() +
  geom_sf(data = my_sf_simple, linewidth = 0.05, alpha = 0.93, fill = "grey80") +
      coord_sf(xlim=c(-15,0) ,
                ylim=c(35,50),
               expand = F ) +
  ggforce::geom_mark_ellipse(data=Sampling_points,
                 aes(x=x,
                     y=y,
                     label = Country,
                     group = Site,
                     description=Site),
                     # x0 = -22),
                 size=0.2,
                 # position = "jitter",
                 fill = "goldenrod",
                 con.colour = "goldenrod4",
                 show.legend=F,
                 label.fontsize = 15,
                 label.hjust = 0.5,
                 con.size = 0.5,
                 alpha=0.8,
  expand = unit(2, "mm") ,
  radius = unit(2, "mm") ,
  label.fill = "grey90",
  label.buffer = unit(5, "mm")) +
    theme_void()+
  # theme_Bede_Map()+
  # labs(x="Longitude",
       # y="Latitude")+
  # geom_label(aes(x = 521000, y = 4507794, label = "C"), size = 20)+
  # scale_x_continuous(breaks = seq(-8.70, -8.60, by = 0.10))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank()
        # axis.text.x = element_text(size = 20),
        # axis.text.y = element_text(size = 20)
        )
)

ggsave(filename = "Images/Part1/map_sampling.svg", 
       plot = Sampling_plot, 
       width = 7.03,
       height = 10, 
       units = "in")

```

::: {.fragment .fade-out fragment-index="2"}
::: {.absolute bottom="-8%" right="-8%"}
![](Images/Part1/Map_Sampling2.png){height="1400"}
:::


::: {.absolute top="15%" left="40%"}
![](Images/Part1/ASD1.png){height="435"}
:::

::: {.absolute top="15%" left="58.5%"}
![](Images/Part1/ASD2.png){height="435"}
:::

::: {.absolute top="50%" left="40%"}
![](Images/Part1/Figure1_Bede.jpg){height="578"}
:::
:::


::: {.fragment .fade-out fragment-index="2"}

::: {.absolute top="6.5%"}
*Building a Spectral library of intertidal vegetation*
:::


::: {.absolute top="10%" left="0%"}
![](Images/Part1/SPECIESTABLE.png){height="1100"}
:::

:::{.absolute bottom="0%" left="0%" style="width: 1200px; text-align: left;  font-size: 60px;"}
Total of 332 Spectra of 5 taxonomic classes
:::
:::


<!-- ::: {.absolute top="10%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 60px;"} -->
<!-- 2 instruments  -->
<!-- ::: -->

<!-- ::: {.absolute top="15%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 40px;"} -->
<!-- - GER 3700 and ASD Fieldspec handheld 2 -->
<!-- ::: -->

<!-- ::: {.absolute top="25%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 60px;"} -->
<!-- Calibration -->
<!-- ::: -->

<!-- ::: {.absolute top="30%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 40px;"} -->
<!-- - Optimisation of the integration time -->
<!-- - Dark noise calibration -->
<!-- - Measurement of Radiance with a 99% Spectralon white reference -->
<!-- ::: -->

<!-- ::: {.absolute top="50%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 60px;"} -->
<!-- Sampling method -->
<!-- ::: -->

<!-- ::: {.absolute top="55%" left="40%".fragment .fade-in-then-out fragment-index="1" style="font-size: 40px;"} -->
<!-- - Operator angled at 90° to the sun -->
<!-- - At least 10 replicate for each sample -->
<!-- - 30 to 50cm from the ground -->
<!-- - Field of view of the instrument set to ~ 3.5° -->
<!-- ::: -->

<!-- ::: {.absolute top="80%" left="50%" .fragment .fade-in-then-out fragment-index="1" style="font-size: 50px;"} -->

<!-- $R(\lambda)_{\rm sample} = \frac{1}{n}\sum_{i=1}^{n}R_i(\lambda), \quad\text{with }n \ge 10$ -->

<!-- ::: -->


::: {.fragment .fade-out fragment-index="4"}
::: {.absolute .fragment .fade-in fragment-index="2" top="6.5%"}
*Spectral degradation*
:::
:::
```{r SRF all}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(Utilities.Package)
library(gganimate)


VEG_s<-read_csv("Data/SRF/ASD_forPaper.csv")

ASD_func<-VEG_s %>% 
  dplyr::rename(band=Wavelength) %>% 
  dplyr::mutate(Largeur=1) %>% 
  expand_grid(Wavelength=seq(from=round(min(.$band) ),
                             to=round(max(.$band) )) ) %>% 
  dplyr::mutate(sigma=Largeur/(2*sqrt(2*SciViews::ln(2) )) ,
                val=exp(-(((Wavelength-band)^2)/(2*sigma^2) )) ,
                band=as.character(band) ) %>% 
  dplyr::select(-c(Largeur,sigma) )%>% 
  dplyr::mutate(Data="ASD")

Pleiades_func<-read.table("Data/SRF/band_function_Pleiades.txt",
                          header = T) %>% 
  dplyr::mutate(Wavelength=as.integer(Wavelength*1000) ) %>% 
  dplyr::select(-P_1_PAN) %>% 
  pivot_longer(2:ncol(.) ,names_to = "band",values_to = "val") %>% 
  dplyr::mutate(Data="Pleiades") 

S2_10_func<-read.table("Data/SRF/band_function_S2A.txt",
                          header = T)%>% 
  dplyr::select(Wavelength, S2A_2, S2A_3, S2A_4,S2A_8)%>% 
  pivot_longer(2:ncol(.) ,names_to = "band",values_to = "val") %>% 
  dplyr::mutate(Data="Sentinel-2 10m")

S2_1020_func<-read.table("Data/SRF/band_function_S2A.txt",
                          header = T)%>% 
  dplyr::select(Wavelength,  S2A_2, S2A_3, S2A_4, S2A_5, S2A_6, S2A_7, S2A_8, S2A_8A)%>% 
  pivot_longer(2:ncol(.) ,names_to = "band",values_to = "val") %>% 
  dplyr::mutate(Data="Sentinel-2 20m")

Drone_func<-read_csv("Data/SRF/band_function_Drone.csv")%>% 
  pivot_longer(2:ncol(.) ,names_to = "band",values_to = "val") %>% 
  dplyr::mutate(Data="Drone")


PRISMA_func<-read_csv("Data/SRF/band_function_PRISMA.csv") %>% 
  dplyr::rename(band=Wavelength) %>% 
  expand_grid(Wavelength=seq(from=round(min(.$band) ),
                             to=round(max(.$band) )) ) %>% 
  dplyr::mutate(sigma=Largeur/(2*sqrt(2*SciViews::ln(2) )) ,
                val=exp(-(((Wavelength-band)^2)/(2*sigma^2) )) ,
                band=as.character(band) ) %>% 
  dplyr::select(-c(Largeur,sigma) )%>% 
  dplyr::mutate(Data="PRISMA")

functions<-bind_rows(ASD_func,Pleiades_func,S2_10_func,
                     S2_1020_func,Drone_func,PRISMA_func) %>% 
  dplyr::select(band,Wavelength,Data,val)%>% 
  dplyr::filter(Wavelength<901 & Wavelength>400) %>% 
  dplyr::mutate(Data=as.factor(Data) ,
                Data=fct_relevel(Data, c("ASD",
                                         "PRISMA",
                                         "Drone",
                                         "Sentinel-2 20m",
                                         "Pleiades",
                                         "Sentinel-2 10m") ))

plot_SRF <- ggplot(functions, aes(x = Wavelength, y = val, group = band)) +
  geom_line(alpha = 0.6, colour = "darkcyan", linewidth = 1) +
  labs(
    title = "{closest_state}",         # <-- dynamic title
    x     = "Wavelength (nm)",
    y     = NULL
  ) +
  scale_x_continuous(limits = c(400, 900)) +
  theme_Bede() +
  theme(
    plot.title  = element_text(size = 18, face = "bold", hjust = 0.05),
    plot.margin = unit(c(1.25, 1.25, 1.25, 1.25), "cm")
  ) +
  transition_states(
    Data,
    transition_length = 5,
    state_length      = 30
  ) +
  ease_aes("sine-in-out")

# coucouo <- "coucou"
# 
# functions %>%
#   dplyr::filter(Data == "Drone") %>% 
#   ggplot(aes(x=Wavelength,
#                   y=val) )+
#   geom_line(aes(group=band) ,
#             alpha=0.6,
#             colour="darkcyan",
#             linewidth=1) +
#   labs(y=" ",
#        x="Wavelength (nm)") +
#   # ggtitle(unique(Data))+
#   scale_x_continuous(limits =c(400,900) )+
#   # facet_wrap(~Data,ncol=2, scales = "free_x") +
#   theme_Bede()+
#     theme(plot.margin = unit(c(1.25,1.25,1.25,1.25), "cm"),
#           strip.text = element_text(size=14),
#           legend.title = element_text(size=12),
#           legend.text = element_text(size=14))


rendered_zoomed <- animate(plot_SRF, duration = 10, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_SRF_all_sensors.gif", animation = rendered_zoomed)
```


::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="10%" left="0%"}
![](Images/Part1/Figure_SRF_all_sensors.gif){height="800"}
:::


::: {.fragment .fade-out fragment-index="4"}
::: {.absolute .fragment .fade-in fragment-index="2" bottom="2%" left="0%"}
![](Images/Part1/ASD.png){height="100"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" left="18%"}
![](Images/Part1/PRISMA.png){height="150"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" left="36%"}
![](Images/Part1/Micasense.png){height="150"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" right="36%"}
![](Images/Part1/Sentinel-2_20m.png){height="150"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" right="18%"}
![](Images/Part1/pleiades.png){height="150"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" right="0%"}
![](Images/Part1/Sentinel-2.jpg){height="150"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" left="3%"}
**ASD**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" left="18%"}
**PRISMA**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" left="38%"}
**Drone**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" right="38%"}
**S2 - 20m**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" right="18%"}
**Pléiades**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="20%" right="1%"}
**S2 - 10m**
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" left="0%"}
250 bands
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" left="17.5%"}
50 Bands
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" left="37%"}
10 Bands
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" right="38%"}
8 Bands
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" right="18%"}
4 Bands
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="15%" right="1%"}
4 Bands
:::


```{r Spectra resampled}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(Utilities.Package)
library(gganimate)

DataCombo <- read.csv("Data/Part1/DataCombo.csv")%>% 
  dplyr::filter(Data %in% c("ASD","Drone","Sentinel-2 10m")) 

DataCombo$Data <- factor(DataCombo$Data, levels = c(
  "ASD","Drone","Sentinel-2 10m"
  # "PRISMA",
  
  # # "Sentinel-2 20m",
  # # "Pleiades",
  
)) 

### Just chloro and Magno
colscale <- c("Magnoliopsida" = "#598f35", "Ulvophyceae" = "#c4fb58")

plot_SRF_sp <- DataCombo %>% 
  as_tibble() %>% 
  dplyr::filter(
    Species_Group %in% c("Magnoliopsida","Ulvophyceae","Phaeophyceae","Bacillariophyceae"),
                Data == "Drone") %>%
  ggplot(aes(x=Wavelength,
                  y=Mean_Reflec) ) +
  geom_ribbon(aes(ymin=lwr_Reflec,
                  ymax=upr_Reflec,
                  fill=Species_Group) ,
              alpha=0.4)+ 
  geom_line(aes(colour=Species_Group) ,
            linewidth=0.9) +
  labs(
    # title = "{closest_state}",         # <-- dynamic title
    x     = "Wavelength (nm)",
    y     = "Reflectance "
  ) +
  scale_x_continuous(limits =c(400,900) )+
  facet_wrap(~Data,ncol=2, scales = "free_x") +
  # scale_fill_manual(name="Class",values = colscale, labels = c("Magnoliopsida","Chlorophyceae")) +
  # scale_colour_manual(name="Class",values = colscale, labels = c("Magnoliopsida","Chlorophyceae")) +
  scale_fill_Bede(name="Class","Macro5_Pub") +
  scale_colour_Bede(name="Class","Macro5_Pub") +
  theme_Bede()+
    theme(plot.margin = unit(c(1.25,1.25,1.25,1.25), "cm"),
          strip.text = element_text(size=14),
          legend.title = element_text(size=14),
          legend.text = element_text(size=14),
          legend.direction = "vertical",
          legend.position = "top",
          legend.justification = "center")+
  guides(fill=guide_legend(ncol=3),
         colour=guide_legend(ncol=3))
  # transition_states(
  #   Data,
  #   transition_length = 5,
  #   state_length      = 30
  # ) +
  # ease_aes("sine-in-out")

rendered <- animate(plot_SRF_sp, duration = 10, fps = 20, width = 8, height = 6, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part1/Figure_resampled_spectra.gif", animation = rendered)


  ggsave(filename = "Images/Part1/Figure_spectra3_green.pdf", 
       plot = plot_SRF_sp, 
       width = 10,
       height = 10, 
       units = "in")
```

:::





::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="0%" right="0%"}
![](Images/Part1/Figure_resampled_spectra.gif){height="1000"}
:::

::: {.fragment .fade-out fragment-index="7"}
::: {.absolute .fragment .fade-in fragment-index="4" top="6.5%"}
*Spectral comparisons*
:::

:::{.absolute top="15%" left="0%" .fragment .fade-in fragment-index="4" style="text-align: left;  font-size: 60px;"}
**Compare the Spectra:** 

- nMDS + ANOSIM for each spectral resolution
:::

::: {.absolute .fragment .fade-in fragment-index="4" top="5%" left="60%"}
![](Images/Part1/nMDS_MM.png){height="400"}
:::

:::{.absolute top="40%" left="0%" .fragment .fade-in fragment-index="5" style="text-align: left;  font-size: 60px;"}
**Compare the Sensors:** 

- Supervised Machine Learning Classifiers
:::

<!-- :::{.absolute top="55%" left="5%" .fragment .fade-in-then-out fragment-index="5" style="text-align: left;  font-size: 60px;"} -->
<!-- - Random Forest -->
<!-- - XGBoost  -->
<!-- - SVM -->
<!-- - ... -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-the-out fragment-index="5" top="35%" left="60%"} -->
<!-- ![](Images/Part1/tidymodels.png){height="400"} -->
<!-- ::: -->

:::{.absolute top="55%" left="5%" .fragment .fade-in fragment-index="6" style="text-align: left;  font-size: 60px;"}
- Random Forest 
:::
::: {.absolute .fragment .fade-in fragment-index="6" top="35%" left="60%"}
![](Images/Part1/random-forests.jpg){height="400"}
:::



:::{.absolute top="70%" left="15%" .fragment .fade-in-then-out fragment-index="6" style="text-align: left;  font-size: 60px;"}
**Training of the model:**

- 75 % of the dataset
- Maximisation of the AUC-ROC
:::


:::{.absolute top="70%" left="65%" .fragment .fade-in-then-out fragment-index="6" style="text-align: left;  font-size: 60px;"}
**Validation of the model:**

- 25 % of the dataset
- Accuracy metrics
:::
:::

::: {.absolute .fragment .fade-in fragment-index="7" top="6.5%"}
*Putting theory into practice*
:::

```{r Map Drone Flights}
#| echo: false
#| eval: false
#| warning: false

library(sf)
library(tidyverse)
library(Utilities.Package)

land_mask <- read_sf("Data/Part1/Maks_land_SPain_Portugal_France.shp")

Sampling_points <- tibble(
  Country = c("France", "France","France","France", "France","France", "Portugal", "Portugal","Portugal", "Spain", "Spain"),
  Site = c("Arz Island","Duer","L'Epine", "Barbâtre", "Notre-Dame De Tremor", "Pont Du Guilly","Mataducos","Marinha Lanzarote","Gafanha", "Marisma de Cudon","Marisma de Cortiguera"),
  x = c(-2.795421, -2.746693, -2.227908,  -2.167879, -3.746980,  -3.655206, -8.647991, -8.682370,  -8.743255, -4.025298, -4.032117),
  y = c(47.603054, 47.541086,46.989746,46.956383,47.836484,47.822825, 40.666879, 40.666201,40.599341,43.406445,43.414978)) 

# plot(Sampling_points)
# 
# ggplot()+
#   geom_sf(data = land_mask)+
#   geom_sf(data = Sampling_points)

my_sf_simple <- rmapshaper::ms_simplify(land_mask, keep = 0.05)  # Simplify to 5% of points


bbox <- st_bbox(c(xmin = -15, xmax = 0, ymin = 35, ymax = 50), crs = st_crs(land_mask)) %>% 
  st_as_sfc()

# Crop using st_intersection
land_mask <- st_intersection(land_mask, bbox)


(
Sampling_plot <-
ggplot() +
  geom_sf(data = my_sf_simple, linewidth = 0.05, alpha = 0.93, fill = "grey80") +
      coord_sf(xlim=c(-15,0) ,
                ylim=c(35,50),
               expand = F ) +
  ggforce::geom_mark_ellipse(data=Sampling_points,
                 aes(x=x,
                     y=y,
                     label = Country,
                     group = Site,
                     description=Site),
                     # x0 = -22),
                 size=0.2,
                 # position = "jitter",
                 fill = "goldenrod",
                 con.colour = "goldenrod4",
                 show.legend=F,
                 label.fontsize = 15,
                 label.hjust = 0.5,
                 con.size = 0.5,
                 alpha=0.8,
  expand = unit(2, "mm") ,
  radius = unit(2, "mm") ,
  label.fill = "grey90",
  label.buffer = unit(5, "mm")) +
    theme_void()+
  # theme_Bede_Map()+
  # labs(x="Longitude",
       # y="Latitude")+
  # geom_label(aes(x = 521000, y = 4507794, label = "C"), size = 20)+
  # scale_x_continuous(breaks = seq(-8.70, -8.60, by = 0.10))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank()
        # axis.text.x = element_text(size = 20),
        # axis.text.y = element_text(size = 20)
        )
)

ggsave(filename = "Images/Part1/map_Drone.svg", 
       plot = Sampling_plot, 
       width = 7.03,
       height = 10, 
       units = "in")

```

::: {.fragment .fade-out fragment-index="10" }
::: {.absolute .fragment .fade-in fragment-index="7" bottom="-8%" right="-7.6%"}
![](Images/Part1/Map_Drone-01.png){height="1400"}
:::
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="15%" left="5%"}
::: {.absolute bottom="-5%" left="30%"}
DJI Matrice 200
:::

![](Images/Part1/Matrice_Hermelle.jpg){height="450" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="15%" left="40%"}
::: {.absolute bottom="-5%" left="20%"}
Micasense RedEdge-MX Dual
:::

![](Images/Part1/MicasenseCamera.jpg){height="450" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="7" bottom="-2%" left="3%"}
![](Images/Part1/micasense_bands.png){height="550"}
:::


```{r Table1 building}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)
library(flextable)
library(officer)

# your data …
df <- data.frame(
  Country = c(rep("France",7), rep("Spain",2), rep("Portugal",4)),
  Site    = c("Aven","Belon", rep("Gulf of Morbihan",3), rep("Bourgneuf Bay",2),
              rep("Saja Estuary",2), rep("Aveiro Lagoon",4)),
  Name    = c("Pont de Guilly","Notre-dame de Tremor","Arz Island","Duer","Duer",
              "Barbâtre","L'Epine","Marisma de Cudon","Marisma de Cortiguera",
              "Marinha Lanzarote","Mataducos","Gafanha","Gafanha"),
  Altitude= c("120m","120m","12m","12m","120m","120m","120m","120m",
              "120m","120m","120m","120m","12m"),
  Utility = c("Training / Validation","Training / Validation","Training","Training",
              "Validation","Validation","Validation","Training / Validation",
              "Training / Validation","Validation","Validation","Validation","Training"),
  Date    = c("11/04/2024","11/04/2024","29/09/2022","14/07/2022","14/07/2022",
              "07/09/2021","08/07/2021","25/06/2024","25/06/2024","17/06/2022",
              "16/06/2022","15/06/2022","15/06/2022"),
  Project = c(rep("InvaSea",2), rep("BiCOME",5), rep("InvaSea",2), rep("BiCOME",4))
)

# define borders
brdr_outer <- fp_border(color = "black", width = 1)
brdr_inner <- fp_border(color = "gray80", width = 0.5)

ft <- flextable(df) %>%
  merge_v(j = c("Country","Site")) %>%
  set_table_properties(layout = "fixed") %>%
  width(j = "Country",  width = 1.2) %>%
  width(j = "Site",     width = 1.6) %>%
  width(j = "Name",     width = 2.4) %>%
  width(j = "Altitude", width = 0.8) %>%
  width(j = "Utility",  width = 1.4) %>%
  width(j = "Date",     width = 1.2) %>%
  width(j = "Project",  width = 1.2) %>%
  theme_booktabs() %>%
  border_outer(border = brdr_outer) %>%
  border_inner_h(border = brdr_inner) %>%
  border_inner_v(border = brdr_inner) %>%
  # zebra striping: even rows get light gray
  bg(i = seq(2, nrow(df), by = 2), bg = "#f7f7f7", part = "body") %>%
  bg(j = 1:2, bg = "white", part = "body") %>%

  fontsize(size = 10, part = "all") %>%
  padding(padding = 5, part = "all") %>%
  align(align = "center", part = "all") %>%
  autofit()

ft

save_as_image(ft, "Images/Part1/table_flights.png", res = 400)

```


<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="8" top="10%" left="0%"} -->
<!-- ![](Images/Part1/table_flights.png){width="1950"} -->
<!-- ::: -->


<!-- ::: {.fragment .fade-out fragment-index="10"} -->
<!-- ::: {.absolute .fragment .fade-in fragment-index="9" top="10%" left="0%"} -->
<!-- ![](Images/Part1/table_flights2.png){width="1950"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="9" top="45%" left="3%"} -->
<!-- ![](Images/Part1/grid_high_low.png){width="650"} -->
<!-- ::: -->


<!-- ::: {.absolute .fragment .fade-in fragment-index="9" bottom="-8%" right="-7.6%"} -->
<!-- ![](Images/Part1/Map_Drone-02.png){height="1400"} -->
<!-- ::: -->

<!-- ::: {.absolute top="60%" left="35%" .fragment .fade-in fragment-index="9" style="font-size: 60px;"} -->
<!-- Sentinel-2: 100 pixels/hectar -->

<!-- Drone 120 m: ~1 500 000 pixels/hectar -->

<!-- Drone 12 m: ~15 000 000 pixels/hectar -->
<!-- ::: -->
<!-- ::: -->

::: {.absolute .fragment .fade-in fragment-index="10" top="25%" left="0%"}
**Training of the model:**


- Flight Height: 12m
- Product resolution: 8mm 
:::

::: {.absolute .fragment .fade-in fragment-index="10" bottom="10%" left="0%"}
**Large scale coverage:**


- Flight Height: 120m
- Product resolution: 80mm 
:::


```{r Figure3 text opening}
#| echo: false
#| eval: false
#| warning: false

layout<-"Data/Part1/" %>%
  list.files("V5.txt",full.names = T, recursive = T) %>%
  read_delim(delim = "\t", escape_double = FALSE,
    trim_ws = TRUE) %>%
  dplyr::filter(Evaluate == T)


layout$Text<- gsub("alaligne","\n", layout$Text)

boxes<- layout %>% 
  dplyr::filter(Type == "Box",
                shape == "square")


text<- layout %>% 
  dplyr::filter(Type == "Box")

diamonds<- layout %>% 
  dplyr::filter(Type == "Box",
                shape == "diamond")
diff = 0.1
for (i in 1:nrow(diamonds)) {
  diam_a<-diamonds[i,]
  
df<-data.frame(  
  x = c(diam_a$xmin - diff, diam_a$xmin + diff, diam_a$xmax + diff, diam_a$xmax - diff),
  y = c(diam_a$ymin, diam_a$ymax, diam_a$ymax, diam_a$ymin),
  Type = rep(diam_a$Type,4),
  Text = rep(diam_a$Text,4),
  Color = rep(diam_a$color,4),
  Evaluate = rep(diam_a$Evaluate,4),
  Resolution =  rep(diam_a$Resolution,4),
  Evaluate_bigbox = rep(diam_a$Evaluate_bigbox,4),
  alpha = rep(diam_a$alpha,4),
  shape =  rep(diam_a$shape,4)
)
  if(i == 1){
    diamond_list<-list(df)
  }else{
    diamond_list[[i]]<-df
  }
}



Arrows<- layout %>% 
  dplyr::filter(Type == "Arrow",
                Evaluate == T)

Group_box<-layout %>% 
  dplyr::filter(Type == "Box",
                Evaluate_bigbox == T) %>% 
  group_by(Group) %>% 
  dplyr::summarise(xmin = min(xmin)-0.1,
                   xmax = max(xmax)+0.1,
                   ymin = min(ymin)-0.1,
                   ymax = max(ymax)+0.1,
                   alpha = 0.1,
                   color = color)

resolution_box<-layout %>% 
  dplyr::filter(Type == "Box",
                Resolution != "NA") %>% 
  group_by(Resolution) %>% 
  dplyr::summarise(xmin = min(xmin)-0.1,
                   xmax = max(xmax)+0.1,
                   ymin = min(ymin)-0.1,
                   ymax = max(ymax)+0.1,
                   alpha = 0.1,
                   color = color)

legend = data.frame(color = unique(layout$color)) %>% 
  dplyr::filter(!is.na(color)) %>% 
  mutate(label = case_when(color == "#EA6155" ~ "Input Data",
                           color == "#DC9614" ~ "Pre-processing",
                           color == "#52A4DA" ~ "Model Building",
                           color == "#79DA52" ~ "Validation",
                           color == "#DA9652" ~ "Output Data",
                           color == "darkcyan" ~ "Final Product",
                           color == "#DA5273"  ~ "Prediction",
                           TRUE ~ "NA")) %>% 
  arrange

segment<-layout %>% 
  dplyr::filter(Type == "Segment")
  

```

```{r Figure3 building}
#| echo: false
#| warning: false
#| eval: false

building <- F

if(building == T){
  
text_size = 6 #### 6 to plot it fullscreen in R,  1.8 for exporting with ggsave
line_size =1 ####arrow_size 0.3 to export  1 to for R plotting

legend_size = 1 #### 0.3 to export, 1 for R ploting
legend_text = 10 #### 4 to export, 10 for R ploting
}else{
  
text_size = 1.85 #### 6 to plot it fullscreen in R,  1.8 for exporting with ggsave
line_size =0.3 ####arrow_size 0.3 to export  1 to for R plotting

legend_size = 0.3 #### 0.3 to export, 1 for R ploting
legend_text = 5 #### 5 to export, 10 for R ploting
  
}


a<-ggplot()+
  
  statebins:::geom_rrect(data = Group_box,
            mapping = aes(xmin = xmin,
                          xmax= xmax,
                          ymin = ymin,
                          ymax = ymax),
            alpha = 0.05,
            size = 0.2,
            show.legend = F,
            fill = Group_box$color,
            color = "black")+
  
    statebins:::geom_rrect(data = resolution_box,
            mapping = aes(xmin = xmin,
                          xmax= xmax,
                          ymin = ymin,
                          ymax = ymax,
                          alpha = rep(c("Input Data", "Pre-processing", "Model Building", "Prediction", "Validation", "Output Data", "Final Product"),2)),
            fill = "NA",
            linetype = 2,
            size = 0.4,
            color = "black")+
  
  scale_alpha_manual(name = "", 
                     values = c(1,1,1,1,1,1,1),
                     labels = c("Input Data", "Pre-Processing", "Model Building", "Prediction", "Validation", "Output Data", "Final Product"),
                     guide = guide_legend(ncol = 1, override.aes = list(fill = c("#f94144", "#f3722c", "#f8961e", "#f9c74f", "#90be6d", "#43aa8b", "#577590"),
                                                                        shape = c(22),
                                                                        linetype = c(1),
                                                                        alpha = c(0.5)
                                                                        )
                                          )
                     )+
  
  statebins:::geom_rrect(data = boxes,
            mapping = aes(xmin = xmin,
                          xmax= xmax,
                          ymin = ymin,
                          ymax = ymax
                          ),
            size = 0.2,
            alpha = as.numeric(boxes$alpha),
            fill = boxes$color,
            color = "black")
  
  for(i in 1:length(diamond_list)){
    poly_i<-diamond_list[[i]]
    a<-a+
      geom_polygon(data = poly_i, 
                   mapping = aes(x = x, 
                                 y = y
                                 ),
                  size = 0.2,
                   alpha = poly_i$alpha,
                   fill = poly_i$Color,
                   color = "black")
    
  }

if(building == T){
    a<-a+
    geom_text(data = text,
            mapping = aes(x = (xmax+xmin)/2, y = (ymax + ymin)/2, label = (ID)), size = text_size)
  
}else{
    a<-a+
    geom_text(data = text,
            mapping = aes(x = (xmax+xmin)/2, y = (ymax + ymin)/2, label = (Text)), size = text_size)
}


  a<-a+
    geom_segment(data = Arrows, aes( x = xmin, xend = xmax, y = ymin, yend = ymax),
    size=line_size, linejoin = "mitre", lineend = "butt",
    arrow = arrow(length = unit(1, "mm"), type= "closed")
    )+
    geom_segment(data = segment, aes( x = xmin, xend = xmax, y = ymin, yend = ymax),
    size=line_size, linejoin = "mitre", lineend = "square"
    )+
  
  geom_text(aes(x = -5.4, y = -2, label = "Flight height: 12 m \n Pixel size : 8 mm", angle = 90), size = text_size+1)+
  
  geom_text(aes(x = -5.4, y = -6.8, label = "Flight height: 120 m \n Pixel size : 80 mm", angle = 90), size = text_size+1)+
  
  geom_text(aes(x = 4, y = 1.75, label = "Pre Processing"), size = text_size)
    
  if(building == F){
  a<- a+ theme_void()
  }
  
  a<-a+
  theme(legend.position = c(0.88,0.3),
        legend.text = element_text(size = legend_text),
        legend.key.size = unit(legend_size, 'cm')
        )+
  scale_x_continuous(breaks = scales::breaks_width(0.5))+
  scale_y_continuous(breaks = scales::breaks_width(0.5))
  
if(building == T){
a
}else{
  ggsave(filename = "Images/Part1/Figure3_workflow.svg", 
       plot = a, 
       width = 10,
       height = 5.88, 
       units = "in")
}


```


::: {.absolute .fragment .fade-in-then-out fragment-index="10" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow.png){width="1800"}
:::

::: {.absolute .fragment .fade-in fragment-index="10" top="0%" left="50%"}

![](Images/Part1/fastai.png){height="300"}
:::

::: {.absolute .fragment .fade-in fragment-index="10" top="0%" right="20%"}

![](Images/Part1/DISCOV_logoV2.png){height="300"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="11" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow2.png){width="1800"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="12" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow3.png){width="1800"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="13" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow4.png){width="1800"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="14" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow5.png){width="1800"}
:::

::: {.absolute .fragment .fade-in fragment-index="15" bottom="0%" right="0%"}

![](Images/Part1/Figure3_workflow6.png){width="1800"}
:::

## Results

```{r MDSPlotsWithoutBSData}
#| echo: false
#| warning: false
#| eval: false

library(hsdar)
library(vegan)
library(tidyverse)

Data_MDS_List<-list() 

Data_hulls_List<-list() 

Data_AnoSIM_list<-list()

dataUntransformed <- read_rds("Data/Part1/dataUntransformed.rds")
datatransformed_Wide <- read_rds("Data/Part1/datatransformed_Wide.rds")

for (i in seq_along(datatransformed_Wide) ) {

Meta<-datatransformed_Wide[[i]]%>% 
  dplyr::filter(!Species_Group=="Bare Sediment") %>% 
  dplyr::select(Species,Species_Group)

Comm<-datatransformed_Wide[[i]]%>% 
  dplyr::filter(!Species_Group=="Bare Sediment")%>% 
  dplyr::select(-c(Substrate,Species_Group,Species) )  %>% 
  as.matrix() 

set.seed(4321)

speclib_data <- speclib(spectra=Comm, wavelength=as.numeric(colnames(Comm) ) ) 

set.seed(2345)

SAM <- sam_distance(speclib_data) 

ANOSIM<-anosim(SAM, grouping = Meta$Species_Group,permutations = 999)

Anosim_df<-data.frame(R=ANOSIM$statistic,
                      p=ANOSIM$signif) %>% 
  dplyr::mutate(Data=paste0(names(dataUntransformed)[[i]]) )

Data_AnoSIM_list[[i]]<-Anosim_df

mds_sam <- MASS::isoMDS(SAM,maxit = 50,trace=FALSE) 

MDS_sam <- mds_sam$points %>% 
    as_tibble()  %>% 
    dplyr::rename(x=V1,y=V2)  %>% 
    bind_cols(Meta)  %>% 
    dplyr::mutate(Stress=mds_sam$stress/100,
                  Data=paste0(names(dataUntransformed) [[i]]) ) 
  
  Data_MDS_List[[i]]<-MDS_sam
  
  Magnoliopsida_hull <- MDS_sam[MDS_sam$Species_Group == "Magnoliosida",
                               ][chull(MDS_sam[MDS_sam$Species_Group =="Magnoliosida",
                                               c("x", "y") ]) , ]
  
  
  Ulvophyceae_hull <- MDS_sam[MDS_sam$Species_Group == "Ulvophyceae",
                         ][chull(MDS_sam[MDS_sam$Species_Group =="Ulvophyceae",
                                         c("x","y") ]) , ]
  
  Phaeophyceae_hull <- MDS_sam[MDS_sam$Species_Group == "Phaeophyceae",
                               ][chull(MDS_sam[MDS_sam$Species_Group == "Phaeophyceae",
                                               c("x","y") ]) , ]
 
  Xanthophyceae_hull <- MDS_sam[MDS_sam$Species_Group == "Xanthophyceae",
                                 ][chull(MDS_sam[MDS_sam$Species_Group == "Xanthophyceae",
                                                 c("x","y") ]) , ]
   
  Bacillariophyceae_hull <- MDS_sam[MDS_sam$Species_Group == "Bacillariophyceae",
                                    ][chull(MDS_sam[MDS_sam$Species_Group =="Bacillariophyceae",
                                                    c("x","y") ]) , ]
  

  hulls <- rbind(Magnoliopsida_hull,
                 Ulvophyceae_hull,
                 Phaeophyceae_hull,
                 Xanthophyceae_hull,
                 Bacillariophyceae_hull)  %>% 
    dplyr::mutate(Data=paste0(names(dataUntransformed) [[i]]) ) 
  
    Data_hulls_List[[i]]<-hulls

  
  
}
  
MDSData_1<-map_df(Data_MDS_List,bind_rows)  %>% 
  dplyr::mutate(Data=as.factor(case_when(Data=="S2_10" ~ "Sentinel-2 10m",
                                         TRUE ~ Data) ) ,
                Data=fct_relevel(Data,"ASD",
                                          "Drone",
                                          "Sentinel-2 10m"))  

X_correct<-MDSData_1 %>% 
  group_by(Data) %>% 
  dplyr::summarise(x=min(x) ) %>% 
  left_join(MDSData_1) %>% 
  dplyr::select(Data,Species_Group) %>% 
  dplyr::filter(!Species_Group=="Phaeophyceae") %>% 
  dplyr::ungroup()

Y_correct<-MDSData_1 %>% 
  group_by(Data) %>% 
  dplyr::summarise(y=max(y) ) %>% 
  left_join(MDSData_1) %>% 
  dplyr::select(Data,Species_Group) %>% 
  dplyr::filter(!Species_Group=="Ulvophyceae") %>% 
  dplyr::ungroup()


MDSData<-MDSData_1 %>% 
  dplyr::mutate(x=case_when(Data%in%X_correct$Data~-x,
                            TRUE~x) ,
                y=case_when(Data%in%Y_correct$Data~-y,
                            TRUE~y) ,
                Species_Group=case_when(Species_Group=="Magnoliosida"~"Magnoliopsida",
                                        TRUE~Species_Group),
                Species_Group=factor(Species_Group,
                                     levels=c(
                                          "Bacillariophyceae",
                                          "Magnoliopsida",
                                          "Phaeophyceae",
                                          "Ulvophyceae",
                                          "Xanthophyceae") ) )

hullsData<-map_df(Data_hulls_List,bind_rows) %>% 
  dplyr::mutate(Data=as.factor(case_when(Data=="S2_10" ~ "Sentinel-2 10m",
                                         # Data=="S2_1020" ~ "Sentinel-2 20m",
                                         TRUE ~ Data) ) ,
                Data=fct_relevel(Data,c("ASD",
                                        "Drone",
                                        "Sentinel-2 10m"))) %>% 
  dplyr::mutate(x=case_when(Data%in%X_correct$Data~-x,
                            TRUE~x) ,
                y=case_when(Data%in%Y_correct$Data~-y,
                            TRUE~y),
                Species_Group=case_when(Species_Group=="Magnoliosida"~"Magnoliopsida",
                                        TRUE~Species_Group),
                Species_Group=factor(Species_Group,
                                     levels=c(
                                          "Bacillariophyceae",
                                          "Magnoliopsida",
                                          "Phaeophyceae",
                                          "Ulvophyceae",
                                          "Xanthophyceae")))

AnoSimData<-map_df(Data_AnoSIM_list,bind_rows) %>% 
  dplyr::mutate(Value=paste0("R= ",signif(R,3)," & p= ",signif(p,3) ),
                Data=as.factor(case_when(Data=="S2_10"~"Sentinel-2 10m",
                                         TRUE ~ Data) ) ,
                Data=fct_relevel(Data,c("ASD",
                                          "Drone",
                                          "Sentinel-2 10m") ))


Stress<-MDSData %>% 
  group_by(Data)  %>% 
  summarise(Stress=signif(mean(Stress) ,3) ) %>% 
  full_join(AnoSimData,by="Data")

Data.labs <-paste0(Stress$Data,"      Stress: ",Stress$Stress, ", \nANOSIM: ",Stress$Value) 

names(Data.labs)  <-  c("ASD","Drone","Sentinel-2 10m") 
```

```{r MDSPlotsWithoutBS}
#| echo: false
#| warning: false
#| eval: false

MDSData <- MDSData %>% 
  mutate(Species_Group = case_when(Species_Group == "Ulvophyceae" ~ "Chlorophyceae",
                                   T ~ Species_Group))

hullsData <- hullsData %>% 
  mutate(Species_Group = case_when(Species_Group == "Ulvophyceae" ~ "Chlorophyceae",
                                   T ~ Species_Group))

colscal <- c("Bacillariophyceae"="#DAA520",
             "Magnoliopsida"="#389318",
             "Phaeophyceae"="#873e23", 
             "Chlorophyceae"="#768807",
             "Xanthophyceae"="#e0e809")


a <- ggplot() +
    geom_point(data=MDSData,aes(x=x,y=y,colour=Species_Group) ,alpha=0.9,size=0.5) +
    geom_polygon(data=hullsData,aes(x=x,y=y,fill=Species_Group) ,alpha=0.2) +
    theme_Bede() +
    scale_colour_manual(name="Class",values = colscal) +
    scale_fill_manual(name="Class",,values = colscal) +
    labs(y="",
       x="",
       colour="Class",
       fill="Class") +
  facet_wrap(~Data,ncol = 2, 
  labeller = labeller( Data = Data.labs) ,
  scales = "free")  +
    theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank(),
      plot.margin = unit(c(1.25,1.25,1.25,1.25), "cm"),
      strip.text = element_text(size=14),
      legend.title = element_text(size=14),
      legend.text = element_text(size=14),
      legend.direction = "vertical",
      legend.position = "top",
      legend.justification = "center")+
  guides(fill=guide_legend(ncol=3),
         colour=guide_legend(ncol=3))
  

ggsave(filename = "Images/Part1/nMDS_3sensors.svg", 
       plot = a, 
       width = 10,
       height = 10, 
       units = "in")


```

::: {.absolute .fragment .fade-out fragment-index="1" top="6.5%"}
*Hyperspectral library*
:::

::: {.fragment .fade-out fragment-index="4"}
::: {.absolute .fragment .fade-in fragment-index="1" top="6.5%"}
*Hyperspectral library - nMDS*
:::
:::

::: {.fragment .fade-out fragment-index="7"}
::: {.absolute .fragment .fade-in fragment-index="4" top="6.5%"}
*Hyperspectral library - Random Forest Classifier*
:::
:::



::: {.absolute .fragment .fade-out fragment-index="1" top="10%" left="-5%"}

![](Images/Part1/Menu_library.png){height="1100"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="10%" left="-5%"}

![](Images/Part1/Menu_library_ASD.png){height="1100"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="5%" right="-5%"}

![](Images/Part1/Figure_part1_ASD-01.png){height="1200"}
:::


<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="10%" left="-5%"} -->

<!-- ![](Images/Part1/Menu_library_Micasense.png){height="1100"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="5%" right="-5%"} -->

<!-- ![](Images/Part1/Figure_part1_Drone-01.png){height="1200"} -->
<!-- ::: -->

::: {.absolute .fragment .fade-in-then-out fragment-index="3" top="10%" left="-5%"}

![](Images/Part1/Menu_library_S2.png){height="1100"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="3" top="5%" right="-5%"}

![](Images/Part1/Figure_part1_S2-01.png){height="1200"}
:::


```{r Conf_Mat}
#| error: false
#| warning: false
#| echo: false
#| eval: false

library(tidyverse)

Final_Conf<-read_csv("Data/Part1/RandomForestConf.csv")%>% 
  dplyr::rename(Truth=col,Prediction=row)%>% 
  dplyr::group_by(Prediction,Truth,Model,Data) %>% 
  dplyr::summarise(value=sum(value) ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(correct=case_when(Truth==Prediction~1,
                                  !Truth==Prediction~0,
                                  TRUE~9999,
                                  ) ) %>% 
  group_by(Truth,Model,Data) %>% 
  summarise(True_Acc=signif((value*correct)/sum(value),2),
            value=value,
            correct=correct,
            Prediction=Prediction) %>% 
  dplyr::ungroup() %>% 
  group_by(Prediction,Model,Data) %>% 
  summarise(Pred_Acc=signif((value*correct)/sum(value),2),

            value=value,
            correct=correct,
            True_Acc=True_Acc,
            Truth=Truth)


Total<-read_csv("Data/Part1/RandomForestConf.csv") %>% 
  dplyr::filter(Data=="ASD") %>% 
  group_by(col) %>% 
  dplyr::summarise(tot=sum(value))

Conf_Df_Plot<-Final_Conf %>% 
  dplyr::full_join(Total,by=c("Truth"="col") ) %>% 
  dplyr::mutate(Prop=if_else((value/tot)>1,1,value/tot),
                Data=as.factor(Data) ,
                Prediction=as.factor(case_when(
                              Prediction=="Bacillariophyceae"~"Bac",
                              Prediction=="Bare Sediment"~"Bar",
                              Prediction=="Magnoliosida"~"Mag",
                              Prediction=="Phaephyceae"~"Pha",
                              Prediction=="Ulvophyceae"~"Ulv",
                              Prediction=="Xanthophyceae"~"Xan") ) ,
                Truth=as.factor(case_when(
                              Truth=="Bacillariophyceae"~"Bac",
                              Truth=="Bare Sediment"~"Bar",
                              Truth=="Magnoliosida"~"Mag",
                              Truth=="Phaephyceae"~"Pha",
                              Truth=="Ulvophyceae"~"Ulv",
                              Truth=="Xanthophyceae"~"Xan") )) %>% 
  ungroup()%>% 
  dplyr::mutate(Data=forcats::fct_relevel(Data,
                                          c("ASD",
                                            "PRISMA",
                                            "Drone",
                                            "Sentinel-2 20m",
                                            "Pleiades",
                                            "Sentinel-2 10m") ),
                Prediction=forcats::fct_relevel(Prediction,rev) )%>% 
 dplyr::filter(Prop>0)

```

```{r Conf_Mat_Plot}
#| error: false
#| warning: false
#| echo: false
#| eval: false
library(Utilities.Package)

cropped_df <- Conf_Df_Plot %>% 
  dplyr::filter(Data %in% c("ASD"
                            ,"Drone"
                            , "Sentinel-2 10m"
                            )
                )

for(i in 1:length(unique(cropped_df$Data))){
  
  print(unique(cropped_df$Data)[i])
plot_i <- cropped_df %>% 
  dplyr::filter(Data == unique(cropped_df$Data)[i]) %>% 
    ggplot()+
      geom_tile(aes(x=Truth,y=Prediction,alpha=Prop,fill=Prop,group=Model) )+
      geom_label(data=function(x) dplyr::filter(x, True_Acc>0),
                 aes(x=Truth,y=7.25,label=True_Acc,fill=True_Acc),
                 size=2.5)+
      geom_label(data=function(x) dplyr::filter(x, Pred_Acc>0),
                 aes(x=7.25,y=Prediction,label=Pred_Acc,fill=Pred_Acc),
                 size=2.5)+
      facet_wrap(~Data,ncol = 2,scales="free")+
      theme_Bede()+
      scale_fill_Bede("Climate",
                      name="Proportion of\nTotal Samples",
                      # breaks=c(0.0001,0.25,0.5,0.75,1),
                      limits=c(0.5,1.001),
                      oob      =  scales::squish,          # anything <0.5 → 0.5; >1 → 1
                      discrete=F,
                      alpha=0.9,)+
      scale_alpha_continuous(range = c(0.25, 1) )+
      scale_x_discrete(expand=expansion(mult=c(0.2,0.4) )) +
      scale_y_discrete(expand=expansion(mult=c(0.3,0.55) )) +
      guides(alpha = "none")+
        theme(plot.margin = unit(c(1.25,1.25,1.25,1.25), "cm"),
                          strip.text = element_text(size=14),
                          legend.title = element_text(size=12),
                          legend.text = element_text(size=14))
                  
  ggsave(paste0("Images/Part1/conf_mat_", unique(cropped_df$Data)[i],".png"),plot_i, units="in",width=8, height=5, dpi=300)

}
  
  


ggsave("Images/Part1/conf_mat_ASD.png", units="in",width=8, height=5, dpi=300)


```


::: {.absolute .fragment .fade-in-then-out fragment-index="4" top="10%" left="-5%"}

![](Images/Part1/Menu_library_ASD.png){height="1100"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="4" top="10%" left="6%"}

![](Images/Part1/conf_mat_ASD.png){height="1100"}
:::

::: {.absolute top="40%" right="0%" .fragment .fade-in-then-out fragment-index="4" style="font-size: 60px;"}
- Global accuracy: 0.95
- Cohen's kappa: 0.93
- Sensitivity: 0.93
- Specificity: 0.98
:::




<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="5" top="10%" left="-5%"} -->

<!-- ![](Images/Part1/Menu_library_Micasense.png){height="1100"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="5" top="10%" left="6%"} -->

<!-- ![](Images/Part1/conf_mat_Drone.png){height="1100"} -->
<!-- ::: -->

<!-- ::: {.absolute top="40%" right="0%" .fragment .fade-in-then-out fragment-index="5" style="font-size: 60px;"} -->
<!-- - Global accuracy: 0.94 -->
<!-- - Cohen's kappa: 0.93 -->
<!-- - Sensitivity: 0.94 -->
<!-- - Specificity: 0.98 -->
<!-- ::: -->



::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="10%" left="-5%"}

![](Images/Part1/Menu_library_S2.png){height="1100"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="10%" left="6%"}

![](Images/Part1/conf_mat_Sentinel-2 10m.png){height="1100"}
:::

::: {.absolute top="40%" right="0%" .fragment .fade-in-then-out fragment-index="6" style="font-size: 60px;"}
- Global accuracy: 0.83
- Cohen's kappa: 0.79
- Sensitivity: 0.84
- Specificity: 0.96
:::


::: {.fragment .fade-out fragment-index="13"}
::: {.absolute .fragment .fade-in fragment-index="7" top="6.5%"}
*Drone imagery - Example of classification*
:::


::: {.absolute .fragment .fade-in fragment-index="7" bottom="-8%" right="-7.6%"}
![](Images/Part1/Map_Drone_gaf-01.png){height="1400"}
:::
:::


```{r Figure 4 Gaf Low}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(terra)
library(sf)

Gafanha_low_ortho <- rast("Data/Part1/Gafanha_low_multi_resampled_colored.tif")

zoom_extent<-"Data/Part1/zoom_extent_map_Gafanha_comparison.shp" %>% 
  read_sf()


######### RGB #########

 names(Gafanha_low_ortho)<-c("B1", "B3", "B5","alpha")

 values(Gafanha_low_ortho)[values(Gafanha_low_ortho$alpha) == 0] = NA
  
 Gafanha_low_ortho_zoomed<-Gafanha_low_ortho %>% 
   crop(zoom_extent)
 
 # RGB(Gafanha_low_ortho_zoomed) <- 1:3
 
 map_extent_full<- st_as_sf(as.polygons(ext(Gafanha_low_ortho)))
 sf::st_crs(map_extent_full)<-st_crs(Gafanha_low_ortho)
 

  map_extent_zommed<- st_as_sf(as.polygons(ext(Gafanha_low_ortho_zoomed)))
 sf::st_crs(map_extent_zommed)<-st_crs(Gafanha_low_ortho_zoomed)
 
 
 rgb_Gafanha_low_zoomed<-ggplot()+
   tidyterra::geom_spatraster_rgb(data = Gafanha_low_ortho_zoomed, 
                                  r = 3,
                                  g = 2,
                                  b = 1)+
   theme_Bede_Map()+
   geom_sf(data = zoom_extent, fill = "transparent", colour = "red2",linetype = "dashed", linewidth = 1.5)+
   # coord_sf(crs = 4326)+
     theme_void()



 scale_labels<-data.frame(x = c(-8.74368, -8.743565,-8.74342),
                          y = c(rep(40.59792,3)),
                          text = c("0","10","20 m"))
 
 
 target_shp <- read_sf("Data/Part1/model_px_8m.shp")
 
 for (i in 1:nrow(target_shp)) {
   
   shp <- target_shp[i,]
   
   img_i <- Gafanha_low_ortho[[1:3]] %>% 
     crop(shp, mask = T)
   
   RGB(img_i) <- 1:3
   
   plot(img_i)
   
   writeRaster(img_i,paste0("Images/Part1/RGB_sample_", shp$Target,"8m.png"), overwrite = T)
 }
 
 
 
rgb_Gafanha_low<- ggplot()+
  # scale_fill_manual("", 
  #                   labels = c("Intertidal area", "Land area", "water"),
  #                   values = c("#7DC27D", "#CFCFCF","#42c9bc"))+
  # geom_sf(data = background_GafHigh,
  #         fill = "white",
  #         show.legend = F,
  #         linewidth=0.05,
  #         alpha=0.4,
  #         colour="white")+
  # geom_sf(data = background_GafHigh,
  #         mapping = aes(fill = Type),
  #         show.legend = F, 
  #         linewidth=0.05,
  #         alpha=0.4,
  #         colour="grey30")+
   tidyterra::geom_spatraster_rgb(data = Gafanha_low_ortho,
         r = 1,
         g = 2,
         b = 3,
         maxcell = 4010533
         # maxcell = 10000

         )+
    ggspatial::annotation_scale(location = "tl",
                                text_cex=2)+
      # annotation_custom(ggplotGrob(p1),
      #                   xmin = -8.7430,
      #                   xmax = -8.742702,
      #                   ymin = 40.5970515, 
      #                   ymax = 40.5974) +
   theme_Bede_Map()+
   # geom_sf(data = zoom_extent, 
   #         fill = "transparent",
   #         colour = "red2",
   #         linetype = "dashed", 
   #         linewidth = 1.5)+
   # coord_sf(crs = 4326)+
  # annotation_custom(ggplotGrob(rgb_Gafanha_low_zoomed),
  #                   xmin = -8.7430,
  #                   xmax=-8.7427,
  #                   ymin = 40.5977) +
  # geom_path(aes(x,y,group=grp),
  #           data = data.frame(x = c(-8.7432439,-8.743,-8.7432439,-8.743),
  #                             y=c(40.5976275,40.5979,40.5975373,40.59771),
  #                             grp=c(1,1,2,2)),
  #           linetype = "dashed", linewidth = 1.5, color = "red2")+
  theme(axis.title = element_blank(),
        axis.text.y = element_text(size = 20),
        axis.text.x = element_text(size = 20, angle = 20, hjust = 1))+
    scale_x_continuous(limits = c(-8.7437, -8.74295), breaks = -8.7432)+
    scale_y_continuous(limits = c(40.59715, 40.5979), breaks = 40.5975)
 
# rgb_Gafanha_low
 
 
  
  

ggsave("Images/Part1/Map_Pred/Gaf_Low_RGB.png",rgb_Gafanha_low , width = 900*4, height = 863*4, units = "px")

####### Zoomed map ########


Gafanha_low_pred_zoomed<-"Data/Part1/AveiroLowPrediction_nnNewStanRawMetrics_Preds_NoXantho_7.tif" %>% 
  rast()
names(Gafanha_low_pred_zoomed)<-"layer"

Gafanha_low_pred_zoomed<-Gafanha_low_pred_zoomed %>% 
  crop(zoom_extent)
Gafanha_low_pred_zoomed<-as.factor(Gafanha_low_pred_zoomed)

Gafanha_low_pred_map_zoomed<-ggplot()+
  tidyterra::geom_spatraster(data = Gafanha_low_pred_zoomed, mapping = aes(fill = layer))+
  geom_sf(data = zoom_extent, fill = "transparent", colour = "black",linetype = "dashed", linewidth = 1.5)+
  # coord_sf(crs = 4326)+
  scale_fill_manual(values=c("#A3A3A3", "#b3ff1a","#70543e", "#DAA520", "#389318","#5C2E1A","#b3002d", NA, "#42c9bc"), na.value = NA)+
  theme_void()+
  # coord_equal()+
  theme(axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.title = element_blank())+
  theme(legend.position = "none")
 # Gafanha_low_pred_map_zoomed

####  Overall map
Gafanha_low_pred<-"Data/Part1/AveiroLowPrediction_nnNewStanRawMetrics_Preds_NoXantho_7.tif" %>% 
  rast()
names(Gafanha_low_pred)<-"layer"


values(Gafanha_low_pred)[values(Gafanha_low_pred) == 0] = NA

Gafanha_low_pred<-Gafanha_low_pred %>% 
  as.factor()


 
 target_shp <- read_sf("Data/Part1/model_px_8m.shp")
 
 for (i in 1:nrow(target_shp)) {
   
   shp <- target_shp[i,]
   
   img_i <- Gafanha_low_pred %>% 
     crop(shp, mask = T)
   
   
   plot_i <-
  ggplot()+
  # scale_fill_manual("", 
  #                   labels = c("Intertidal area", "Land area", "water"),
  #                   values = c("white", "white","white"))+
  # geom_sf(data = background_GafHigh,
  #         mapping = aes(fill = Type),
  #         show.legend = F, 
  #         linewidth=0.05,
  #         alpha=0.4,
  #         colour="grey30")+
  # geom_sf(data = background_GafHigh,
  #         fill = "white",
  #         show.legend = F, 
  #         linewidth=0.05,
  #         alpha=1,
  #         colour="white")+
   ggnewscale::new_scale("fill")+
    tidyterra::geom_spatraster(data = img_i, 
                               mapping = aes(fill = layer),
                               maxcell = 500832*8,
                               show.legend = F)+
  # geom_sf(data = zoom_extent, 
  #         fill = "transparent", 
  #         colour = "black",
  #         linetype = "dashed", 
  #         linewidth = 1.5)+
  # # coord_sf(crs = 4326)+
  # annotation_custom(ggplotGrob(Gafanha_low_pred_map_zoomed), 
  #                   xmin = -8.7430,
  #                   xmax=-8.7427, 
  #                   ymin = 40.5977) +
  # geom_path(aes(x,y,group=grp),
  #           data = data.frame(x = c(-8.7432439,-8.743,-8.7432439,-8.743),
  #                             y=c(40.5976275,40.5979,40.5975373,40.59771),
  #                             grp=c(1,1,2,2)),
            # linetype = "dashed", linewidth = 1.5)+
  scale_fill_manual(breaks = c(1,2,5,6,7,8,10),
                    values=c("#A3A3A3", "#b3ff1a", "#DAA520", "#389318","#5C2E1A","#b3002d", "#42c9bc",NA,NA,NA,NA),
                    na.value = NA,
                    name = "",
                    labels = c("Sediment",
                               "Chlorophyceae",
                               "Bacillariophyceae",
                               "Magnoliopsida",
                               "Phaeophyceae",
                               "Rhodophyceae",
                               "Water"))+
  theme_void()+
     coord_sf(expand = F)
   
   
   
   ggsave(paste0("Images/Part1/Pred_sample_", shp$Target,"_8m.png"), plot_i, height = 10, width = 10)
 }


####### Pred ######



Gafanha_low_pred_map <-
  ggplot()+
  # scale_fill_manual("", 
  #                   labels = c("Intertidal area", "Land area", "water"),
  #                   values = c("white", "white","white"))+
  # geom_sf(data = background_GafHigh,
  #         mapping = aes(fill = Type),
  #         show.legend = F, 
  #         linewidth=0.05,
  #         alpha=0.4,
  #         colour="grey30")+
  # geom_sf(data = background_GafHigh,
  #         fill = "white",
  #         show.legend = F, 
  #         linewidth=0.05,
  #         alpha=1,
  #         colour="white")+
   ggnewscale::new_scale("fill")+
    tidyterra::geom_spatraster(data = Gafanha_low_pred, 
                               mapping = aes(fill = layer),
                               maxcell = 500832*8)+
  # geom_sf(data = zoom_extent, 
  #         fill = "transparent", 
  #         colour = "black",
  #         linetype = "dashed", 
  #         linewidth = 1.5)+
  # # coord_sf(crs = 4326)+
  # annotation_custom(ggplotGrob(Gafanha_low_pred_map_zoomed), 
  #                   xmin = -8.7430,
  #                   xmax=-8.7427, 
  #                   ymin = 40.5977) +
  # geom_path(aes(x,y,group=grp),
  #           data = data.frame(x = c(-8.7432439,-8.743,-8.7432439,-8.743),
  #                             y=c(40.5976275,40.5979,40.5975373,40.59771),
  #                             grp=c(1,1,2,2)),
            # linetype = "dashed", linewidth = 1.5)+
  scale_fill_manual(breaks = c(1,2,5,6,7,8,10),
                    values=c("#A3A3A3", "#b3ff1a", "#DAA520", "#389318","#5C2E1A","#b3002d", "#42c9bc",NA,NA,NA,NA),
                    na.value = NA,
                    name = "",
                    labels = c("Sediment",
                               "Chlorophyceae",
                               "Bacillariophyceae",
                               "Magnoliopsida",
                               "Phaeophyceae",
                               "Florideophyceae",
                               "Water"))+
  theme_Bede_Map()+
  # coord_equal()+
   theme(axis.text.x = element_text(size = 20, angle = 20,hjust = 1),
         # axis.text.y = element_text(size = 20),
         axis.text.y = element_blank(),
         axis.title = element_blank(),
         legend.background = element_blank(),
         legend.position = c(0.4,0.3),
         legend.text = element_text(size = 20),
         legend.key.size = unit(1,"cm"))+
    scale_x_continuous(limits = c(-8.7437, -8.74295), breaks = -8.7432)+
    scale_y_continuous(limits = c(40.59715, 40.5979), breaks = 40.5975)


ggsave("Images/Part1/Map_Pred/Gaf_Low_Pred.png",Gafanha_low_pred_map , width = 771*4, height = 863*4, units = "px")

################# PLOT AND SAVING ###########

plot_Gaf_Low<-rgb_Gafanha_low+
  Gafanha_low_pred_map
 
ggsave("Figures/High_res/Maps Pred/FigX-Gaf_Low_Pred.png",plot_Gaf_Low , width = 1920*4, height = 1009*4, units = "px")





# 2. Convert its centroid to an sf POINT
r_centroid <- st_as_sf(as.points(ext(Gafanha_low_pred), crs = crs(Gafanha_low_pred))) %>% 
              st_centroid()

# 3. Pick a UTM zone based on that longitude
lonlat <- st_coordinates(r_centroid)
utm_zone <- floor((lonlat[1] + 180) / 6) + 1
utm_crs  <- paste0("+proj=utm +zone=", utm_zone,
                   ifelse(lonlat[2] >= 0, " +north", " +south"),
                   " +datum=WGS84 +units=m +no_defs")

# 4. Reproject the centroid into metres
pt_utm <- st_transform(r_centroid, crs = utm_crs)

# 5. Build a 10 m × 10 m square around it by buffering 5 m with square caps
square_utm <- st_buffer(pt_utm,
                        dist = 4,                # half side‐length
                        endCapStyle = "SQUARE",  
                        joinStyle   = "MITRE")

# (Optionally) 6. Transform the square back to lon/lat (EPSG:4326)
square_wgs84 <- st_transform(square_utm, crs = 4326)

write_sf(square_wgs84, "Data/Part1/model_px_8m.shp")

```
::: {.fragment .fade-out fragment-index="13"}
::: {.absolute .fragment .fade-in fragment-index="7" top="14%" left="-5%"}

![](Images/Part1/Map_Pred/Gaf_Low_RGB.png){height="1100"}
:::
:::

::: {.blackarrow .absolute top="68%" left="28%" .fragment .fade-in-then-out fragment-index="8" style="border: 4px solid;" height="0px" width="500px"}
:::

::: {.blackarrow .absolute top="61%" left="21%" .fragment .fade-in-then-out fragment-index="9" style="border: 4px solid;" height="0px" width="670px"}
:::

::: {.blackarrow .absolute top="30%" left="22%" .fragment .fade-in-then-out fragment-index="10" style="border: 4px solid;" height="0px" width="650px"}
:::

::: {.blackarrow .absolute top="35%" left="28%" .fragment .fade-in-then-out fragment-index="11" style="border: 4px solid;" height="0px" width="500px"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="8" top="27%" left="50%"}
:::{.absolute bottom="-7%" left="18%" style="font-size: 60px;"}
Chlorophyceae
:::

![](Images/Part1/RGB_sample_Green8m.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="9" top="27%" left="50%"}
:::{.absolute bottom="-7%" left="13%" style="font-size: 60px;"}
Bacillariophyceae
:::

![](Images/Part1/RGB_sample_MPB8m.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="27%" left="50%"}
:::{.absolute bottom="-7%" left="16%" style="font-size: 60px;"}
Magnoliopsida
:::

![](Images/Part1/RGB_sample_Seagrass8m.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="11" top="27%" left="50%"}
:::{.absolute bottom="-7%" left="13%" style="font-size: 60px;"}
Florideophyceae
:::

![](Images/Part1/RGB_sample_red8m.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="12" top="14%" left="37%"}

![](Images/Part1/Map_Pred/Gaf_Low_Pred.png){height="1100"}
:::

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="13" top="20%" left="0%"} -->
<!-- :::{.absolute bottom="-7%" left="22%" style="font-size: 60px;"} -->
<!-- Chlorophyceae -->
<!-- ::: -->

<!-- ![](Images/Part1/RGB_sample_Green8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="13" top="20%" left="33%"} -->
<!-- ::: {.absolute top="0%" right="-40%"} -->
<!-- ![](Images/Part1/Map_Pred/legend.png){height="400"} -->
<!-- ::: -->

<!-- ![](Images/Part1/Pred_sample_Green_8m.png){height="800"} -->
<!-- ::: -->


<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="14" top="20%" left="0%"} -->
<!-- :::{.absolute bottom="-7%" left="22%" style="font-size: 60px;"} -->
<!-- Bacillariophyceae -->
<!-- ::: -->

<!-- ![](Images/Part1/RGB_sample_MPB8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="14" top="20%" left="33%"} -->
<!-- ::: {.absolute top="0%" right="-40%"} -->
<!-- ![](Images/Part1/Map_Pred/legend.png){height="400"} -->
<!-- ::: -->

<!-- ![](Images/Part1/Pred_sample_MPB_8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="15" top="20%" left="0%"} -->
<!-- :::{.absolute bottom="-7%" left="22%" style="font-size: 60px;"} -->
<!-- Magnoliopsida -->
<!-- ::: -->

<!-- ![](Images/Part1/RGB_sample_seagrass8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="15" top="20%" left="33%"} -->
<!-- ::: {.absolute top="0%" right="-40%"} -->
<!-- ![](Images/Part1/Map_Pred/legend.png){height="400"} -->
<!-- ::: -->

<!-- ![](Images/Part1/Pred_sample_seagrass_8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="16" top="20%" left="0%"} -->
<!-- :::{.absolute bottom="-7%" left="22%" style="font-size: 60px;"} -->
<!-- Florideophyceae -->
<!-- ::: -->

<!-- ![](Images/Part1/RGB_sample_red8m.png){height="800"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="16" top="20%" left="33%"} -->
<!-- ::: {.absolute top="0%" right="-40%"} -->
<!-- ![](Images/Part1/Map_Pred/legend.png){height="400"} -->
<!-- ::: -->

<!-- ![](Images/Part1/Pred_sample_red_8m.png){height="800"} -->
<!-- ::: -->


::: {.absolute .fragment .fade-in-then-out fragment-index="13" top="6.5%"}
*Drone imagery - Validation*
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="13" bottom="0%" left="10%"}

![](Images/Part1/ConfusionMatrixGlobal.png){height="1200"}
:::

```{r VIP}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(Utilities.Package)
log_func <- function(x) {
  0.9 + 0.1 * log(x / 400) / log(900 / 400)
}
exp_func <- function(x) {
  1 - exp(-0.01735 * (x - 444))
}

DataCombo <- read.csv("Data/Part1/DataCombo.csv")%>% 
  dplyr::filter(Data %in% c("ASD","Drone","Sentinel-2 10m")) 

DataCombo$Data <- factor(DataCombo$Data, levels = c(
  "ASD","Drone","Sentinel-2 10m"
  # "PRISMA",
  
  # # "Sentinel-2 20m",
  # # "Pleiades",
  
)) 


SP1<-read.csv("Data/Part1/Spectra_VIP.csv") %>%
  dplyr::select(-X) %>%
  mutate(type = "Min/Max Standardised Spectra") %>%
  dplyr::filter(Class != "Bare Sediment",
                Class != "Sun Glint",
                Class != "Water",
                Class != "Xanthophyceae",
                Class != "A - MagnoliopsidaL") %>%
  as_tibble()%>%
  rename(value = "STD") %>% 
  dplyr::filter(Class == "C - Rhodophyceae") %>% 
  dplyr::select(Species_Group = "Class", Mean_Reflec = "value", Wavelength) %>% 
  mutate(Mean_Reflec = case_when(Wavelength %in% c(531,560,650) ~ Mean_Reflec *0.15,
                                 Wavelength %in% c(668) ~ Mean_Reflec *0.1,
                                 T ~ Mean_Reflec))
### Just chloro and Magno

plot_SRF_sp <- DataCombo %>% 
  as_tibble() %>% 
  dplyr::filter(
    Species_Group %in% c("Magnoliopsida","Ulvophyceae","Phaeophyceae","Bacillariophyceae"),
                Data == "Drone",
                Rep == "Rep_1") %>% 
  dplyr::select(Wavelength,Species_Group,Mean_Reflec)  %>% 
  bind_rows(SP1) %>% 
  mutate(Species_Group = case_when(Species_Group == "C - Rhodophyceae" ~ "Florideophyceae",
                                   Species_Group == "Ulvophyceae" ~ "Chlorophyceae",
                                   T ~ Species_Group))

# ################# SPECTRA ########### 
# 
# colscale <- c("Magnoliopsida" = "#598f35", "Ulvophyceae" = "#c4fb58")

(SP_plot<-plot_SRF_sp %>%
  # dplyr::filter(Class %in% c("D - Chloropyceae", "A - Magnoliopsida")) %>%
  ggplot(aes( x = Wavelength, y = Mean_Reflec, color = Species_Group))+
  geom_line(linewidth = 2)+
  # facet_wrap(~ type, scale = "free",ncol =1) +
  scale_color_manual(values=c( "#DAA520", "#b3ff1a", "#b3002d","#389318", "#873e23"))+
  ylab("Reflectance")+
  xlab("Wavelength (nm)")+
  theme_Bede()+
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25),
        strip.text = element_text(size=25),
        legend.position = c(0.2, 0.7),
        plot.background = element_rect(fill = rgb(1,1,1, alpha=0), colour = NA),
        legend.title=element_blank(),
        legend.text = element_text(size = 20),
        legend.key.size = unit(1.5, "cm"),
        legend.text.align = 0,
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color="black"))
)
############## VIP ##############

VIP<-"Data/Part1/NN_VIP_byClass_NoXanth.csv" %>%
  read.csv() %>% 
  mutate(Magnoliopsida = (Magnoliosida + Low_SPC)/2) %>% 
  dplyr::select(-c(Magnoliosida ,Low_SPC))

VIP1<-VIP %>%
  dplyr::select(-c(Water,
                   SunGlint,
                   Deep_Sediment,
                   Bare_Sediment)) %>%
  # dplyr::filter(!str_detect(X,"NDVI")) %>% 
  mutate(isSTD = case_when(str_detect(X,"Stan") ~ "Standardised", 
                         TRUE ~ "RAW")) %>%
  pivot_longer(-c(X,isSTD), names_to = "Class",values_to = "value") %>% 
  dplyr::filter(X != "NDVI",
                X != "NDVI_Stan") %>% 
  group_by(Class) %>%
  mutate(STD = (value-min(value))/(max(value)-min(value))) %>% 
  ungroup() %>% 
  mutate(Class = case_when(Class == "Magnoliosida" ~ "Magnoliopsida",
                           Class == "Low_SPC" ~ "Magnoliopsida",
                           Class == "Clorophyta" ~ "Chlorophyceae",
                           Class == "Rhodphyta" ~ "Rhodophyceae",
                           Class == "MPB" ~ "Bacillariophyceae",
                           Class == "Phaeophyta" ~ "Phaeophyceae",
                           TRUE ~ Class),
         Variable = str_replace_all(str_replace_all(str_replace_all(X,"Reflectance",""),"Stan",""),"_","")) %>% 
  dplyr::filter(Class != "Total") 

VIP_summarised<-VIP1 %>% 
  group_by(Variable, Class) %>% 
  dplyr::summarise(sumVIP = sum(STD)) %>% 
  ungroup() %>% 
  group_by(Class) %>% 
  mutate(STD = (sumVIP-min(sumVIP))/(max(sumVIP)-min(sumVIP)))

(VIP_subPLOT<-VIP_summarised %>% 
  dplyr::filter(Class %in% c("Magnoliopsida", "Chlorophyceae")) %>% 
  ggplot(aes(x = Variable, y = STD, fill = Class)) +
  geom_col(color = "black",position =  "dodge", show.legend = F) +
  coord_polar()+
  scale_y_continuous(limits = c(0,1), breaks = c(0.25,0.5,0.75,1))+
  facet_wrap(~Class)+
  scale_fill_manual("Class", labels = c("Chlorophyceae", "Magnoliopsida"),
                    values = c("#b3ff1a", "#389318"))+
  theme_Bede()+
  theme(panel.grid.major.y = element_line(linetype = "dotted",color = c("grey9","grey9","grey9","grey9",NA)))+
  ylab("Importance")+
  theme(legend.position="top",
        strip.text = element_text(size = 20),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.ticks.y =element_blank(),
        axis.title.x =element_blank(),
        axis.title.y =element_text(size = 20),
        legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size=20),
        legend.text = element_text(size=20))+
  guides(fill = guide_legend(nrow = 1))
)

ggsave("Images/Part1/Fig_VIP.png", VIP_subPLOT, width = 10, height = 5, units = "in", dpi = 300)

ggsave("Images/Part1/Fig_VIP_Spectra.png", SP_plot, width =10, height = 10, units = "in", dpi = 300)

```

::: {.absolute .fragment .fade-in fragment-index="14" top="6.5%"}
*Drone imagery - Variable importance*
:::

::: {.absolute .fragment .fade-in fragment-index="14" top="20%" left="00%"}
![](Images/Part1/Fig_VIP.png){height="800"}
:::

::: {.absolute .fragment .fade-in fragment-index="14" top="20%" right="0%"}
![](Images/Part1/Fig_VIP_Spectra.png){height="900"}
:::

## Discussion

::: {.absolute top="6.5%"}
*Pigment Composition, Spectral Signature and Variable Importance*
:::


<!-- ::: {.absolute .fragment .fade-out fragment-index="2" top="10%" left="0%"} -->
<!-- ![](Images/Part1/Figure13.png){height="500"} -->
<!-- ::: -->

::: {.absolute .fragment .fade-out fragment-index="2" top="10%" left="0%" }
![](Images/Part1/Figure_Hyperspectral_Faded_zoomed_out.gif){height="800"}
:::

:::{.absolute top="0%" left="50%" style="font-size: 50px;"}
**Similar pigment composition,...**

-  ... but difference in carotenoid to chlorophyll-a ratios ([Repolho et al., 2017](http://doi.org/10.1038/srep41443))
- ... difference in the cell structure and the water content
:::


:::{.absolute top="30%" left="50%" .fragment .fade-in fragment-index="2" style="font-size: 50px;"}
**Distinction between green macrophyte possible using multispectral resolutions, ...**

- ... but ~530 nm & ~650 nm are key wavelengths

:::


:::{.absolute top="60%" left="50%" .fragment .fade-in-then-out fragment-index="3" style="font-size: 50px;"}
**Green macrophytes often co-occurs in intertidal areas...**

- Ultra high spatial resolution (from 80 to 8mm per pixel)
:::

:::{.absolute top="60%" left="50%" .fragment .fade-in fragment-index="4" style="font-size: 50px;"}
**Green macrophytes often co-occurs in intertidal areas...**

- Ultra high spatial resolution (from 80 to 8mm per pixel)
- Easy Photo-interpretation of pixels
- More than 1 000 000 training pixels. Over 11 sites of 3 country
- Diverse training dataset
:::


:::{.absolute top="10%" left="5%" .fragment .fade-in fragment-index="4" style="font-size: 50px;"}
Drone: 0.26 ha ~ 2.5 millions pixels

S2: 25 000 hectares ~ 2.5x Paris
:::

::: {.absolute  .fragment .fade-in-then-out fragment-index="2" top="7%" left="3%" }
![](Images/Part1/conf_mat_Sentinel-2 10m.png){height="650"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="2" bottom="-5%" left="10%" }
![](Images/Part1/Map_Pred/Fig_VIP_magn.png){height="630"}
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="3" bottom="-5%" left="10%" }

![](Images/Part1/Green_bourgneuf.jpg){height="1200"}
:::


::: {.absolute .fragment .fade-in fragment-index="4" top="20%" left="-30%" }

![](Images/Part1/Gafanha_Low.png){style="transform: rotate(45deg); height="2000"}
:::

:::{.absolute .fragment .fade-in-then-out fragment-index="3" bottom="0%" left="11%" style="font-size: 40px; color: white;"}
*Bourgneuf Bay, July 2024*
:::



# Case Study 1 – Facing Biological Invasions {data-stack-name="Invasive species"  background-image="Images/Part2/Background_Part2.png"}

- [Ecological Context & Significance](#ecological-context-significance)
- [Objectives](#objectives-of-the-work)
- [Material & Methods](#material_part2)
- [Results](#results_part2)
- [Discussion](#discussion_part2)


## Ecological Context & Significance

::: {.absolute .fragment .fade-out fragment-index="5" top="6.5%"}
*History of the aquaculture of the oyster in Europe*
:::

::: {.absolute .fragment .fade-out fragment-index="5" top="15%" left="0%" }
![](Images/Part2/Oyster_gigas2.gif){height="800"}
:::

::: {.absolute .fragment .fade-out fragment-index="5" top="15%" left="50%"}

::: {.absolute top="-10%" left="50%" style="z-index: 99;"}
*Flat Oyster*
:::

![](Images/Part2/flat_oyster.jpg){height="350" .circular-fade}
:::

::: {.absolute .fragment .fade-out fragment-index="5" top="15%" right="0%"}

::: {.absolute top="-10%" right="10%" style="z-index: 99;"}
*Portuguese Oyster*
:::

![](Images/Part2/Portuguese_oyster.jpg){height="350" .circular-fade}
:::




::: {.absolute .fragment .fade-out fragment-index="5" bottom="0%" right="2%" }
::: {.absolute bottom="-5%" right="10%"}
*Pacific Oyster*
:::

![](Images/Part2/gigas.jpg){.circular-fade height="700"}
:::

::: {.fragment .fade-out fragment-index="12" top="6.5%"}
::: {.absolute .fragment .fade-in fragment-index="5" top="6.5%"}
*A Hidden Passenger*
:::
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="5" top="15%" left="0%" }
- Originated from Japan
- 10 000 T spat were imported between 1971 and 1973
:::

::: {.fragment .fade-out fragment-index="9"}
::: {.absolute .fragment .fade-in fragment-index="6" top="15%" left="0%" }
- Originated from Japan
- Transport of fragment of *Gracilaria vermiculophylla*
:::

::: {.absolute .fragment .fade-down fragment-index="7" top="30%" left="0%" }
Resilient to:

- Salinity changes
- Desiccation
- Eutrophic conditions
- Can attach to shells, rocks or colonise soft bottom areas
:::



::: {.absolute .fragment .fade-in fragment-index="7" top="38%" left="25%" style="font-size: 60px;"}
**Well adapted to European estuaries**
:::

::: {.absolute .fragment .fade-in fragment-index="6" top="15%" right="0%" }
::: {.absolute bottom="-4%" right="10%"}
*Gracilaria vermiculophylla*
:::

![](Images/Part2/Gracilaria-vermiculophylla_002.jpg){height="900"}
:::
:::



<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="11" bottom="5%" left="15%"} -->
<!-- The transport of aquaculture structures between cultivation sites favorised its **spread across the World** -->
<!-- ::: -->

:::{.fragment .fade-out fragment-index="11"}

<!-- ::: {.absolute .fragment .fade-in fragment-index="8" bottom="5%" left="15%"} -->
<!-- The transport of aquaculture structures between cultivation sites favorised its **spread across Europe** -->
<!-- ::: -->

::: {.absolute .fragment .fade-in fragment-index="10" top="20%" left="0%" }
:::{.absolute top="-8%" left="10%"}
Belon Estuary, France, 2024
:::

![](Images/Part2/Belon_042024.jpg){height="400" .circular-fade}
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="9" top="20%" left="0%" }
:::{.absolute top="-7%" left="0%" style="font-size: 30px;"}
First observation in Europe in the Belon, Brittany, in 1996
::: 

![](Images/Part2/Rueness2005.png){height="400"}
:::




:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="21%" left="35%" }

:::{.absolute top="-12%" left="10%" style="z-index: 99;"}
Aveiro, Portugal, 2021
:::


<video 
  src="Video/Part2/gracilaria_aveiro.MP4"
  class="circular-fade"
  height="415"
  autoplay
  loop
  muted
  playsinline>
</video>
:::

::: {.absolute top="-3.5%" right="-10%" .fragment .fade-in-then-out fragment-index="2"}


:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="20%" left="65%" }
:::{.absolute top="-8%" left="10%"}
Etel, France, 2024
:::
![](Images/Part2/Etel_20240313.jpg){height="400" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="52%" right="29%" }
:::{.absolute bottom="-8%" right="10%"}
Auray, France, 2024
:::
![](Images/Part2/Auray_20240407.jpg){height="400" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="52%" right="0%" }
:::{.absolute bottom="-8%" right="10%"}
Scorff, France, 2024
:::
![](Images/Part2/Scorff_110424.jpg){height="400" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="52%" right="58%" }
:::{.absolute bottom="-8%" right="10%"}
Saja estuary, Spain, 2024
:::
![](Images/Part2/Saja_2024.jpg){height="400" .circular-fade}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="11" top="10%" left="5%" }
:::{.absolute top="-5%" right="10%"}
Source: [Mendoza-Segura et al., 2023](https://doi.org/10.3390/jmse11020367)
:::
![](Images/Part2/map_invasion_world.png){height="1100"}
:::


::: {.absolute .fragment .fade-out fragment-index="5" bottom="0%" left="0%" }
source: [Buestel et al., 2009](https://archimer.ifremer.fr/doc/00000/7396/6579.pdf)
:::

::: {.absolute .fragment .fade-in fragment-index="12" top="-2.5%" right="-12.5%" }
![](Images/Part2/Background_Part2.png){height="1500"}

:::


::: {.fragment .fade-out fragment-index="15"}

::: {.absolute .fragment .fade-in fragment-index="12" top="6.5%"}
*Ecological Impacts of the invasion*
:::


::: {.absolute .fragment .fade-in fragment-index="12" top="20%"}
**Negatives:**

- Can affect native Fucoids and Seagrasses
- Alter the sediment composition and structure
- Modify or disrupt trophic interactions
:::

::: {.absolute .fragment .fade-down fragment-index="13" top="50%"}
**Positives:**

- Create new habitats
- Stabilize the Sediment 
:::

:::

::: {.absolute .fragment .fade-in-then-out fragment-index="14" top="43%" left="30%" style="font-size: 50px;"}
**Monitoring** and **Managing**
:::

::: {.absolute .fragment .fade-in fragment-index="15" top="6.5%"}
*Remote Sensing as a tool to follow the invasion*
:::

::: {.absolute .fragment .fade-in fragment-index="15" top="20%"}
**Satellite & Aerial views:**

- Follow the invasion over time
- Go back in time
:::

::: {.absolute .fragment .fade-in fragment-index="16" top="50%"}
**Drone:**

- Flexibility to monitor the early stages of the invasion
- Offer an ultra high resolution
:::

## Objectives of the work {background-image="Images/Part2/Auray_20240407_2.png"}

::: {style="font-size: 70px; text-align: center; position: absolute; left: 50%; top: 44%; width: 1800px; transform: translate(-50%, -50%); color: black;"}

Make the first description of *G. vermiculophylla* spatial distribution using remote sensing techniques

:::

::: {style="font-size: 70px; text-align: center; position: absolute; left: 50%; top: 22%; width: 1800px; transform: translate(-50%, -50%); color: black;"}
Using RS archives to assess **historical** invasion in the Belon Estuary
:::

::: {style="font-size: 70px; text-align: center; position: absolute; left: 50%; top: 66%; width: 1800px; transform: translate(-50%, -50%); color: black;"}
Use **DISCOV** to map *G. vermiculophylla* and link its spatial distribution to the mudflat **topography**. 
:::


## Material & Methods {#material_part2}


::: {.fragment .fade-out fragment-index="3" }
::: {.absolute top="6.5%"}
*Historical analysis*
:::

::: {.absolute top="15%" left="0%"}

::: {.absolute bottom="-5%" left="5%"}
*Sciences et Techniques, Nantes, 1962*
:::

![](Images/Part2/IGNF_PVA_1-0__1962-08-01__C1223-0081_1962_FR454_0523.png){width="800"}
:::

::: {.absolute top="15%" left="40%"}

![](Images/Part2/remonterletemps.jpg){width="500"}
:::

::: {.absolute top="45%" left="37%" style="font-size: 60px;"}
Maps and Aerial photographs archives
:::

::: {.absolute top="60%" left="37%" style="font-size: 60px;"}
- 8 images between 1952 and 2012
- 1 Drone flight in 2024
:::

::: {.absolute bottom="5%" left="0%" .fragment .fade-in fragment-index="1" style="font-size: 60px;"}
Photo interpretation of images to retrieve the area covered by *G. vermiculophylla*
:::

::: {.absolute bottom="-8%" right="-7.6%"}
![](Images/Part2/Map_Belon.png){height="1400"}
:::
:::


::: {.absolute bottom="-8%" .fragment .fade-in fragment-index="3" right="-7.6%"}
![](Images/Part2/Map_Gracilaria_Drone.png){height="1400"}
:::

<!-- ::: {.absolute top="6.5%" .fragment .fade-in-then-out fragment-index="2"} -->
<!-- *Hyperspectral measurements* -->
<!-- ::: -->

<!-- ::: {.absolute top="15%" .fragment .fade-in-then-out fragment-index="2" style="font-size: 60px;"} -->
<!-- Same methodology as the spectral library -->
<!-- ::: -->

<!-- ::: {.absolute top="32%" left="10%" .fragment .fade-in-then-out fragment-index="2" style="font-size: 60px;"} -->
<!-- Second derivative: -->
<!-- ::: -->

<!-- :::{.absolute top="40%" left="20%" .fragment .fade-in-then-out fragment-index="2" style="font-size: 50px;"} -->
<!-- $$ -->
<!-- f''(\lambda_i) \approx \frac{f(\lambda_{i+1}) - 2f(\lambda_i) + f(\lambda_{i-1})}{(\Delta \lambda)^2} -->
<!-- $$  -->
<!-- ::: -->

::: {.absolute top="6.5%" .fragment .fade-in fragment-index="3"}
*Drone Mapping*
:::

::: {.absolute top="60%" left="10.5%" .fragment .fade-in-then-out fragment-index="3"}
DJI Matrice 300
:::

::: {.absolute top="10%" left="45%" .fragment .fade-in fragment-index="3" style="font-size: 50px;"}
4 Drone flight over *G. vermiculophylla*
:::


::: {.fragment .fade-out fragment-index="8"}
::: {.absolute top="15%" left="2%" .fragment .fade-in-then-out fragment-index="3"}


![](Images/Part2/Drone_lIDAR.png){height="600" .circular-fade}


:::

::: {.fragment .fade-out fragment-index="6"}
::: {.absolute top="60%" left="7%" .fragment .fade-in fragment-index="4"}
Micasense RedEdge-MX Dual
:::

::: {.absolute top="15%" left="2%" .fragment .fade-in fragment-index="4"}
![](Images/Part2/Drone_micasense2.png){height="600" .circular-fade}
:::
:::

::: {.absolute top="60%" left="11%" .fragment .fade-in fragment-index="6"}
DJI Zenmuse L1
:::

::: {.absolute bottom="10%" left="50%" .fragment .fade-in-then-out fragment-index="4"}
![](Images/Part2/micasense.png){height="400" }
:::

::: {.absolute top="15%" left="2%" .fragment .fade-in fragment-index="6"}
![](Images/Part2/Drone_lIDAR2.png){height="600" .circular-fade}
:::



::: {.absolute top="20%" left="45%" .fragment .fade-in fragment-index="4" style="font-size: 50px;"}
**2 Instruments: **

::: {.fragment .semi-fade-out fragment-index="6"}
- Multispectral camera
:::
:::

::: {.absolute top="33%" left="45%" .fragment .fade-in fragment-index="6" style="font-size: 50px;"}
- LiDAR
:::

::: {.absolute top="40%" left="40%" .fragment .fade-in-then-out fragment-index="4" style="font-size: 50px;"}
10 Spectral bands between 444 and 840 nm
:::

::: {.absolute top="70%" left="5%" .fragment .fade-in-then-out fragment-index="6" style="font-size: 50px;"}
- NIR LiDAR
- 240 000 points/s
- ~ 3cm accuracy
- High resolution RGB camera
:::

::: {.absolute top="70%" left="5%" .fragment .fade-in-then-out fragment-index="4" style="font-size: 50px;"}
![](Images/Part2/DISCOV_logoV2.png){height="500"}

:::

<!-- ::: {.absolute top="40%" left="35%" .fragment .fade-in-then-out fragment-index="5" width="1000px" style="font-size: 50px;"} -->
<!-- [ShinyValidate](https://oirysimon.shinyapps.io/shiny_validate/) -->



<!-- [*Presence and absence of red macroalgae for each drone flight*]{style="font-size: 30px;"} -->
<!-- ```{r Validation Table} -->
<!-- #| echo: false -->
<!-- #| cache: true -->
<!-- #| error: false -->
<!-- #| message: false -->
<!-- #| warning: false -->


<!-- library(tidyverse) -->
<!-- library(flextable) -->
<!-- library(sf) -->
<!-- library(officer) -->



<!-- df_flx_valid <- "Data/Part2/shp_all_validation.shp" %>% -->
<!--   # "Data/Shiny_Validation/shp_all_validation.shp" %>% -->
<!--   read_sf() %>%  -->
<!--   mutate(user = sapply(strsplit(user_date, "_"), function(x) x[1]), -->
<!--          site = sapply(strsplit(snapshot, "_"), function(x) x[1]), -->
<!--          site = case_when(site == "Aven" ~ "Aven Estuary", -->
<!--                           site == "Belon" ~ "Belon Estuary", -->
<!--                           site == "SajaNorth" ~ "Marisma de Cudón", -->
<!--                           site == "SajaSouth" ~ "Marisma de Cortiguera"), -->
<!--          PresenceAbs = case_when(Vegetation == "Red algae" ~ "Present", -->
<!--                                  T ~ "Absent")) %>%  -->
<!--   rename(Site = "site")  -->

<!-- total <- df_flx_valid %>%  -->
<!--   group_by(PresenceAbs) %>%  -->
<!--   reframe(n = n()) %>%  -->
<!--   pivot_wider(names_from = PresenceAbs, values_from = n) %>%  -->
<!--   mutate(Site = "Total") -->

<!-- table_data <- df_flx_valid %>%  -->
<!--   group_by(Site, PresenceAbs) %>%  -->
<!--   reframe(n = n()) %>%  -->
<!--   pivot_wider(names_from = "PresenceAbs", values_from = "n") %>%  -->
<!--   rbind(total) %>%  -->
<!--   rowwise() %>%  -->
<!--   mutate(Total = sum(c(Absent, Present))) -->

<!-- # Get the number of rows for the table data -->
<!-- n_rows <- nrow(table_data) -->

<!-- # Create the flextable with a horizontal line -->
<!-- table_data %>% -->
<!--   mutate( -->
<!--     Country = case_when( -->
<!--       Site %in% c("Marisma de Cortiguera", "Marisma de Cudón") ~ "Spain", -->
<!--       Site == "Total"                                   ~ " ", -->
<!--       TRUE                                              ~ "France" -->
<!--     ) -->
<!--   ) %>% -->
<!--   select(Country, everything()) %>% -->
<!--   flextable() %>% -->
<!--   align(align = "center", part = "all") %>% -->
<!--   fontsize(size = 30, part = "all") %>% -->
<!--   padding(padding = 6, part = "all") %>% -->
<!--   set_table_properties(layout = "autofit", width = 1) %>% -->
<!--   hline( -->
<!--     i = nrow(table_data) - 1, -->
<!--     border = fp_border(color = "black", width = 1), -->
<!--     part = "body" -->
<!--   ) -->
<!-- ``` -->

<!-- ::: -->

::: {.absolute bottom="0%" left="40%" .fragment .fade-in-then-out fragment-index="6"}


![](Images/Part2/LIDAR.png){height="700"}
:::

::: {.absolute bottom="0%" left="40%" .fragment .fade-in fragment-index="7"}
![](Images/Part2/DSM_DTM.png){height="400"}
:::

::: {.absolute top="40%" left="40%" .fragment .fade-in fragment-index="7" style="font-size: 50px;"}
Digital Surface Model: 

- Map of the Slope of the Mudflat
:::
:::


::: {.absolute top="25%" left="0%" .fragment .fade-in fragment-index="8" style="font-size: 60px;"}
**G**eneralised **L**inear **M**ixed **M**odel 
:::

::: {.absolute top="40%" left="10%" .fragment .fade-in fragment-index="8" style="font-size: 49px;"}

$$
\begin{align*}
\mathrm{Cover}_{ij} &\sim \mathrm{Beta}\bigl(\mu_{ij}\,\phi,\,(1-\mu_{ij})\,\phi\bigr),\\[1em]
\mu_{ij}           &= \mathrm{logit}(\eta_{ij}),               \\[1em]
\eta_{ij}          &=
  \underbrace{\alpha_j}_{\substack{\text{intercept for}\\\text{site }j}}
  + \underbrace{\beta_1\,\mathrm{Bathymetry}_{ij}}_{\text{effect of elevation}}
  + \underbrace{\beta_2\,\mathrm{Slope}_{ij}}_{\text{effect of slope}}.
\end{align*}
$$
:::

## Results {#results_part2}

```{r map plotting}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(sf)
library(terra)
library(tidyterra)

img_list <- list.files("Data/Part2/RemonterLeTemps", pattern = ".tif", full.names = T, include.dirs = F) %>% 
  as_tibble() %>% 
  rename(path ="value") %>% 
  dplyr::filter(!str_detect(path, "RAW")) %>% 
  mutate(filename = gsub(".*/","",path),
         source = case_when(str_detect(filename, "IGNF") ~ "IGN",
                          T ~ "Other"),
         year = as.integer(case_when(source == "IGN" ~ substr(filename,15,18),
                          T ~ substr(filename,1,4))))

mask <- "Data/Part2/RemonterLeTemps/shp/mask/IntertidalMask_Belon_RemonterLeTemps.shp" %>% 
  read_sf()

Pres_algae <- "Data/Part2/RemonterLeTemps/shp/shape_red_algae/Presence_Absence_RedAlgae_Date.shp" %>% read_sf()



Text_position <- data.frame(x = rep(ext(mask)[1]+0.9*(ext(mask)[2]-ext(mask)[1]),nrow(img_list)),
                            y = rep(ext(mask)[3]+0.9*(ext(mask)[4]-ext(mask)[3]),nrow(img_list)),
                            year = img_list$year)

for(i in 1:nrow(img_list)){
  

  img <- rast(img_list$path[i]) %>% 
    project(crs(mask)) %>% 
    crop(mask, mask = T)
  
  date_i <- Text_position[i,]
  # shp_i <- Pres_algae %>% 
  #   dplyr::filter(date == img_list$year[i])
  # 
  # if(img_list$year[i] == 2024){
  #   shp_i <- shp_i %>% 
  #     st_buffer(dist = 0.3) %>% 
  #     st_union()
  # }
  # 
  
Plot <-  
  if(nlyr(img) != 1){
    RGB(img)<-1:3
    
    ggplot()+
      geom_spatraster_rgb(data = img)
  }else{
    names(img) = "layer"
    ggplot()+
      geom_spatraster(img, mapping = aes(fill = layer), show.legend = F)+
      scale_fill_gradient(low = "black", high = "white", limits = c(0,240),na.value = NA, name = "Greyscale")
  }

a <- Plot +
    geom_text(data = date_i, aes(x = x, y = y, label = year),
              size = 7)+
  # geom_sf(data = shp_i, fill = NA, color = "darkred")+ 
   coord_sf(xlim = c(ext(mask)[1],ext(mask)[2]),
            ylim = c(ext(mask)[3],ext(mask)[4]),
            expand = F)+
    # geom_text(data = date_i, aes(x = x, y = y, label = year),
    #           size = 10)+
    theme_Bede()+
    # scale_x_continuous(breaks = seq(-8.75, -8.6, by = 0.1))+
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.clip = "inherit",
      panel.spacing = unit(0,"pt"), 
      plot.margin = unit(c(0, 0, 0, 0), "lines"))+
    if(img_list$year[i] == 2024){
    ggspatial::annotation_scale(location = "bl",
                                pad_y = unit(0.3, "cm"),
                                text_cex=1)
    }
  
  
a 
  
# ggsave(paste0("Images/Part2/subplot_remoterletemps/",img_list$year[i],".tif"),a, width = 10, height = 4.52, dpi = 400)


assign(paste0("plot_",as.character(img_list$year[i])),a)
  
}


# plot_all <- (plot_1952 + plot_1958)/
# (plot_1976 + plot_1978)/
# (plot_1982 + plot_1992)/
# (plot_1997 + plot_2012)/
# (plot_2019 + plot_2024)

plot_all <- (plot_1952 + plot_1958 + plot_1976)/
(plot_1978 + plot_1982 + plot_1992)/
(plot_1997 + plot_2012 + plot_2024)


ggsave("Images/Part2/Historical_maps.png",plot_all, width = 10, height = 4.52, dpi = 200)
# ggsave("Paper/Figures/Low_res/Historical_maps.png",plot_all, width = 10, height = 4.52, dpi = 200)

```

```{r map plotting GIF}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(sf)
library(terra)
library(tidyterra)

img_list <- list.files("Data/Part2/RemonterLeTemps", pattern = ".tif", full.names = T, include.dirs = F) %>% 
  as_tibble() %>% 
  rename(path ="value") %>% 
  dplyr::filter(!str_detect(path, "RAW")) %>% 
  mutate(filename = gsub(".*/","",path),
         source = case_when(str_detect(filename, "IGNF") ~ "IGN",
                          T ~ "Other"),
         year = as.integer(case_when(source == "IGN" ~ substr(filename,15,18),
                          T ~ substr(filename,1,4))))

mask <- "Data/Part2/RemonterLeTemps/shp/mask/IntertidalMask_Belon_RemonterLeTemps.shp" %>% 
  read_sf()

Pres_algae <- "Data/Part2/RemonterLeTemps/shp/shape_red_algae/Presence_Absence_RedAlgae_Date.shp" %>% read_sf()



Text_position <- data.frame(x = rep(ext(mask)[1]+0.9*(ext(mask)[2]-ext(mask)[1]),nrow(img_list)),
                            y = rep(ext(mask)[3]+0.9*(ext(mask)[4]-ext(mask)[3]),nrow(img_list)),
                            year = img_list$year)

for(i in 1:nrow(img_list)){
  

  img <- rast(img_list$path[i]) %>% 
    project(crs(mask)) %>% 
    crop(mask, mask = T)
  
  shp <- Pres_algae %>% 
    dplyr::filter(date == img_list$year[i])
  
  date_i <- Text_position[i,]
  # shp_i <- Pres_algae %>% 
  #   dplyr::filter(date == img_list$year[i])
  # 
  # if(img_list$year[i] == 2024){
  #   shp_i <- shp_i %>% 
  #     st_buffer(dist = 0.3) %>% 
  #     st_union()
  # }
  # 
  
Plot <-  
  if(nlyr(img) != 1){
    RGB(img)<-1:3
    
    ggplot()+
      geom_spatraster_rgb(data = img)
  }else{
    names(img) = "layer"
    ggplot()+
      geom_spatraster(img, mapping = aes(fill = layer), show.legend = F)+
      scale_fill_gradient(low = "black", high = "white", limits = c(0,240),na.value = NA, name = "Greyscale")
  }

a <- Plot +
    geom_text(data = date_i, aes(x = x, y = y, label = year),
              size = 7)
  
  if (nrow(shp)>0) {
  # a <- a + geom_sf(data = shp, fill = "darkred", alpha = 0.3)
  }

a <- a+
  # geom_sf(data = shp_i, fill = NA, color = "darkred")+ 
   coord_sf(xlim = c(ext(mask)[1],ext(mask)[2]),
            ylim = c(ext(mask)[3],ext(mask)[4]),
            expand = F)+
    # geom_text(data = date_i, aes(x = x, y = y, label = year),
    #           size = 10)+
    theme_Bede()+
    # scale_x_continuous(breaks = seq(-8.75, -8.6, by = 0.1))+
    theme(
      axis.text.x = element_text(size = 13),
      axis.text.y = element_text(size = 13),
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      strip.clip = "inherit",
      panel.spacing = unit(0,"pt"), 
      plot.margin = unit(c(0, 0, 0, 0), "lines"))+
    ggspatial::annotation_scale(location = "bl",
                                pad_y = unit(0.3, "cm"),
                                text_cex=1)
  
  
a 
  
ggsave(paste0("Images/Part2/subplot_remoterletemps/",img_list$year[i],".tif"),a, width = 10, height = 4.52, dpi = 400)


# assign(paste0("plot_",as.character(img_list$year[i])),a)
  
}


# plot_all <- (plot_1952 + plot_1958)/
# (plot_1976 + plot_1978)/
# (plot_1982 + plot_1992)/
# (plot_1997 + plot_2012)/
# (plot_2019 + plot_2024)

# plot_all <- (plot_1952 + plot_1958 + plot_1976)/
# (plot_1978 + plot_1982 + plot_1992)/
# (plot_1997 + plot_2012 + plot_2024)


# ggsave("Paper/Figures/High_res/Historical_maps.png",plot_all, width = 10, height = 4.52, dpi = 400)
# ggsave("Paper/Figures/Low_res/Historical_maps.png",plot_all, width = 10, height = 4.52, dpi = 200)

```

```{r area_each_year}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(sf)
library(Utilities.Package)

mask <- "Data/Part2/RemonterLeTemps/shp/mask/IntertidalMask_Belon_RemonterLeTemps.shp" %>% 
  read_sf() %>%
  mutate(area = st_area(.)) %>% 
  pull(as.numeric(area)[1])

Pres_algae <- "Data/Part2/RemonterLeTemps/shp/shape_red_algae/Presence_Absence_RedAlgae_Date.shp" %>% 
  read_sf() %>% 
  mutate(area = st_area(.)) %>% 
  group_by(date) %>% 
  reframe(area = sum (area)) %>% 
  mutate(prop = as.numeric((area/mask)*100)) %>% 
  dplyr::select(-area)

df <- data.frame(date = c(1952,1958),
           prop = c(0,0)) %>% 
  bind_rows(Pres_algae) %>% 
    mutate(prop = case_when(date == 2012 ~ 41.3,
                            date == 2024 ~ 41.8,
                            T ~ prop)) %>% 
    dplyr::filter(date != 2019)

for (i in unique(df$date)) {
  
 plot <- (df %>% 
     dplyr::filter(date <= i) %>%
   ggplot(aes(x = date, y = prop))+
     # geom_bar(stat = "identity",size = 10 )+
     geom_point(size = 4)+
     xlab("Year")+
     ylab(expression(bold(paste("Cover of ", bolditalic("Gracilaria"), " (%)"))))+
     
     geom_line(alpha = 0.4, linetype = "dashed")+
     geom_vline(xintercept = 1971, linetype = "dashed", color = "darkred", linewidth=1)+
     geom_vline(xintercept = 1994, linetype = "dashed", color = "goldenrod", linewidth=1)+
    xlim(c(1951,2024))+
    ylim(c(0,43))+

       geom_rug(sides = "b") +  # Add ticks at the bottom for each x-value
     geom_text(
       x = 1970, 
       y = 25, 
       label = expression(paste("First introduction of ", italic("C. gigas"))), 
       angle = 90
     )+
     geom_text(
       x = 1972, 
       y = 25, 
       label = expression(paste("in South Brittany")), 
       angle = 90
     )+
     geom_text(
       x = 1993, 
       y = 21, 
       label = expression(paste("First record of ", italic("G. vermiculophylla"))), 
       angle = 90
     )+
     geom_text(
       x = 1995, 
       y = 22, 
       label = expression(paste("in the Belon Estuary")), 
       angle = 90
     )+
     theme_Bede()+
     theme(axis.text.x = element_text(size = 10),
           axis.text.y = element_text(size = 10),
           axis.title.x = element_text(size = 15),
           axis.title.y = element_text(size = 15), 
           plot.background = element_rect(fill = "white", color = NA))
  )

  ggsave(paste0("Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_",i,".png"), plot, width = 10, height = 3.61, dpi = 200)

  
}


# ggsave("Images/Part2/Cover_Gracillaria_vs_Time.png", plot, width = 10, height = 4, dpi = 200)
# ggsave("Paper/Figures/Low_res/Cover_Gracillaria_vs_Time.png", plot, width = 10, height = 6, dpi = 200)

```

<!-- ::: {.absolute top="6.5%" .fragment .fade-out fragment-index="1"} -->
<!-- *Spectral signature of G. vermiculophylla* -->
<!-- ::: -->

<!-- ::: {.absolute top="15%" left="10%" .fragment .fade-out fragment-index="1"} -->
<!-- ![](Images/Part2/plot_spectral_signature.png){width="2000"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-out fragment-index="1" bottom="0%" left="20%"} -->
<!-- Average of ~ 100 spectra -->
<!-- ::: -->

::: {.fragment .fade-out fragment-index="16"}
::: {.absolute top="6.5%"}
*Historical records in the Belon estuary*
:::

::: {.absolute bottom="-8%" right="-7.6%"}
![](Images/Part2/Map_Belon.png){height="1400"}
:::
:::

::: {.absolute .fragment .fade-out fragment-index="2" top="15%" left="0%"}
![](Images/Part2/Historical_maps.png){width="2000"}
:::


::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="2"}
![](Images/Part2/subplot_remoterletemps/1958.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="2"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_1958.png){height="530"}
:::

::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="3"}
![](Images/Part2/subplot_remoterletemps/1976.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="3"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_1976.png){height="530"}
:::

::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="4"}
![](Images/Part2/subplot_remoterletemps/1982.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="4"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_1982.png){height="530"}
:::

::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="5"}
![](Images/Part2/subplot_remoterletemps/1992.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="5"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_1992.png){height="530"}
:::

::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="6"}
![](Images/Part2/subplot_remoterletemps/2012.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="6"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_2012.png){height="530"}
:::

::: {.absolute top="10%" left="10%" .fragment .fade-in-then-out fragment-index="7"}
![](Images/Part2/subplot_remoterletemps/2024.png){height="650"}
:::

::: {.absolute bottom="-5%" left="10%" .fragment .fade-in-then-out fragment-index="7"}
![](Images/Part2/plot_cover_year/Cover_Gracillaria_vs_Time_2024.png){height="530"}
:::

<!-- ::: {.fragment .fade-out fragment-index="16"} -->

<!-- ::: {.absolute top="6.5%" .fragment .fade-in fragment-index="8"} -->
<!-- *Drone flights* -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="8" bottom="-8%" right="-7.6%"} -->
<!-- ![](Images/Part2/Map_Saja.png){height="1400"} -->
<!-- ::: -->
<!-- ::: -->


<!-- ```{r DISCOV Saja Map} -->
<!-- #| echo: false -->
<!-- #| warning: false -->
<!-- #| eval: false -->

<!-- library(terra) -->
<!-- library(tidyverse) -->
<!-- library(Utilities.Package) -->
<!-- library(sf) -->



<!-- msk <- "Data/Part2/SajaSouth_32630.shp" %>%  -->
<!--   read_sf() -->

<!-- DISCOV_rast <- rast("Data/Part2/Saja/Saja_South_25062024_DISCOV_InvaSea_26112024_pred.tif") %>%  -->
<!--   project(crs(msk), method = "near") %>%  -->
<!--   crop(msk, mask = T) -->

<!-- img_filtered<-focal(DISCOV_rast, w=7, fun="modal",na.rm=TRUE) -->

<!-- writeRaster(img_filtered, "Data/Part2/Saja/Saja_South_25062024_DISCOV_InvaSea_26112024_pred_7.tif", overwrite = T) -->

<!-- values(img_filtered)[values(img_filtered) == 0] = NA -->
<!-- names(img_filtered) <- "layer" -->
<!-- img_filtered<-img_filtered %>%  -->
<!--   as.factor() -->



<!-- target_shp <- read_sf("Data/Part2/model_px_8m_saja.shp") -->

<!--  for (i in 1:nrow(target_shp)) { -->

<!--    shp <- target_shp[i,] -->

<!--    img_i <- img_filtered %>%  -->
<!--      crop(shp, mask = T) -->


<!--    plot_i <- -->
<!--   ggplot()+ -->
<!--   # scale_fill_manual("",  -->
<!--   #                   labels = c("Intertidal area", "Land area", "water"), -->
<!--   #                   values = c("white", "white","white"))+ -->
<!--   # geom_sf(data = background_GafHigh, -->
<!--   #         mapping = aes(fill = Type), -->
<!--   #         show.legend = F,  -->
<!--   #         linewidth=0.05, -->
<!--   #         alpha=0.4, -->
<!--   #         colour="grey30")+ -->
<!--   # geom_sf(data = background_GafHigh, -->
<!--   #         fill = "white", -->
<!--   #         show.legend = F,  -->
<!--   #         linewidth=0.05, -->
<!--   #         alpha=1, -->
<!--   #         colour="white")+ -->
<!--    ggnewscale::new_scale("fill")+ -->
<!--     tidyterra::geom_spatraster(data = img_i,  -->
<!--                                mapping = aes(fill = layer), -->
<!--                                maxcell = 500832*8, -->
<!--                                show.legend = F)+ -->
<!--   # geom_sf(data = zoom_extent,  -->
<!--   #         fill = "transparent",  -->
<!--   #         colour = "black", -->
<!--   #         linetype = "dashed",  -->
<!--   #         linewidth = 1.5)+ -->
<!--   # # coord_sf(crs = 4326)+ -->
<!--   # annotation_custom(ggplotGrob(Gafanha_low_pred_map_zoomed),  -->
<!--   #                   xmin = -8.7430, -->
<!--   #                   xmax=-8.7427,  -->
<!--   #                   ymin = 40.5977) + -->
<!--   # geom_path(aes(x,y,group=grp), -->
<!--   #           data = data.frame(x = c(-8.7432439,-8.743,-8.7432439,-8.743), -->
<!--   #                             y=c(40.5976275,40.5979,40.5975373,40.59771), -->
<!--   #                             grp=c(1,1,2,2)), -->
<!--             # linetype = "dashed", linewidth = 1.5)+ -->
<!--   scale_fill_manual(breaks = c(1,2,3,4,5,6,7,8), -->
<!--                     values=c("#DAA520", "#b3ff1a", "#389318","#5C2E1A","#b3002d","#A3A3A3","white", "#42c9bc"), -->
<!--                     na.value = NA, -->
<!--                     name = "", -->
<!--                     labels = c("Bacillariophyceae", -->
<!--                                "Chlorophyceae", -->
<!--                                "Magnoliopsida", -->
<!--                                "Phaeophyceae", -->
<!--                                "Rhodophyceae", -->
<!--                                "Sediment", -->
<!--                                "Sunglint", -->
<!--                                "Water"))+ -->
<!--   theme_void()+ -->
<!--      coord_sf(expand = F) -->



<!--    ggsave(paste0("Images/Part2/Pred_sample_Saja_", shp$Target,"_8m.png"), plot_i, height = 10, width = 10) -->
<!--  } -->






<!-- names(img_filtered) <- "layer" -->

<!-- DISCOV_Saja <- ggplot()+ -->
<!--     tidyterra::geom_spatraster(data = img_filtered,  -->
<!--                                mapping = aes(fill = layer), -->
<!--                                maxcell = 500832*8)+ -->
<!--   scale_fill_manual(breaks = c(1,2,3,4,5,6,8), -->
<!--                     values=c("#DAA520","#b3ff1a","#389318","#873e23","#b3002d","#a2a3a2","#42c9bc",NA,NA), -->
<!--                     na.value = NA, -->
<!--                     name = "DISCOV", -->
<!--                     labels = c("Bacillariophyceae", -->
<!--                                "Chlorophyceae", -->
<!--                                "Magnoliopsida", -->
<!--                                "Phaeophyceae", -->
<!--                                "Florideophyceae", -->
<!--                                "Sediment", -->
<!--                                "Water"))+ -->
<!--   # geom_text(aes(x =  ext(DISCOV_rast)[1]+0.04*(ext(DISCOV_rast)[2]-ext(DISCOV_rast)[1]), -->
<!--   #               y =  ext(DISCOV_rast)[4]-0.08*(ext(DISCOV_rast)[4]-ext(DISCOV_rast)[3]), -->
<!--   #               label = "A"), -->
<!--   #               size = 10)+ -->
<!--   coord_sf(expand = F, -->
<!--            xlim = ext(msk)[1:2], -->
<!--            ylim = ext(msk)[3:4])+ -->
<!--   theme_Bede_Map()+ -->
<!--   # coord_equal()+ -->
<!--    theme( -->
<!--      # axis.text.x = element_text(size = 10, angle = -20, color = NA,hjust = 0), -->
<!--          axis.text.y = element_text(size = 15), -->
<!--          axis.text.x = element_text(size = 15), -->
<!--          # axis.ticks.x = element_blank(), -->
<!--          axis.title = element_blank(), -->
<!--          plot.background = element_rect(fill = "white", color = NA), -->
<!--          legend.background = element_blank(), -->
<!--          legend.position = c(0.98,0.98), -->
<!--          legend.text = element_text(size = 15), -->
<!--          legend.key.size = unit(1,"cm")) -->

<!-- ggsave("Images/Part2/Saja_DISCOV.png",DISCOV_Saja,width = 10, height = 9, dpi = 400) -->


<!-- DISCOV_Saja_void <- ggplot()+ -->
<!--     tidyterra::geom_spatraster(data = img_filtered,  -->
<!--                                mapping = aes(fill = layer), -->
<!--                                maxcell = 500832*8)+ -->
<!--   scale_fill_manual(breaks = c(1,2,3,4,5,6,8), -->
<!--                     values=c("#DAA520","#b3ff1a","#389318","#873e23","#b3002d","#a2a3a2","#42c9bc",NA,NA), -->
<!--                     na.value = NA, -->
<!--                     name = "DISCOV", -->
<!--                     labels = c("Bacillariophyceae", -->
<!--                                "Chlorophyceae", -->
<!--                                "Magnoliopsida", -->
<!--                                "Phaeophyceae", -->
<!--                                "Florideophyceae", -->
<!--                                "Sediment", -->
<!--                                "Water"))+ -->
<!--   # geom_text(aes(x =  ext(DISCOV_rast)[1]+0.04*(ext(DISCOV_rast)[2]-ext(DISCOV_rast)[1]), -->
<!--   #               y =  ext(DISCOV_rast)[4]-0.08*(ext(DISCOV_rast)[4]-ext(DISCOV_rast)[3]), -->
<!--   #               label = "A"), -->
<!--   #               size = 10)+ -->
<!--   coord_sf(expand = F, -->
<!--            xlim = ext(msk)[1:2], -->
<!--            ylim = ext(msk)[3:4])+ -->
<!--   theme_Bede_Map()+ -->
<!--   # coord_equal()+ -->
<!--    theme( -->
<!--      # axis.text.x = element_text(size = 10, angle = -20, color = NA,hjust = 0), -->
<!--          axis.text.y = element_text(size = 15), -->
<!--          axis.text.x = element_text(size = 15), -->
<!--          # axis.ticks.x = element_blank(), -->
<!--          axis.title = element_blank(), -->
<!--          plot.background = element_rect(fill = "white", color = NA), -->
<!--          legend.background = element_blank(), -->
<!--          legend.position = c(0.98,0.98), -->
<!--          legend.text = element_text(size = 15), -->
<!--          legend.key.size = unit(1,"cm"))+ -->
<!--   theme_void() -->

<!-- ggsave("Images/Part2/Saja_DISCOV_void.png",DISCOV_Saja_void,width = 10, height = 9, dpi = 400) -->
<!-- ``` -->

<!-- ```{r RGB Saja} -->
<!-- #| echo: false -->
<!-- #| warning: false -->
<!-- #| eval: false -->

<!-- library(sf) -->
<!-- library(terra) -->
<!-- library(tidyverse) -->
<!-- library(Utilities.Package) -->

<!-- msk <- "Data/Part2/SajaSouth_32630.shp" %>%  -->
<!--   read_sf() -->

<!-- Saja_RGB <- "Data/Part2/Saja/SajaSouth_RGB_LIDAR2.tif" %>%  -->
<!--   rast() %>%  -->
<!--   crop(msk, mask = T) -->

<!-- # values(Belon_RGB[[1]])[values(Belon_RGB[[1]]) == 0] = NA -->

<!-- # RGB(Belon_RGB) <- 1:3 -->


<!-- lim_x<- c(as.numeric(ext(Saja_RGB)[1:2])) -->
<!-- lim_y<- c(as.numeric(ext(Saja_RGB)[3:4])) -->

<!-- # NAflag(Saja_RGB) <- 0 -->



<!-- target_shp <- read_sf("Data/Part2/model_px_8m_Saja.shp") -->

<!--  for (i in 1:nrow(target_shp)) { -->

<!--    shp <- target_shp[i,] -->

<!--    img_i <- Saja_RGB[[1:3]] %>%  -->
<!--      crop(shp, mask = T) -->

<!--    RGB(img_i) <- 1:3 -->

<!--    plot(img_i) -->

<!--    writeRaster(img_i,paste0("Images/Part2/RGB_sample_Saja_", shp$Target,"_8m.png"), overwrite = T) -->
<!--  } -->




<!-- RGB_Saja<- ggplot()+ -->
<!--    tidyterra::geom_spatraster_rgb(data = Saja_RGB, -->
<!--          r = 1, -->
<!--          g = 2, -->
<!--          b = 3, -->
<!--          maxcell = 4010533, -->
<!--          max_col_value = 255 -->
<!--          )+ -->
<!--   geom_text(aes(x =  ext(Saja_RGB)[1]+0.04*(ext(Saja_RGB)[2]-ext(Saja_RGB)[1]), -->
<!--                 y =  ext(Saja_RGB)[4]-0.08*(ext(Saja_RGB)[4]-ext(Saja_RGB)[3]), -->
<!--                 label = "B"), -->
<!--                 size = 10)+ -->
<!--     ggspatial::annotation_scale(location = "br", -->
<!--                                 pad_y = unit(0.5, "cm"), -->
<!--                                 text_cex=2)+ -->
<!--    theme_Bede_Map()+ -->
<!--   coord_sf(expand = F, -->
<!--            xlim = ext(msk)[1:2], -->
<!--            ylim = ext(msk)[3:4])+ -->
<!--   # coord_equal()+ -->
<!--    theme( -->
<!--      # axis.text.x = element_text(size = 10, angle = -20, color = NA,hjust = 0), -->
<!--          axis.text.y = element_text(size = 15), -->
<!--          axis.text.x = element_text(size = 15), -->
<!--          # axis.ticks.x = element_blank(), -->
<!--          axis.title = element_blank(), -->
<!--          plot.background = element_rect(fill = "white", color = NA), -->
<!--          legend.background = element_blank(), -->
<!--          legend.position = c(0.98,0.98), -->
<!--          legend.text = element_text(size = 15), -->
<!--          legend.key.size = unit(1,"cm")) -->


<!--  ggsave("Images/Part2/Saja_RGB.png",RGB_Saja,width = 10, height = 9, dpi = 400) -->


<!-- ``` -->

<!-- ::: {.fragment .fade-out fragment-index="12"} -->
<!-- ::: {.absolute .fragment .fade-in fragment-index="8" top="10%" left="0%"} -->
<!-- ![](Images/Part2/Saja_RGB.png){width="1500"} -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.redbox .absolute .fragment .fade-in-then-out fragment-index="9" top="61%" left="26%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="9" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="10%" style="font-size: 60px;"} -->
<!-- Chlorophyceae -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_Green_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.redbox .absolute .fragment .fade-in-then-out fragment-index="10" top="38%" left="26%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="5%" style="font-size: 60px;"} -->
<!-- Florideophyceae -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_Red_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.redbox .absolute .fragment .fade-in-then-out fragment-index="11" top="75.5%" left="50%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="11" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="15%" style="font-size: 60px;"} -->
<!-- Saltmarshes -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_saltmarsh_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.fragment .fade-out fragment-index="16"} -->
<!-- ::: {.absolute .fragment .fade-in fragment-index="12" top="10%" left="0%"} -->
<!-- :::{.absolute top="-3%" right="6%" style="font-size: 60px;"} -->
<!-- Presence/Absence of Red Algae: 91.1% -->
<!-- ::: -->

<!-- ![](Images/Part2/Saja_DISCOV.png){width="1500"} -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.blackbox .absolute .fragment .fade-in-then-out fragment-index="13" top="61%" left="26%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="13" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="10%" style="font-size: 60px;"} -->
<!-- Chlorophyceae -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_Green_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="13" top="55%" left="60%"} -->
<!-- ![](Images/Part2/Pred_sample_Saja_Green_8m.png){width="500"} -->
<!-- ::: -->



<!-- ::: {.whitebox .absolute .fragment .fade-in-then-out fragment-index="14" top="38%" left="26%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="14" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="5%" style="font-size: 60px;"} -->
<!-- Florideophyceae -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_Red_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="14" top="55%" left="60%"} -->
<!-- ![](Images/Part2/Pred_sample_Saja_Red_8m.png){width="500"} -->
<!-- ::: -->


<!-- ::: {.blackbox .absolute .fragment .fade-in-then-out fragment-index="15" top="75.5%" left="50%" width= "30px" height="30px"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="15" top="5%" left="60%"} -->
<!-- :::{.absolute bottom="-7%" left="15%" style="font-size: 60px;"} -->
<!-- Saltmarshes -->
<!-- ::: -->

<!-- ![](Images/Part2/RGB_sample_Saja_saltmarsh_8m.png){width="500"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="15" top="55%" left="60%"} -->
<!-- ![](Images/Part2/Pred_sample_Saja_saltmarsh_8m.png){width="500"} -->
<!-- ::: -->

::: {.fragment .fade-out fragment-index="18"}
<!-- ::: {.absolute .fragment .fade-in fragment-index="16" bottom="-8%" right="-7.6%"} -->
<!-- ![](Images/Part2/Map_Belon.png){height="1400"} -->
<!-- ::: -->

::: {.absolute top="6.5%" .fragment .fade-in fragment-index="16"}
*Topography of the mudflat*
:::

:::



```{r DISCOV Belon Map}
#| echo: false
#| warning: false
#| eval: false

library(terra)
library(tidyverse)
library(Utilities.Package)
library(sf)

msk <- "Data/Part2/Belon/Belon_32630.shp" %>% 
  read_sf()

DISCOV_rast <- rast("Data/Part2/Belon/Belon_1104_MS_DISCOV_InvaSea_26112024_pred.tif") %>% 
  project(crs(msk), method = "near") %>% 
  crop(msk, mask = T) %>% 
  focal(w=7, fun="modal",na.rm=TRUE)

writeRaster(DISCOV_rast, "Data/Part2/Belon/Belon_1104_MS_DISCOV_InvaSea_26112024_pred_7.tif")

values(DISCOV_rast)[values(DISCOV_rast) == 0] = NA
names(DISCOV_rast) <- "layer"
DISCOV_rast<-DISCOV_rast %>% 
  as.factor()

DISCOV_Belon <- ggplot()+
    tidyterra::geom_spatraster(data = DISCOV_rast, 
                               mapping = aes(fill = layer),
                               maxcell = 500832*8)+
  scale_fill_manual(breaks = c(1,2,3,4,5,6,8),
                    values=c("#DAA520","#b3ff1a","#389318","#873e23","#b3002d","#a2a3a2","#42c9bc",NA,NA),
                    na.value = NA,
                    name = "Classes",
                    labels = c("Bacillariophyceae",
                               "Chlorophyceae",
                               "Magnoliopsida",
                               "Phaeophyceae",
                               "Florideophyceae",
                               "Sediment",
                               "Water"))+
  # geom_text(aes(x =  ext(DISCOV_rast)[1]+0.04*(ext(DISCOV_rast)[2]-ext(DISCOV_rast)[1]),
  #               y =  ext(DISCOV_rast)[4]-0.08*(ext(DISCOV_rast)[4]-ext(DISCOV_rast)[3]),
  #               label = "A"),
  #               size = 10)+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  theme_Bede_Map()+
  # coord_equal()+
   theme(
     # axis.text.x = element_text(size = 10, angle = -20, color = NA,hjust = 0),
         axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         axis.title = element_blank(),
         plot.background = element_rect(fill = "white", color = NA),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))

ggsave("Images/Part2/Belon_DISCOV.png",DISCOV_Belon,width = 10, height = 4.44, dpi = 400)

DISCOV_Belon <- ggplot()+
    tidyterra::geom_spatraster(data = DISCOV_rast, 
                               mapping = aes(fill = layer),
                               maxcell = 500832*8,
                               show.legend = F)+
  scale_fill_manual(breaks = c(1,2,3,4,5,6,8),
                    values=c("#DAA520","#b3ff1a","#389318","#873e23","#b3002d","#a2a3a2","#42c9bc",NA,NA),
                    na.value = NA,
                    name = "Classes",
                    labels = c("Bacillariophyceae",
                               "Chlorophyceae",
                               "Magnoliopsida",
                               "Phaeophyceae",
                               "Florideophyceae",
                               "Sediment",
                               "Water"))+
  # geom_text(aes(x =  ext(DISCOV_rast)[1]+0.04*(ext(DISCOV_rast)[2]-ext(DISCOV_rast)[1]),
  #               y =  ext(DISCOV_rast)[4]-0.08*(ext(DISCOV_rast)[4]-ext(DISCOV_rast)[3]),
  #               label = "A"),
  #               size = 10)+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  theme_Bede_Map()+
  # coord_equal()+
   theme(
     # axis.text.x = element_text(size = 10, angle = -20, color = NA,hjust = 0),
         axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         axis.title = element_blank(),
         plot.background = element_rect(fill = "white", color = NA),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))+
  theme_void()

ggsave("Images/Part2/Belon_DISCOV_void.png",DISCOV_Belon,width = 10, height = 4.44, dpi = 400)
```

```{r RGB Belon}
#| echo: false
#| warning: false
#| eval: false

library(sf)
library(terra)
library(tidyverse)
library(Utilities.Package)

msk <- "Data/Part2/Belon/Belon_32630.shp" %>% 
  read_sf()

Belon_RGB <- "Data/Part2/Belon/Belon_RGB_MULTI.tif" %>% 
  rast() %>% 
  crop(msk, mask = T)

# values(Belon_RGB[[1]])[values(Belon_RGB[[1]]) == 0] = NA

# RGB(Belon_RGB) <- 1:3


lim_x<- c(as.numeric(ext(Belon_RGB)[1:2]))
lim_y<- c(as.numeric(ext(Belon_RGB)[3:4]))


 RGB_Belon<- ggplot()+
   tidyterra::geom_spatraster_rgb(data = Belon_RGB,
         r = 1,
         g = 2,
         b = 3,
         maxcell = 4010533
         )+
  # geom_text(aes(x =  ext(Belon_RGB)[1]+0.04*(ext(Belon_RGB)[2]-ext(Belon_RGB)[1]),
  #               y =  ext(Belon_RGB)[4]-0.08*(ext(Belon_RGB)[4]-ext(Belon_RGB)[3]),
  #               label = "B"),
  #               size = 10)+
    ggspatial::annotation_scale(location = "br",
                                pad_y = unit(0.7, "cm"),
                                text_cex=2)+
   theme_Bede_Map()+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  # coord_equal()+
   theme(axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         plot.background = element_rect(fill = "white", color = NA), 
         axis.title = element_blank(),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))

 
 ggsave("Images/Part2/Belon_RGB.png",RGB_Belon,width = 10, height = 4.44, dpi = 400)
  

```

```{r LiDAR DEM}
#| echo: false
#| warning: false
#| eval: false


library(terra)
library(tidyverse)
library(Utilities.Package)
library(scico)



msk <- "Data/Part2/Belon/Belon_DEM_32630.shp" %>% 
  read_sf()

DEM_rast <- rast("Data/Part2/Belon/Belon_DEM_LiDAR.tif") %>% 
  crop(msk, mask = T) %>% 
  terra::resample(Belon_RGB, method = "near")

p999 <- quantile(DEM_rast %>% as.data.frame() %>%  pull(Belon_DEM_LiDAR), probs = 0.999)

values(DEM_rast)[values(DEM_rast) > p999] = NA
values(DEM_rast)[values(DEM_rast) < 0] = NA

lim_x<- c(as.numeric(ext(Belon_RGB)[1:2]))
lim_y<- c(as.numeric(ext(Belon_RGB)[3:4]))


bathy_Belon <- ggplot()+
   # tidyterra::geom_spatraster_rgb(data = Belon_RGB,
   #       r = 1,
   #       g = 2,
   #       b = 3,
   #       maxcell = 1000,
   #       alpha = 0
   #       )+
    tidyterra::geom_spatraster(data = DEM_rast, 
                               mapping = aes(fill = Belon_DEM_LiDAR ),
                               maxcell = 500832)+
  scale_fill_scico(palette = "batlow", 
                   na.value = NA,
                   name = "Elevation",
                   breaks = c(0,1.5,3),
                   limits = c(0,3),
                   labels = c("0 m","1.5 m", "3 m")) +
  # geom_text(aes(x =  ext(Belon_RGB)[1]+0.04*(ext(Belon_RGB)[2]-ext(Belon_RGB)[1]),
  #               y =  ext(Belon_RGB)[4]-0.08*(ext(Belon_RGB)[4]-ext(Belon_RGB)[3]),
  #               label = "C"),
  #               size = 10)+
  theme_Bede_Map()+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  # coord_equal()+
   theme(axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         plot.background = element_rect(fill = "white", color = NA), 
         axis.title = element_blank(),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))

 ggsave("Images/Part2/Belon_Bathy.png",bathy_Belon,width = 10, height = 4.44, dpi = 400)
 
 bathy_Belon <- ggplot()+
   # tidyterra::geom_spatraster_rgb(data = Belon_RGB,
   #       r = 1,
   #       g = 2,
   #       b = 3,
   #       maxcell = 1000,
   #       alpha = 0
   #       )+
    tidyterra::geom_spatraster(data = DEM_rast, 
                               mapping = aes(fill = Belon_DEM_LiDAR ),
                               maxcell = 500832,
                               show.legend = F)+
  scale_fill_scico(palette = "batlow", 
                   na.value = NA,
                   name = "Elevation",
                   breaks = c(0,1.5,3),
                   limits = c(0,3),
                   labels = c("0 m","1.5 m", "3 m")) +
  # geom_text(aes(x =  ext(Belon_RGB)[1]+0.04*(ext(Belon_RGB)[2]-ext(Belon_RGB)[1]),
  #               y =  ext(Belon_RGB)[4]-0.08*(ext(Belon_RGB)[4]-ext(Belon_RGB)[3]),
  #               label = "C"),
  #               size = 10)+
  theme_Bede_Map()+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  # coord_equal()+
   theme(axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         plot.background = element_rect(fill = "white", color = NA), 
         axis.title = element_blank(),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))+
   theme_void()

 ggsave("Images/Part2/Belon_Bathy_void.png",bathy_Belon,width = 10, height = 4.44, dpi = 400)
 
 
 # nrow(DEM_rast %>%  as.data.frame() %>% dplyr::filter(!is.na(Belon_DEM_LiDAR)))

```

```{r map angle}
#| echo: false
#| warning: false
#| eval: false

msk <- "Data/Part2/Belon/Belon_DEM_32630.shp" %>% 
  read_sf()

Belon_RGB <- "Data/Part2/Belon/Belon_RGB_MULTI.tif" %>% 
  rast() %>% 
  crop(msk, mask = T)

DEM_rast <- rast("Data/Part2/Belon/Belon_DEM_LiDAR.tif") %>% 
  crop(msk, mask = T)

Angle_df<-read_csv("Data/Part2/FullDF_10timesResample_DEMSlope_PredPercent.csv") %>% 
  dplyr::filter(Site  == "Belon")

angle_rast <- Angle_df %>% 
  dplyr::select(x,y,Slope_Cat) %>% 
  mutate(Slope_Cat = case_when(Slope_Cat == "Slope" ~ 1,
                               Slope_Cat == "Flat" ~ 2,
                               Slope_Cat == "Vertical" ~ 3)) %>% 
  terra::rast(type="xyz", crs="EPSG:32630") %>% 
  crop(msk, mask = T) %>%
  as.factor()
  

angle_plot <- ggplot()+
  #   tidyterra::geom_spatraster(data = DEM_rast, 
  #                              mapping = aes(fill = Belon_DEM_LiDAR ),
  #                              maxcell = 100,
  #                              alpha=0, 
  #                              show.legend = F)+
  # scico::scale_fill_scico(palette = "batlow", na.value = NA,
  #                  name = "Bathymetry",
  #                  breaks = c(0,1.5,3),
  #                  limits = c(0,3),
  #                  labels = c("0 m","1.5 m", "3 m"))+
  # ggnewscale::new_scale_fill()+
  # geom_tile(Angle_df, mapping = aes(x = x, y = y, fill = Slope_Cat)) +
  tidyterra::geom_spatraster(data = angle_rast, 
                               mapping = aes(fill = Slope_Cat  ),
                               maxcell = 1310*581,
                               # alpha=0, 
                               show.legend = T)+
  scale_fill_manual(breaks = c(2,1,3),
                    values=c("#8E7CC3", "#76A5AF", "#93C47D"),
                    na.value = NA,
                    name = "Slope",
                    labels = c("Flat",
                               "Angled",
                               "Steep"))+
  # geom_sf(data = msk, fill = "white", color = "white",show.legend = F)+
  # geom_text(aes(x =  ext(Belon_RGB)[1]+0.04*(ext(Belon_RGB)[2]-ext(Belon_RGB)[1]),
  #               y =  ext(Belon_RGB)[4]-0.08*(ext(Belon_RGB)[4]-ext(Belon_RGB)[3]),
  #               label = "D"),
                # size = 10)+
  theme_Bede_Map()+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  # coord_equal()+
   theme(axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         plot.background = element_rect(fill = "white", color = NA), 
         axis.title = element_blank(),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))
 
ggsave("Images/Part2/Belon_angle.png",angle_plot,width = 10, height = 4.44, dpi = 400)

angle_plot <- ggplot()+
  #   tidyterra::geom_spatraster(data = DEM_rast, 
  #                              mapping = aes(fill = Belon_DEM_LiDAR ),
  #                              maxcell = 100,
  #                              alpha=0, 
  #                              show.legend = F)+
  # scico::scale_fill_scico(palette = "batlow", na.value = NA,
  #                  name = "Bathymetry",
  #                  breaks = c(0,1.5,3),
  #                  limits = c(0,3),
  #                  labels = c("0 m","1.5 m", "3 m"))+
  # ggnewscale::new_scale_fill()+
  # geom_tile(Angle_df, mapping = aes(x = x, y = y, fill = Slope_Cat)) +
  tidyterra::geom_spatraster(data = angle_rast, 
                               mapping = aes(fill = Slope_Cat  ),
                               maxcell = 1310*581,
                               # alpha=0, 
                               show.legend = F)+
  scale_fill_manual(breaks = c(2,1,3),
                    values=c("#8E7CC3", "#76A5AF", "#93C47D"),
                    na.value = NA,
                    name = "Slope",
                    labels = c("Flat",
                               "Angled",
                               "Steep"))+
  # geom_sf(data = msk, fill = "white", color = "white",show.legend = F)+
  # geom_text(aes(x =  ext(Belon_RGB)[1]+0.04*(ext(Belon_RGB)[2]-ext(Belon_RGB)[1]),
  #               y =  ext(Belon_RGB)[4]-0.08*(ext(Belon_RGB)[4]-ext(Belon_RGB)[3]),
  #               label = "D"),
  #               size = 10)+
  theme_Bede_Map()+
  coord_sf(expand = F,
           xlim = c(450180.4, 451247.2+18),
           ylim = c(5296561, 5297042))+
  # coord_equal()+
   theme(axis.text.y = element_text(size = 10, vjust=-8, hjust=0.5, angle = 90),
         axis.text.x = element_text(size = 10, vjust=8, hjust=0.5),
         axis.ticks.x = element_blank(),
         axis.ticks.y = element_blank(),
         plot.background = element_rect(fill = "white", color = NA), 
         axis.title = element_blank(),
         panel.background = element_blank(),  # No panel background
         legend.background = element_blank(),
         legend.position = c(0.98, 0.98),
         legend.text = element_text(size = 10),
         legend.key.size = unit(0.5, "cm"),
         plot.margin = margin(0, 0, -10, -10))+
  theme_void()
 
ggsave("Images/Part2/Belon_angle_void.png",angle_plot,width = 10, height = 4.44, dpi = 400)
```

::: {.fragment .fade-out fragment-index="18"}
::: {.absolute .fragment .fade-in fragment-index="16" top="10%" left="-5%"}
::: {.absolute top="-5%" right="5%"}
*RGB Composition*
:::

![](Images/Part2/Belon_RGB.png){height="600"}
:::

::: {.absolute .fragment .fade-in fragment-index="16" top="10%" right="-5%"}
::: {.absolute top="-5%" right="5%"}
*DISCOV Classification*
:::

![](Images/Part2/Belon_DISCOV.png){height="600"}
:::


::: {.absolute .fragment .fade-in fragment-index="16" bottom="-5%" left="-5%"}
::: {.absolute top="7%" right="20%"}
*DSM Color Composition*
:::

![](Images/Part2/Belon_Bathy.png){height="600"}
:::

::: {.absolute .fragment .fade-in fragment-index="16" bottom="-5%" right="-5%"}
::: {.absolute top="7%" right="20%"}
*Slope Categorized*
:::

![](Images/Part2/Belon_angle.png){height="600"}
:::
:::



::: {.absolute top="6.5%" .fragment .fade-in fragment-index="18"}
*Elevation vs Presence of Algae*
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="18" top="7%" left="-8%"}
![](Images/Part2/Belon_Bathy_slope_pred.gif){height="400"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="19" top="7%" left="-8%"}
![](Images/Part2/Belon_Bathy_slope_pred-Faded.png){height="400"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="20" top="7%" left="-8%"}
![](Images/Part2/Belon_Bathy_slope_pred.png){height="400"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="18" bottom="15%" right="-5%"}
![](Images/Part2/GAM_slope_cover.png){height="900"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="19" bottom="15%" right="-5%"}
![](Images/Part2/GAM_slope_cover_faded.png){height="900"}
:::

::: {.absolute .fragment .fade-in fragment-index="19" top="50%" left="0%"}
- Higher Cover on the Upper Intertidal
:::


::: {.absolute .fragment .fade-in fragment-index="20" bottom="15%" right="-5%"}
![](Images/Part2/GAM_slope_cover.png){height="900"}
:::

::: {.absolute .fragment .fade-in fragment-index="20" top="60%" left="0%"}
- The steeper the lower the cover
:::

## Discussion {#discussion_part2}


:::{.absolute .fragment .fade-out fragment-index="2" top="15%" left="45%" style="font-size: 50px;"}
**First map of the spatial distribution of *G. vermiculophylla*:**

-  It can create large monospecific meadows...
-  ... or be mixed with others intertidal vegetations
:::

:::{ .fragment .fade-out fragment-index="4"}
:::{.absolute .fragment .fade-in fragment-index="2" top="15%" left="45%" style="font-size: 50px;"}
**First map of the spatial distribution of *G. vermiculophylla***
:::

<!-- :::{.absolute .fragment .fade-in fragment-index="2" top="25%" left="45%" style="font-size: 50px;"} -->
<!-- **It has a unique composition of phycobilin pigments** -->
<!-- ::: -->

::: {.absolute top="6.5%"}
*Drone mapping G. vermiculophylla with machine learning*
:::

:::

::: {.absolute .fragment .fade-out fragment-index="2" top="15%" left="5%"}
![](Images/Part2/Saja_Belon_DISCOV_void.png){height="500"}
:::

::: {.absolute .fragment .fade-out fragment-index="2" bottom="0%" left="5%"}

:::{.absolute bottom="-5%" left="1%" style="color: black;"}
Saja estuary, Spain
:::
![](Images/Part2/Saja_2024.jpg){height="500"}
:::

::: {.absolute .fragment .fade-out fragment-index="2" bottom="0%" right="5%"}

:::{.absolute bottom="-5%" left="1%" style="color: black;"}
Belon estuary, France
:::

![](Images/Part2/Belon_042024.jpg){height="500"}
:::

::: {.fragment .fade-out fragment-index="2" style="position: absolute; top: 77%; left: 49.2%; transform: translate(-50%, -50%);"}
![](Images/Part2/DISCOV_logoV2.png){height="400"}
:::

<!-- :::{.absolute .fragment .fade-in-then-out fragment-index="1" top="25%" left="45%" style="font-size: 50px;"} -->
<!-- **It has a unique composition of phycobilin pigments, resulting in:** -->

<!-- - A unique spectral signature for the class -->
<!-- - Identification at the Class level by DISCOV. -->
<!-- - A potential need for hyperspectral resolution to increase taxonomic resolution. -->

<!-- ::: -->


```{r Resolution Red Algae}
#| echo: false
#| warning: false
#| eval: false

library(gganimate)
library(tidyverse)

rhodo <- "Data/Part1/BELON_STD.csv" %>%
    read.csv() %>% 
    dplyr::filter(Letter == "C") %>% 
    group_by(Wavelength) %>% 
    reframe(Rhodophyceae = mean(mean_STD))


# Apply Savitzky-Golay smoothing
# Choose polynomial order and window size
sgolay_order <- 2
sgolay_window <- 11  # Must be odd and >= order + 2

# Make sure window size is not larger than number of rows
sgolay_window <- min(sgolay_window, nrow(rhodo))
if (sgolay_window %% 2 == 0) sgolay_window <- sgolay_window - 1  # Ensure it's odd

rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)
rhodo$Rhodophyceae <- sgolayfilt(rhodo$Rhodophyceae, p = sgolay_order, n = sgolay_window)


ggplot(rhodo)+
  geom_line(aes(x = Wavelength, y = Rhodophyceae))

log_func <- function(x) {
  0.7 + 0.3 * log(x / 400) / log(900 / 400)
}

speclib <- "Data/Part1/spec_lib.csv" %>% 
    read.csv() %>% 
    select(-c(X,OSM,Bare.Sediment,Xanthophyceae)) %>% 
    left_join(rhodo, by = "Wavelength") %>%
    pivot_longer(-Wavelength, names_to = "Class",values_to = "Ref")  %>% 
    mutate(Class = case_when(Class == "Magnoliosida" ~ "C - Magnoliopsida",
                             Class == "Ulvophyceae" ~ "B - Chlorophyceae",
                             Class == "Rhodophyceae" ~ "E - Florideophyceae",
                             Class == "Bacillariophyceae" ~ "D - Bacillariophyceae",
                             Class == "Phaeophyceae" ~ "A - Phaeophyceae",
                             TRUE ~ Class)) %>% 
    group_by(Class) %>% 
    reframe(Wavelength = Wavelength,
            Ref = (Ref-min(Ref))/(max(Ref)-min(Ref))) %>% 
  mutate(Ref = case_when(Class == "B - Chlorophyceae" ~ log_func(Wavelength)*Ref,
                         T ~ Ref))
    
speclib$Class <- factor(speclib$Class, levels = c(
  "A - Phaeophyceae",
  "B - Chlorophyceae",
  "C - Magnoliopsida",
  "D - Bacillariophyceae",
  "E - Florideophyceae"
))

colscale <- c("D - Bacillariophyceae" = "#DAA520", 
              "B - Chlorophyceae" = "#b3ff1a", 
              "C - Magnoliopsida" = "#389318", 
              "A - Phaeophyceae" = "#873e23", 
              "E - Florideophyceae" = "#b3002d")



#### default plot

(init_plot <- speclib %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)")  +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)


####### Drone 
RSF_Drone <-read_csv("Data/Part2/band_function_Drone.csv") %>% 
  as_tibble() %>% 
  pivot_longer(-Wavelength, names_to = "Bands", values_to = "SRF") %>% 
  mutate(SRF = as.numeric(SRF))

Drone_Band_Max <- RSF_Drone %>% 
  group_by(Bands) %>% 
  dplyr::filter(SRF == max(SRF)) %>% 
  slice(1)

for (i in unique(RSF_Drone$Bands)) {
  
  band_i <- RSF_Drone %>% 
    dplyr::filter(Bands == i) %>% 
    dplyr::select(-Bands)
  
  Joined_lib_SRF <- speclib %>% 
    left_join(band_i, by = "Wavelength")
  
  Ref_Drone_band_i <- Joined_lib_SRF %>% 
    group_by(Class) %>% 
    reframe(Ref = weighted.mean(Ref,SRF)) %>% 
    mutate(Wavelength = Drone_Band_Max %>% dplyr::filter(Bands == i) %>% pull(Wavelength))
  
  if(i == "Coastal blue"){
    Ref_Drone = Ref_Drone_band_i
  }else{
    Ref_Drone = rbind(Ref_Drone,Ref_Drone_band_i)
  }
}

Ref_Drone <- Ref_Drone %>% 
  dplyr::filter(Wavelength > 400, 
                Wavelength < 900) %>% 
  group_by(Class) %>% 
  mutate(Ref = (Ref-min(Ref))/(max(Ref)-min(Ref)),
         Sensor = "Drone")



(init_plot_Drone <- Ref_Drone %>% 
  # dplyr::filter(Class %in% c("Chlorophyceae", "Magnoliopsida")) %>% 
  ggplot()+
    # geom_line(data = fade_class, mapping = aes(x = Wavelength, y = Ref, group = Class1), color = "grey", alpha = 0.2, linewidth = 1.5)+
    geom_line(aes(x = Wavelength, y = Ref, color = Class, group = Class), linewidth = 1.5)+

    scale_color_manual(values=colscale)+
    theme_Bede()+
  ylab("Standardised Reflectance") +
  xlab("Wavelength (nm)") +
    xlim(c(400,900))+
  theme(
    legend.position = c(0.15, 0.8),
    legend.text = element_text(size = 12),
    legend.text.align = 0,
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
)


##### ALL

speclib_Resampled <-  speclib %>% 
  mutate(Sensor = "ASD") %>% 
  rbind(Ref_Drone)
  # mutate(y = case_when(Sensor == "ASD" ~ 0,
  #                      Sensor == "Prisma" ~ 0.05,
  #                      Sensor == "Sentinel-2" ~ 0.1,
  #                      Sensor == "Pleiades" ~ 0.15))


unique(speclib_Resampled$Sensor)

speclib_Resampled$Sensor <- factor(speclib_Resampled$Sensor, levels = c(
  "ASD",
  "Drone"
))


Plot_animated_resampled <- speclib_Resampled %>% 
  mutate(Sensor_fading = Sensor) %>% 
  dplyr::filter(Class == "E - Florideophyceae") %>% 
  ggplot(aes(x = Wavelength, y = Ref, color = Sensor, group = Class)) +

    # Smooth transitioning spectra
    geom_line(
      linewidth = 1.5
    ) +

    # Text that only fades in/out
    geom_text(
      aes(x = 800, y = 0.05, label = Sensor, group = Sensor_fading),
      size = 10,
      inherit.aes = FALSE
    ) +

    # Small ticks at each Wavelength (bottom side only)
    geom_rug(
      aes(x = Wavelength, group = Class,color = Sensor,),
      sides = "b",           # bottom only
      # color = "red",
      length = unit(6, "pt"),
      linewidth = 1 # short tick
    ) +

    # Color scale and labels
    scale_color_manual(values = c("ASD" = "red", "Drone" = "goldenrod"),
                       name = "Sensor: ") +
    ylab("Standardised Reflectance") +
    xlab("Wavelength (nm)") +
    xlim(c(400, 900)) +

    # Animate sensor changes globally
    transition_states(Sensor,
                      transition_length = 5,
                      state_length = 30) +
    ease_aes("sine-in-out") +

    # Theme and styling
    theme_Bede() +
    theme(
      legend.position = c(0.15, 0.8),
      legend.text = element_text(size = 15),
      legend.title = element_text(size = 17),
      legend.key.size = unit(1,"cm"),
      legend.text.align = 0,
      axis.text.x = element_text(size = 15),
      axis.text.y = element_text(size = 15),
      axis.title.x = element_text(size = 17),
      axis.title.y = element_text(size = 17)
    )

rendered <- animate(Plot_animated_resampled, duration = 5, fps = 20, width = 9, height = 10, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))

anim_save("Images/Part2/Figure_SRF_RED.gif", animation = rendered)

```

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="15%" left="0%"} -->
<!-- ![](Images/Part2/Figure_SRF_RED.gif){height="1000"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" bottom="0%" left="40%"} -->

<!-- :::{.absolute bottom="-5%" left="1%" style="color: black;"} -->
<!-- *G. gracilis* -->
<!-- ::: -->

<!-- ![](Images/Part2/gracilis.png){.circular-fade height="400"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" bottom="0%" left="60%"} -->

<!-- :::{.absolute bottom="-5%" left="1%" style="color: black;"} -->
<!-- *G. vermiculophylla* -->
<!-- ::: -->

<!-- ![](Images/Part2/vermiculo.png){.circular-fade height="400"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" bottom="0%" left="80%"} -->

<!-- :::{.absolute bottom="-5%" left="1%" style="color: black;"} -->
<!-- *C. crispus* -->
<!-- ::: -->

<!-- ![](Images/Part2/chondrus.png){.circular-fade height="400"} -->
<!-- ::: -->



:::{.absolute .fragment .fade-in-then-out fragment-index="2" top="35%" left="45%" style="font-size: 50px;"}
**Distribution linked with the topography**

- Inhabit the upper intertidal
- Resistant to desiccation, light and salinity variations
:::

:::{.absolute .fragment .fade-in-then-out fragment-index="3" top="35%" left="45%" style="font-size: 50px;"}
**Distribution linked with the topography**

- Inhabit the upper intertidal
- Resistant to desiccation, light and salinity variations
- Inhabit flat areas...
- ...experiencing lower current velocity during tidal exchanges
:::

::: {.fragment .fade-out fragment-index="4"}
::: {.absolute .fragment .fade-in fragment-index="2" top="15%" left="-5%"}
![](Images/Part2/Belon_Bathy_slope_pred.gif){height="600"}
:::

::: {.absolute .fragment .fade-in fragment-index="2" bottom="0%" left="10%"}
![](Images/Part2/Drone_lIDAR2.png){.circular-fade height="450"}
:::
:::

::: {.absolute top="6.5%" .fragment .fade-in fragment-index="4"}
*Invasion phases*
:::

```{r area_each_year_disc}
#| echo: false
#| warning: false
#| eval: false

library(tidyverse)
library(sf)
library(Utilities.Package)

mask <- "Data/Part2/RemonterLeTemps/shp/mask/IntertidalMask_Belon_RemonterLeTemps.shp" %>% 
  read_sf() %>%
  mutate(area = st_area(.)) %>% 
  pull(as.numeric(area)[1])

Pres_algae <- "Data/Part2/RemonterLeTemps/shp/shape_red_algae/Presence_Absence_RedAlgae_Date.shp" %>% 
  read_sf() %>% 
  mutate(area = st_area(.)) %>% 
  group_by(date) %>% 
  reframe(area = sum (area)) %>% 
  mutate(prop = as.numeric((area/mask)*100)) %>% 
  dplyr::select(-area)

df <- data.frame(date = c(1952,1958),
           prop = c(0,0)) %>% 
  bind_rows(Pres_algae) %>% 
    mutate(prop = case_when(date == 2012 ~ 41.3,
                            date == 2024 ~ 41.8,
                            T ~ prop)) %>% 
    dplyr::filter(date != 2019)

# --- parameters ------------------------------------------------------------
k      <- 10    # steepness of the curve
t_mid  <- 0.4   # time of maximum growth rate (inflection point)
n_pts  <- 200   # resolution (number of points)

# --- generate the idealised invasion trajectory ----------------------------
curve_df <- tibble(
  t  = seq(0, 1, length.out = n_pts),                      # relative time (t0 -> tx)
  pc = 41.8 / (1 + exp(-k * (t - t_mid)))                  # percent cover
) %>% 
  mutate(t = v <- seq(from = 1971, to = 2024, length.out = 200))

df_line <- data.frame(
  x=c(1952,1971),
  y=c(0,0.752)
)

(plot <- df %>% 
     # dplyr::filter(date <= i) %>%
   ggplot(aes(x = date, y = prop))+     
    geom_line(data = curve_df, aes(x = t, y = pc),size = 1.2, colour = "orange", alpha = 0.5) +
    geom_line(data = df_line, aes(x = x, y = y),size = 1.2, colour = "orange", alpha = 0.5) +
     # geom_bar(stat = "identity",size = 10 )+
     geom_point(size = 4)+
     xlab("Year")+
     ylab(expression(bold(paste("Cover of ", bolditalic("Gracilaria"), " (%)"))))+
     
     geom_line(alpha = 0.4, linetype = "dashed")+
     geom_vline(xintercept = 1971, linetype = "dashed", color = "darkred", linewidth=1)+
     geom_vline(xintercept = 1994, linetype = "dashed", color = "goldenrod", linewidth=1)+
    xlim(c(1951,2024))+
    ylim(c(0,43))+

       geom_rug(sides = "b") +  # Add ticks at the bottom for each x-value
     geom_text(
       x = 1970, 
       y = 25, 
       label = expression(paste("First introduction of ", italic("C. gigas"))), 
       angle = 90
     )+
     geom_text(
       x = 1972, 
       y = 25, 
       label = expression(paste("in South Brittany")), 
       angle = 90
     )+
     geom_text(
       x = 1993, 
       y = 21, 
       label = expression(paste("First record of ", italic("G. vermiculophylla"))), 
       angle = 90
     )+
     geom_text(
       x = 1995, 
       y = 22, 
       label = expression(paste("in the Belon Estuary")), 
       angle = 90
     )+
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
  )

  ggsave(paste0("Images/Part2/Cover_Gracillaria_vs_Time_disc1.png"), plot, width = 10, height = 10, dpi = 200)
  
(plot2 <- df %>% 
     # dplyr::filter(date <= i) %>%
   ggplot(aes(x = date, y = prop))+
        geom_line(data = curve_df, aes(x = t, y = pc),size = 1.2, colour = "orange", alpha = 0.5) +

     # geom_bar(stat = "identity",size = 10 )+
     geom_point(size = 4)+
     geom_vline(xintercept = 1980, linetype = "twodash", colour = "darkgreen") +
    geom_text(x = 1974, y = 40,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +
     xlab("Year")+
     ylab(expression(bold(paste("Cover of ", bolditalic("Gracilaria"), " (%)"))))+
     
     geom_line(alpha = 0.4, linetype = "dashed")+
    xlim(c(1970,2024))+
    ylim(c(0,43))+

      geom_rug(sides = "b") +  # Add ticks at the bottom for each x-value
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
  )

  ggsave(paste0("Images/Part2/Cover_Gracillaria_vs_Time_disc2.png"), plot2, width = 10, height = 10, dpi = 200)
  
(plot3 <- df %>% 
     # dplyr::filter(date <= i) %>%
   ggplot(aes(x = date, y = prop))+
      geom_line(data = curve_df, aes(x = t, y = pc),size = 1.2, colour = "orange", alpha = 0.5) +

     # geom_bar(stat = "identity",size = 10 )+
     geom_point(size = 4)+
     geom_vline(xintercept = 1980, linetype = "twodash", colour = "darkgreen") +
    geom_text(x = 1974, y = 40,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_vline(xintercept = 2010, linetype = "twodash", colour = "darkorange") +
  geom_text(x = 1995, y = 40,  label = "Expansion Phase", colour = "darkorange",hjust = 0.5, vjust = 0.5, size = 10) +
     xlab("Year")+
     ylab(expression(bold(paste("Cover of ", bolditalic("Gracilaria"), " (%)"))))+
     
     geom_line(alpha = 0.4, linetype = "dashed")+
    xlim(c(1970,2024))+
    ylim(c(0,43))+

      geom_rug(sides = "b") +  # Add ticks at the bottom for each x-value
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
  )

  ggsave(paste0("Images/Part2/Cover_Gracillaria_vs_Time_disc3.png"), plot3, width = 10, height = 10, dpi = 200)
  
(plot4 <- df %>% 
     # dplyr::filter(date <= i) %>%
   ggplot(aes(x = date, y = prop))+
      geom_line(data = curve_df, aes(x = t, y = pc),size = 1.2, colour = "orange", alpha = 0.5) +

     # geom_bar(stat = "identity",size = 10 )+
     geom_point(size = 4)+
     geom_vline(xintercept = 1980, linetype = "twodash", colour = "darkgreen") +
    geom_text(x = 1974, y = 40,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_vline(xintercept = 2010, linetype = "twodash", colour = "darkorange") +
  geom_text(x = 1995, y = 40,  label = "Expansion Phase", colour = "darkorange",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_text(x = 2017, y = 40,  label = "Saturation", colour = "darkred",hjust = 0.5, vjust = 0.5, size = 10) +
     xlab("Year")+
     ylab(expression(bold(paste("Cover of ", bolditalic("Gracilaria"), " (%)"))))+
     
     geom_line(alpha = 0.4, linetype = "dashed")+
    xlim(c(1970,2024))+
    ylim(c(0,43))+

      geom_rug(sides = "b") +  # Add ticks at the bottom for each x-value
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
  )

  ggsave(paste0("Images/Part2/Cover_Gracillaria_vs_Time_disc4.png"), plot4, width = 10, height = 10, dpi = 200)

  

  



# ggsave("Images/Part2/Cover_Gracillaria_vs_Time.png", plot, width = 10, height = 4, dpi = 200)
# ggsave("Paper/Figures/Low_res/Cover_Gracillaria_vs_Time.png", plot, width = 10, height = 6, dpi = 200)

```

```{r invasion phases}
#| echo: false
#| warning: false
#| eval: false


# tidyverse includes ggplot2, dplyr, tibble, etc.
library(tidyverse)

# --- parameters ------------------------------------------------------------
k      <- 10    # steepness of the curve
t_mid  <- 0.5   # time of maximum growth rate (inflection point)
n_pts  <- 200   # resolution (number of points)

# --- generate the idealised invasion trajectory ----------------------------
curve_df <- tibble(
  t  = seq(0, 1, length.out = n_pts),                      # relative time (t0 -> tx)
  pc = 40 / (1 + exp(-k * (t - t_mid)))                  # percent cover
)

# --- plot ------------------------------------------------------------------
(plot <- ggplot(curve_df, aes(t, pc)) +
  geom_line(size = 1.2, colour = "orange") +
  geom_vline(xintercept = c(0, 1), linetype = "dashed", colour = "darkorange") +
  annotate("text", x = 0, y = 40,  label = "Introduction", angle = 90,hjust = 0, vjust = 0, parse = TRUE, size = 10) +
  annotate("text", x = 1, y = 65, label = "Established", angle = 90, hjust = 1, vjust = 1, parse = TRUE, size = 10) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c(expression(T[0]), expression(T[x]))
  ) +
  labs(
    x = "Time",
    y = "Percent of maximum extent (%)",
  ) +
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
)
  ggsave(paste0("Images/Part2/Idealised_phases.png"), plot, width = 10, height = 10, dpi = 200)
  
  # --- plot ------------------------------------------------------------------
(plot2 <- ggplot(curve_df, aes(t, pc)) +
  geom_line(size = 1.2, colour = "orange") +
  geom_vline(xintercept = c(0, 1), linetype = "dashed", colour = "darkorange") +
  geom_vline(xintercept = 0.25, linetype = "twodash", colour = "darkgreen") +
  geom_text(x = 0.125, y = 90,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +

  annotate("text", x = 0, y = 40,  label = "Introduction", angle = 90,hjust = 0, vjust = 0, parse = TRUE, size = 10) +
  annotate("text", x = 1, y = 65, label = "Established", angle = 90, hjust = 1, vjust = 1, parse = TRUE, size = 10) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c(expression(T[0]), expression(T[x]))
  ) +
  labs(
    x = "Time",
    y = "Percent of maximum extent (%)",
  ) +
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
)
  ggsave(paste0("Images/Part2/Idealised_phases2.png"), plot2, width = 10, height = 10, dpi = 200)
  
    # --- plot ------------------------------------------------------------------
(plot3 <- ggplot(curve_df, aes(t, pc)) +
  geom_line(size = 1.2, colour = "orange") +
  geom_vline(xintercept = c(0, 1), linetype = "dashed", colour = "darkorange") +
  geom_vline(xintercept = 0.25, linetype = "twodash", colour = "darkgreen") +
  geom_text(x = 0.125, y = 90,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_vline(xintercept = 0.75, linetype = "twodash", colour = "darkorange") +
  geom_text(x = 0.5, y = 90,  label = "Expansion Phase", colour = "darkorange",hjust = 0.5, vjust = 0.5, size = 10) +

  annotate("text", x = 0, y = 40,  label = "Introduction", angle = 90,hjust = 0, vjust = 0, parse = TRUE, size = 10) +
  annotate("text", x = 1, y = 65, label = "Established", angle = 90, hjust = 1, vjust = 1, parse = TRUE, size = 10) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c(expression(T[0]), expression(T[x]))
  ) +
  labs(
    x = "Time",
    y = "Percent of maximum extent (%)",
  ) +
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
)
  ggsave(paste0("Images/Part2/Idealised_phases3.png"), plot3, width = 10, height = 10, dpi = 200)
  
(plot4 <- ggplot(curve_df, aes(t, pc)) +
  geom_line(size = 1.2, colour = "orange") +
  geom_vline(xintercept = c(0, 1), linetype = "dashed", colour = "darkorange") +
  geom_vline(xintercept = 0.25, linetype = "twodash", colour = "darkgreen") +
  geom_text(x = 0.125, y = 90,  label = "Lag Phase", colour = "darkgreen",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_vline(xintercept = 0.75, linetype = "twodash", colour = "darkorange") +
  geom_text(x = 0.5, y = 90,  label = "Expansion Phase", colour = "darkorange",hjust = 0.5, vjust = 0.5, size = 10) +
  geom_text(x = 0.75+0.125, y = 90,  label = "Saturation", colour = "darkred",hjust = 0.5, vjust = 0.5, size = 10) +

  annotate("text", x = 0, y = 40,  label = "Introduction", angle = 90,hjust = 0, vjust = 0, parse = TRUE, size = 10) +
  annotate("text", x = 1, y = 65, label = "Established", angle = 90, hjust = 1, vjust = 1, parse = TRUE, size = 10) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c(expression(T[0]), expression(T[x]))
  ) +
  labs(
    x = "Time",
    y = "Percent of maximum extent (%)",
  ) +
     theme_Bede()+
     theme(axis.text.x = element_text(size = 15),
           axis.text.y = element_text(size = 15),
           axis.title.x = element_text(size = 20),
           axis.title.y = element_text(size = 20), 
           plot.background = element_rect(fill = "white", color = NA))
)
  ggsave(paste0("Images/Part2/Idealised_phases4.png"), plot4, width = 10, height = 10, dpi = 200)
```

::: {.absolute .fragment .fade-in-then-out fragment-index="4" top="15%" left="0%"}
![](Images/Part2/Cover_Gracillaria_vs_Time_disc.png){width="1200"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="5" top="15%" left="0%"}
![](Images/Part2/Cover_Gracillaria_vs_Time_disc1.png){width="1200"}
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="15%" left="0%"}
![](Images/Part2/Cover_Gracillaria_vs_Time_disc2.png){width="1200"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="15%" left="0%"}
![](Images/Part2/Cover_Gracillaria_vs_Time_disc3.png){width="1200"}
:::

::: {.absolute .fragment .fade-in fragment-index="8" top="15%" left="0%"}
![](Images/Part2/Cover_Gracillaria_vs_Time_disc4.png){width="1200"}
:::

::: {.fragment .fade-out fragment-index="9"}
::: {.absolute  top="20%" left="50%" .fragment .fade-in fragment-index="6"}
**Lag Phase**

- Very low abundance
- Need for genetic or mutualistic adjustment
:::

::: {.absolute top="45%" left="50%" .fragment .fade-in fragment-index="7"}
**Expansion Phase**

- Near‑exponential increase in cover 
- Control effort and cost rise sharply
:::

::: {.absolute top="70%" left="50%" .fragment .fade-in fragment-index="8"}
**Saturation Phase**

- Percent cover reaches a plateau, growth limited by space/resources
- Ecosystem impacts stabilise but persist
:::
:::

::: {.absolute bottom="0%" right="0%" .fragment .fade-in fragment-index="5" style="font-size: 30px;"}
Sources: [Morris et al. (2013)](https://doi.org/10.1016/j.jaridenv.2013.03.013), [Harvey & Mazzotti (2014)](https://edis.ifas.ufl.edu/publication/UW392), [Ahmed et al. (2022)](https://doi.org/10.1007/s10530-022-02755-0), [Kelly et al. (2021)](https://doi.org/10.1002/ece3.7352)
:::


::: {.absolute top="25%" left="55%" .fragment .fade-in-then-out fragment-index="9"}
**Short Lag phase**

- Large number of fragments/individuals has been introduced repeatedly in the environment
- *G. vermiculophylla* is well adapted to European estuaries and already suited to local climate
- Not grazed by native species
:::

::: {.absolute top="65%" left="55%" .fragment .fade-in-then-out fragment-index="9"}
**Remote Sensing can monitor early stages of the invasion...**

- Making it a powerful tool for early decision making
- Facilitates timely interventions 
:::


# Case Study 2 – Mapping the impact of Heatwaves on intertidal seagrasses {data-stack-name="Marine Heatwaves" background-image="Images/Part3/Background_Part3.png"}

- [Introduction](#intro-part3)
- [Material & Methods](#material_part3)
- [Results](#results_part3)
- [Discussion](#discussion_part3)

## Introduction {#intro-part3}

::: {.fragment .fade-out fragment-index="1"}
::: {.absolute top="6.5%"}
*Browning of seagrasses across Europe*
:::
  
::: {.absolute bottom="0%" left="0%"}
![](Images/Part3/Darkseagrass_quiberon.jpg){height="1100"}
:::
  
::: {.absolute bottom="0%" left="25%"}
![](Images/Part3/Green_seagrass_Quiberon.jpg){height="1100"}
:::
  
:::{.absolute top="15%" left="50%"}
*Quiberon, France, September 2021*
:::
  
::: {.absolute top="21%" left="50%"}
![](Images/Part3/Logo_Biolittoral.png){height="80"}
:::

::: {.absolute bottom="0%" right="-5%"}

![](Images/Part3/plot_temp2.png){height="850"}
:::
:::

::: {.fragment .fade-out fragment-index="7"}

::: {.absolute .fragment .fade-in fragment-index="1" top="6.5%"}
*What's in the literature ?*
:::


::: {.absolute .fragment .fade-in top="15%" left="0%" fragment-index="1"}
![](Images/Part3/Paper_intro1.png){height="200"}
:::

::: {.absolute .fragment .fade-in top="35%" left="0%" fragment-index="1"}
![](Images/Part3/Paper_intro2.png){height="200"}
:::

::: {.absolute .fragment .fade-in top="55%" left="0%" fragment-index="1"}
![](Images/Part3/Paper_intro31.png){height="200"}
:::

::: {.absolute .fragment .fade-in top="75%" left="0%" fragment-index="1"}
![](Images/Part3/Paper_intro4.png){height="200"}
:::


::: {.absolute .fragment .fade-in fragment-index="1" top="10%" left="30%" style="font-size: 50px;"}
On subtidal *Zostera marina* and *Cymodocea nodosa*: 
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="2" width="1200" top="15%" left="35%" style="font-size: 50px;"}
- Highly vulnerable to elevated sea temperatures in winter and spring, leading to early flowering, high mortality, and reduced biomass.

:::

::: {.absolute .fragment .fade-in-then-out fragment-index="3" width="1200" top="15%" left="35%" style="font-size: 50px;"}
- Highly vulnerable to elevated sea temperatures in winter and spring, leading to early flowering, high mortality, and reduced biomass.
- Photosynthetic activity rises during HWs but diminishes during recovery, impairing performance and reducing leaf biomass.
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="4" width="1200" top="15%" left="35%" style="font-size: 50px;"}
- Highly vulnerable to elevated sea temperatures in winter and spring, leading to early flowering, high mortality, and reduced biomass.
- Photosynthetic activity rises during HWs but diminishes during recovery, impairing performance and reducing leaf biomass.
- Responses vary greatly between species...
:::

::: {.absolute .fragment .fade-in fragment-index="5" width="1200" top="15%" left="35%" style="font-size: 50px;"}
- Highly vulnerable to elevated sea temperatures in winter and spring, leading to early flowering, high mortality, and reduced biomass.
- Photosynthetic activity rises during HWs but diminishes during recovery, impairing performance and reducing leaf biomass.
- Responses vary greatly between species...
- ...and within a single species across latitudes.
:::

::: {.absolute .fragment .fade-in fragment-index="6" bottom="25%" left="30%" style="font-size: 75px;"}
What about *Zostera noltei* ?  
:::

::: {.absolute .fragment .fade-in fragment-index="6" bottom="15%" left="30%" style="font-size: 75px;"}
Impact on the reflectance ? 
:::

::: {.absolute .fragment .fade-in fragment-index="6" bottom="5%" left="30%" style="font-size: 75px;"}
Impact of Extreme Atmospheric temperature ? 
:::

:::

::: {.fragment .fade-out fragment-index="10"}

::: {.absolute .fragment .fade-in fragment-index="7" top="6.5%"}
*Extreme Temperature Events = Heatwaves*
:::

::: {.absolute .fragment .fade-in fragment-index="7" top="10%" left="10%"}
![](Images/Part3/Paper_intro5.png){height="300"}
:::

::: {.absolute .fragment .fade-in fragment-index="7" top="10%" right="0%"}
![](Images/Part3/Paper_intro6.png){height="300"}
:::
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="8" top="36%" left="5%" style="font-size: 50px; text-align: center;"}
Defined as periods of three or more consecutive days where the daily maximum temperature (Tmax) exceeds the calendar-day 90th percentile based on at least 30 years
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="9" top="36%" left="5%" style="font-size: 50px; text-align: center;"}
Defined as periods of three or more consecutive days where the daily maximum temperature (Tmax) exceeds the calendar-day 90th percentile based on at [least 30 years]{style="color: red;"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="10" top="36%" left="5%" style="font-size: 50px; text-align: center;"}
Defined as periods of three or more consecutive days where the daily maximum temperature (Tmax) exceeds the [calendar-day 90th percentile]{style="color: red;"} based on at least 30 years
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="11" top="36%" left="5%" style="font-size: 50px; text-align: center;"}
Defined as periods of three or more consecutive days where the [daily maximum temperature (Tmax)]{style="color: red;"} exceeds the calendar-day 90th percentile based on at least 30 years
:::

::: {.fragment .fade-out fragment-index="13"}
::: {.absolute .fragment .fade-in fragment-index="12" top="36%" left="5%" style="font-size: 50px; text-align: center;"}
Defined as periods of [three or more consecutive days]{style="color: red;"} where the daily maximum temperature (Tmax) exceeds the calendar-day 90th percentile based on at least 30 years
:::
:::

::: {.absolute .fragment .fade-in-then-out bottom="0%" left="5%" fragment-index="9"}
![](Images/Part3/plot_temp_timeserie.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out bottom="0%" left="5%" fragment-index="10"}
![](Images/Part3/plot_temp_mean.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out bottom="0%" left="5%" fragment-index="11"}
![](Images/Part3/plot_Tmax.png){height="600"}
:::

::: {.absolute .fragment .fade-in-then-out bottom="0%" left="5%" fragment-index="12"}
![](Images/Part3/plot_Tmax_flame.png){height="600"}
:::

::: {.absolute .fragment .fade-in fragment-index="13" top="6.5%"}
*Hypothesis & Objectives*
:::


::: {.absolute top="15%" .fragment .fade-in fragment-index="13" style="font-size: 75px;"}
Heatwaves alter the spectral reflectance of *Zostera noltei* seagrass. This change can be detected using remote sensing. 
:::

::: {.absolute .incremental .fragment .fade-in fragment-index="13" top="33%" style="font-size: 75px;"}
- Evaluate the direct impact of heatwave-induced **thermal stress** on the reflectance of *Zostera noltei* through **controlled experiments**.
- Develop a **spectral index** for detecting stress-induced changes in seagrass coloration. 
- To apply findings from experimental reflectance changes to **satellite-based** remote sensing, assessing the spatial extent and temporal dynamics of an heatwave event that occurs in September 2021, in Quiberon, on seagrass meadows.
:::

## Material & Methods {#material_part3}

::: {.absolute .fragment .fade-out fragment-index="7" top="6.5%"}
*Experiment in the Lab*
:::

::: {.fragment .fade-out fragment-index="5"}
::: {.absolute  top="16%" left="0%" style="font-size: 40px;"}
*Intertidal chambers from ElectricBlue*
:::
:::

::: {.absolute .fragment .fade-out fragment-index="2" top="20%" left="0%"}
![](Images/Part3/Intertidal_Chambers.png){height="700"}
:::

::: {.absolute .fragment .fade-out fragment-index="2" top="20%" right="0%"}
![](Images/Part3/Benthic_chamber1.jpg){height="850"}
:::

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="20%" left="0%"} -->
<!-- ![](Images/Part3/Intertidal_Chambers2.png){height="700"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="40%" left="60%" style="font-size: 80px; color: rgba(54, 128, 74,1);"} -->
<!-- Experiment Tank -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="50%" left="60%" style="font-size: 80px; color: rgba(125, 52, 64,1);"} -->
<!-- Storage Tank -->
<!-- ::: -->

::: {.fragment .fade-out fragment-index="5"}

  <div class="absolute fragment fade-in" data-fragment-index="2" style="top: 20%; left: 0%; ">
  <video id="droneVideo" muted autoplay height="700">
    <source src="Video/Part3/Benthic_Chamber.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  </div>
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="30%" left="55%" style="font-size: 60px;"}
- Air Temperature : from 18 to 60°C
- Water Temperature : from 8°C to 55°C
- Programmable tides
- Programmable lights
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="3" top="10%" left="55%"}
![](Images/Part3/ASD_Intertidal_Chambers.jpg){height="1000"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="3" top="30%" left="75%" style="font-size: 60px;"}
Measure variation of seagrass leaves reflectance over time. 
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="3" top="10%" left="75%"}
![](Images/Part3/ASD.png){height="150"}
:::



::: {.fragment .fade-out fragment-index="7"}
::: {.absolute top="16%" left="0%" .fragment .fade-in fragment-index="5" style="font-size: 40px;"}
*Seagrasses inside of a chamber*
:::
::: {.absolute top="20%" left="0%" .fragment .fade-in fragment-index="5"}
<video src="Video/Part3/Seagrass_inside_chambers2.mp4" height="700" autoplay loop muted playsinline></video>
:::
:::

 <div class="absolute fragment fade-in-then-out" data-fragment-index="5" style="top: 5%; left: 55%; ">
 <video id="SamplingBox" muted autoplay height="1300">
   <source src="Video/Part3/Sampling_Box.mp4" type="video/mp4">
   Your browser does not support the video tag.
 </video>
 </div>
 
::: {.rotate-img2 .fragment .fade-in-then-out fragment-index="6" .absolute top="30%" left="50%"}
![](Images/Part3/Arrow_right_short.png){width="250"}
:::

::: {.rotate-img1 .fragment .fade-in-then-out fragment-index="6" .absolute top="56%" left="50%"}
![](Images/Part3/Arrow_right_short.png){width="250"}
:::

::: {.fragment .fade-in-then-out fragment-index="6" .absolute top="11%" right="0%"}
![](Images/Part3/Control_Profile.png){width="1000"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="80%" left="0%" style="font-size: 60px;"}
Hyperspectral measurement every minute in each tank
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="5%" left="75%" style="font-size: 60px;"}
Control
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="6" top="50%" left="75%" style="font-size: 60px;"}
Treatment
:::


::: {.fragment .fade-in-then-out fragment-index="6" .absolute bottom="11%" right="0%"}
![](Images/Part3/Test_Profile.png){width="1000" id="profile-image"}
:::



<!-- ::: {.fragment .fade-out fragment-index="15"} -->
<!-- ::: {.absolute .fragment .fade-in fragment-index="11" top="10%" left="0%" style="text-align: right; font-size: 70px;"} -->
<!-- - Litto3D product -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="11" top="20%" left="0%" style="text-align: right; font-size: 60px;"} -->
<!-- detailed 3D coastal and nearshore mapping -->
<!-- ::: -->


<!-- ::: {.absolute .fragment .fade-in fragment-index="11" left="0%" top="30%"} -->
<!-- ```{r LeafletLitto3D} -->
<!-- #| echo: false -->
<!-- #| eval: false -->
<!-- #| warning: false -->
<!-- #| out-width: "1100px" -->
<!-- #| out-height: "800px" -->

<!-- library(tidyverse) -->
<!-- library(leaflet) -->
<!-- library(sf) -->
<!-- library(leafem) -->
<!-- library(leaflet.extras2) -->
<!-- library(terra) -->

<!-- Quiberon_Litto3D <- "Data/Part3/Litto_10m_merged_32630.tif" %>%  -->
<!--   rast() %>%  -->
<!--   project(crs("EPSG:4326")) -->

<!-- pal2 <- colorNumeric("viridis", domain = values(Quiberon_Litto3D),na.color = "transparent") -->

<!-- Plot_Bathy <- leaflet() %>%    -->
<!--   # addTiles() %>%  -->
<!--   setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%  -->
<!--   addMapPane("right", zIndex = 0) %>% -->
<!--   addMapPane("left", zIndex = 0) %>% -->
<!--   # addProviderTiles(provider = providers$Esri.WorldImagery) %>%  -->
<!--     # addProviderTiles(providers$CartoDB, group="carto", layerId = "RGBid", options = pathOptions(pane = "left")) %>%  -->
<!--   # addProviderTiles(providers$CartoDB, group="carto", layerId = "DSMid", options = pathOptions(pane = "right")) %>%  -->
<!--   addProviderTiles(providers$Esri.WorldImagery, -->
<!--                      group = "Toner", -->
<!--                      options = c(providerTileOptions(minZoom = 8, maxZoom = 100), -->
<!--                                  pathOptions(pane = "left")), -->
<!--                      layerId = "RGB" -->
<!--                      ) %>% -->
<!--   addProviderTiles(providers$OpenStreetMap, -->
<!--                      group = "Toner", -->
<!--                      options = c(providerTileOptions(minZoom = 8, maxZoom = 100), -->
<!--                                  pathOptions(pane = "right")), -->
<!--                      layerId = "DSM_pred") %>% -->
<!--   addRasterImage(Quiberon_Litto3D, -->
<!--                        colors=pal2, -->
<!--                        # maxBytes = 200, -->
<!--                        options = pathOptions(pane = "right"), -->
<!--                        layerId = "DSM_pred") %>% -->
<!--   leaflet.extras2::addSidebyside(leftId = "RGB", -->
<!--                                   rightId = "DSM_pred") %>% -->
<!--   addLegend(pal = pal2, values = values(Quiberon_Litto3D), -->
<!--     title = "Bathymetry (m)", -->
<!--     group = "DSM_pred") -->

<!-- Plot_Bathy -->
<!-- # htmlwidgets::saveWidget(plot, file="Slides/maps/map_Bathy_Quiberon.html", selfcontained = F) -->

<!-- ``` -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.fragment .fade-in-then-out fragment-index="12" .absolute top="25%" right="-5%"} -->
<!-- ![](Images/Part3/plot_waterHeight.png){width="1300"} -->
<!-- ::: -->

<!-- ::: {.fragment .fade-in-then-out fragment-index="13" .absolute top="25%" right="-5%"} -->
<!-- ![](Images/Part3/WaterHeightPlot.png){width="1300"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index="14" left="0%" top="30%"} -->
<!-- ```{r LeafletEmersion} -->
<!-- #| echo: false -->
<!-- #| eval: true -->
<!-- #| warning: false -->
<!-- #| out-width: "1100px" -->
<!-- #| out-height: "800px" -->

<!-- library(tidyverse) -->
<!-- library(leaflet) -->
<!-- library(sf) -->
<!-- library(leafem) -->
<!-- library(leaflet.extras2) -->
<!-- library(terra) -->

<!-- stk <- "Data/Part3/Stack_all_variables.tif" %>%  -->
<!--   rast() %>%  -->
<!--   project(crs("EPSG:4326")) -->

<!-- EmersionTime <- (stk$emersion_time/60)/4 -->

<!-- pal2 <- colorNumeric("magma", domain = c(10,16),na.color = "transparent") -->

<!-- Plot <- leaflet() %>%    -->
<!--   # addTiles() %>%  -->
<!--   setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%  -->
<!--   addMapPane("right", zIndex = 0) %>% -->
<!--   addMapPane("left", zIndex = 0) %>% -->
<!--   # addProviderTiles(provider = providers$Esri.WorldImagery) %>%  -->
<!--     # addProviderTiles(providers$CartoDB, group="carto", layerId = "RGBid", options = pathOptions(pane = "left")) %>%  -->
<!--   # addProviderTiles(providers$CartoDB, group="carto", layerId = "DSMid", options = pathOptions(pane = "right")) %>%  -->
<!--   addProviderTiles(providers$Esri.WorldImagery, -->
<!--                      group = "Toner", -->
<!--                      options = c(providerTileOptions(minZoom = 8, maxZoom = 100), -->
<!--                                  pathOptions(pane = "left")), -->
<!--                      layerId = "RGB" -->
<!--                      ) %>% -->
<!--   addProviderTiles(providers$OpenStreetMap, -->
<!--                      group = "Toner", -->
<!--                      options = c(providerTileOptions(minZoom = 8, maxZoom = 100), -->
<!--                                  pathOptions(pane = "right")), -->
<!--                      layerId = "DSM_pred") %>% -->
<!--   addRasterImage(EmersionTime, -->
<!--                        colors=pal2, -->
<!--                        # maxBytes = 200, -->
<!--                        options = pathOptions(pane = "right"), -->
<!--                        layerId = "DSM_pred") %>% -->
<!--   leaflet.extras2::addSidebyside(leftId = "RGB", -->
<!--                                   rightId = "DSM_pred") %>% -->
<!--   addLegend(pal = pal2, values = c(10,16), -->
<!--     title = "Emersion Time per Day (hours)", -->
<!--     group = "DSM_pred") -->

<!-- Plot -->

<!-- # htmlwidgets::saveWidget(plot, file="Slides/maps/map_Bathy_Quiberon.html", selfcontained = F) -->

<!-- ``` -->
<!-- ::: -->

<!-- ::: {.fragment .fade-in-then-out fragment-index="14" .absolute top="25%" right="-5%"} -->
<!-- ![](Images/Part3/Emersion_time.gif){width="1300"} -->
<!-- ::: -->

::: {.absolute top="6.5%" left="0%" .fragment .fade-in fragment-index="7" style="font-size: 40px;"}
*Both Experimental and Satellite Mapping*
:::
  
::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="15%" left="0%" style="text-align: right; font-size: 70px;"}
- Well established radiometric Indices:
:::

:::{.absolute top="30%" left="10%" .fragment .fade-in-then-out fragment-index="7" style="font-size: 50px;"}
$$
f''(\lambda_i) \approx \frac{f(\lambda_{i+1}) - 2f(\lambda_i) + f(\lambda_{i-1})}{(\Delta \lambda)^2}
$$ 
:::
  
::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="50%" left="10%" style="text-align: right; font-size: 50px;"}

$$NDVI = \frac{R(NIR)-R(Red)}{R(NIR)+R(Red)}$$
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="7" top="70%" left="10%" style="text-align: right; font-size: 50px;"}

$$GLI = \frac{[R(Green)-R(Red)]+[R(Green)-R(Blue)]}{(2 \times R(Green) )+ R(Red) + R(Blue) }$$
:::
  

<!-- ::: {.absolute .fragment .fade-in fragment-index="16" top="15%" left="0%" style="text-align: right; font-size: 70px;"} -->
<!-- - Introduction of the Seagrass Heat Shock Index (SHSI): -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="16" top="30%" left="0%" style="text-align: left; font-size: 50px;"} -->

<!-- $$ -->
<!-- \text{SHSI} = I_{SHSI} - R(740) -->
<!-- $$ -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="16" top="50%" left="0%" style="text-align: left; font-size: 50px;"} -->

<!-- $$ -->
<!-- I_{SHSI} = R(560) + \tau    [R(842) - R(560)] -->
<!-- $$ -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index="16" top="70%" left="0%" style="text-align: left; font-size: 50px;"} -->

<!-- $$ -->
<!-- \tau = \frac{740 - 560}{842 - 560} -->
<!-- $$ -->
<!-- ::: -->


<!-- ::: {.fragment .fade-in fragment-index="16" .absolute top="30%" right="0%"} -->
<!-- ![](Images/Part3/Plot_explain_SHSI.png){width="1450"} -->
<!-- ::: -->



## Results {#results_part3} 



::: {.absolute .fragment .fade-out fragment-index="1" top="10%" left="0%" style="text-align: right; font-size: 70px;"}
Spectral signatures:
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="10%" left="0%" style="text-align: right; font-size: 70px;"}
SHSI design
:::

::: {.fragment .fade-out fragment-index="1" .absolute top="10%" left="0%"}
![](Images/Part3/plot_Spectra_exp.png){width="2400"}
:::

::: {.fragment .fade-in-then-out fragment-index="1" .absolute top="20%" left="0%"}
![](Images/Part3/plot_Spectra_exp2.png){width="1200"}
:::

::: {.fragment .fade-in-then-out fragment-index="1" .absolute top="10%" left="50%"}
![](Images/Part3/Plot_explain_SHSI2.png){width="1200"}
:::

::: {.fragment .fade-out fragment-index="7"}
::: {.absolute top="6.5%" left="0%"}
*Heatwave experiment*
:::

::: {.absolute .fragment .fade-in fragment-index="2" top="10%" left="0%" style="text-align: right; font-size: 70px;"}
Spectral metrics:
:::
:::

::: {.fragment .fade-in-then-out fragment-index="2" .absolute top="0%" left="25%"}
![](Images/Part3/merged_indices.png){width="1500"}
:::

::: {.fragment .fade-in-then-out fragment-index="3" .absolute top="0%" left="25%"}
![](Images/Part3/merged_indices1.png){width="1500"}
:::

::: {.fragment .fade-in-then-out fragment-index="4" .absolute top="0%" left="25%"}
![](Images/Part3/merged_indices2.png){width="1500"}
:::

::: {.fragment .fade-in-then-out fragment-index="5" .absolute top="0%" left="25%"}
![](Images/Part3/merged_indices3.png){width="1500"}
:::

::: {.fragment .fade-in fragment-index="6" .absolute top="0%" left="25%"}
![](Images/Part3/merged_indices4.png){width="1500"}
:::


::: {.absolute .fragment .fade-in fragment-index="3" top="30%" left="0%" style="text-align: right; font-size: 50px;"}
$R''_{665 \, \text{nm}}$ drops by 68 %
:::

::: {.absolute .fragment .fade-in fragment-index="4" top="40%" left="0%" style="text-align: right; font-size: 50px;"}
$NDVI$ drops by 31 %
:::

::: {.absolute .fragment .fade-in fragment-index="5" top="50%" left="0%" style="text-align: right; font-size: 50px;"}
$GLI$ drops by 54 %
:::

::: {.absolute .fragment .fade-in fragment-index="6" top="70%" left="0%" style="text-align: right; font-size: 50px;"}
$SHSI$ increases by 420 %
:::



## Material & Methods

::: {.fragment .fade-out fragment-index="1" .absolute top="10%" left="0%"}
![](Images/Part3/plot_Temp_Quiberon1.png){width="1400"}
:::

::: {.absolute top="6.5%" left="0%" }
*Satellite Mapping of the impact of Heatwaves on seagrasses*
:::

::: {style="text-align: center; position: absolute; left: 80%; top: 20%; width: 800px; transform: translate(-50%, -50%)"}
Atmospheric heatwave between the 4th of September 2021 and the 7th of September 2021 in Quiberon
:::

```{r leaflet maps Quiberon}
#| echo: false
#| eval: false
#| warning: false
#| fig-width: 10
#| fig-height: 10

library(htmlwidgets)
library(leaflet)
library(tidyverse)

Projects<-data.frame(
  Name=c("Plouharnel"),
  Lat = c(47.585714),
   Long = c(-3.121394)) %>% 
  sf::st_as_sf(coords=c("Long","Lat") )  %>% 
  sf::st_set_crs("EPSG:4326")  

# custom_icon <- makeIcon(
#   iconUrl = "Images/drone_icon.png",
#   iconWidth = 40, # Adjust the width to fit your needs
#   iconHeight = 40 # Adjust the height to fit your needs
# )

m <- leaflet() %>% setView(lng =-3.121394, lat = 47.585714, zoom = 13) %>% 
  addTiles() %>% 
  addProviderTiles(provider = providers$Esri.WorldImagery) %>% 
  leaflet::addMarkers(data = Projects) %>% 
  addLabelOnlyMarkers(data = Projects,
    label = ~Name
  )

m <- htmlwidgets::onRender(
  m,
  '
  function(el, x) {
    var map = this;

    function toggleLabels() {
      var zoomLevel = map.getZoom();
      map.eachLayer(function(layer) {
        if (layer.getElement && layer.getTooltip && layer.getTooltip()) {
          var labelElement = layer.getTooltip().getElement();
          if (zoomLevel < 10) {
            labelElement.style.display = "none";
          } else {
            labelElement.style.display = "block";
          }
        }
      });
    }

    // Initially toggle labels based on the starting zoom level
    toggleLabels();

    // Toggle labels on zoom end
    map.on("zoomend", function() {
      toggleLabels();
    });
  }
  '
)

saveWidget(m, "maps/map_Quiberon_presentation.html", selfcontained = TRUE)

# Print the map
```

::: {.absolute left="0%" top="45%"}
```{=html}
<iframe width="1400" height="800" src="maps/map_Quiberon_presentation.html" title="Webpage example"></iframe>
```
:::

::: {.fragment .fade-in-then-out fragment-index="1" .absolute top="10%" left="0%"}
![](Images/Part3/plot_Temp_Quiberon2.png){width="1400"}
:::

::: {.fragment .fade-in-then-out fragment-index="2" .absolute top="10%" left="0%"}
![](Images/Part3/plot_Temp_Quiberon3.png){width="1400"}
:::

::: {.fragment .fade-in-then-out fragment-index="3" .absolute top="10%" left="0%"}
![](Images/Part3/plot_Temp_Quiberon4.png){width="1400"}
:::

::: {.absolute top="35%" left="65%"}
![](Images/Part3/Sentinel2.png){width="500"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="70%" left="60%" style="font-size: 50px;"}
3 Sentinel-2 images, level L2A, Low Tide:

- **Before**: 1st of September 2021
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="2" top="70%" left="60%" style="font-size: 50px;"}
3 Sentinel-2 images, level L2A, Low Tide:

- **Before**: 1st of September 2021

- **During**: 6th of September 2021
:::

::: {.absolute .fragment .fade-in fragment-index="3" top="70%" left="60%" style="font-size: 50px;"}
3 Sentinel-2 images, level L2A, Low Tide:

- **Before**: 1st of September 2021

- **During**: 6th of September 2021

- **After**: 8th of October 2021
:::


## Results

::: {.absolute  top="6.5%" left="0%"}
*in situ Satellite Mapping*
:::


::: {.fragment .fade-out fragment-index="1" .absolute bottom="0%"}

```{r LeafletMap_S2_QPs}
#| echo: false
#| eval: true
#| warning: false
#| out-width: "1100px"
#| out-height: "1200px"

library(tidyverse)
library(leaflet)
library(sf)
library(leafem)
library(leaflet.extras2)
library(terra)

img_during <- "Data/Part3/S2/Heatwaves_S2.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


img_before <- "Data/Part3/S2/Heatwaves_S2_before.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))

img_after <- "Data/Part3/S2/Heatwaves_S2_after.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


# NAflag(img) <- NA
img_list <- list.files("Data/Biolittoral", recursive = T, full.names = T,pattern = ".jpg") %>% 
  as_tibble() %>% 
  rename(path = "value") %>% 
  mutate(filenam = basename(path)) %>% 
  mutate(path = gsub("Data","../Data",path))

Unimpacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty =="Healthy_seagrass") %>% 
  dplyr::select(-path) %>% 
  left_join(img_list, by = "filenam")

Impacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty !="Healthy_seagrass")%>% 
  dplyr::select(-path) %>% 
  left_join(img_list, by = "filenam")


all_QPs <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T,)
  
  


# points <- sf::st_transform(points, crs = 3857)

plot_S2_1 <- leaflet() %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 15)  %>% 
  addMapPane("right", zIndex = 1) %>%
  addMapPane("left", zIndex = 1) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100),
                                 pathOptions(pane = "left")),
                     layerId = "UnImpacted"
                     ) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100),
                                 pathOptions(pane = "right")),
                     layerId = "Impacted") %>% # Add raste
  addRasterRGB(img_during, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "right")),
                     layerId = "During") %>% 
  addRasterRGB(img_before, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "left")),
                     layerId = "Before") %>% 
  addRasterRGB(img_after, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "right")),
                     layerId = "Impacted",
                     group = "Image After") %>% 
  addRasterRGB(img_after, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "left")),
                     layerId = "UnImpacted",
                     group = "Image After") %>% 
  addCircleMarkers(
    data        = Unimpacted,
    radius      = 2,
    color       = "lightgreen",
    fillColor   = "lightgreen",
    fillOpacity = 0.8,
    group       = "Unimpacted Points",   # <--- group name
    # options     = pathOptions(pane = "left"),
    popup = ~paste0("<img src='",path, "' width='1000'/>"),
    popupOptions = popupOptions(
    maxWidth  = 600*5,    # Maximum width of the popup
    minWidth  = 100*5,    # Minimum width of the popup
    maxHeight = 600*5)
  ) %>%
  addCircleMarkers(
    data        = Impacted,
    radius      = 2,
    color       = "goldenrod",
    fillColor   = "goldenrod",
    fillOpacity = 0.8,
    group       = "Impacted Points",     # <--- group name
    # options     = pathOptions(pane = "right"),
    popup = ~paste0("<img src='",path, "' width='1000'/>"),
    popupOptions = popupOptions(
    maxWidth  = 600*5,    # Maximum width of the popup
    minWidth  = 100*5,    # Minimum width of the popup
    maxHeight = 600*5)
  ) %>%
  leaflet.extras2::addSidebyside(leftId = "UnImpacted",
                                  rightId = "Impacted") %>% 
    addLegend(
    position = "bottomright",
    colors   = c("lightgreen", "goldenrod"),
    labels   = c("Unimpacted Points", "Impacted Points"),
    title    = "Legend"
  ) %>%
  
  # Add Layers Control to toggle point layers on/off
  addLayersControl(
    overlayGroups = c("Unimpacted Points", "Impacted Points", "Image After"),
    options = layersControlOptions(collapsed = FALSE)
  )%>%
  
  # Hide groups by default (turn them off at startup)
  hideGroup("Unimpacted Points") %>%
  hideGroup("Impacted Points") %>%
  hideGroup("Image After")


plot_S2_1

# htmlwidgets::saveWidget(plot_S2, file="maps/map_Bathy_Quiberon.html", selfcontained = F)

```

:::



::: {.fragment .fade-out fragment-index="1" .absolute top="10%" right="0%"}
![](Images/Part3/plot_Temp_Quiberon3.png){width="1300"}
:::

::: {.fragment .fade-out fragment-index="5"}
::: {.fragment .fade-in fragment-index="1" .absolute top="10%" right="0%"}
![](Images/Part3/plot_Temp_Quiberon3_field.png){width="1300"}
:::
:::

::: {.fragment .fade-out fragment-index="5"}
::: {.fragment .fade-in fragment-index="1" .absolute bottom="0%"}

```{r LeafletMap_S2_QPs2}
#| echo: false
#| eval: true
#| warning: false
#| out-width: "1100px"
#| out-height: "1200px"

library(tidyverse)
library(leaflet)
library(sf)
library(leafem)
library(leaflet.extras2)
library(terra)

img_during <- "Data/Part3/S2/Heatwaves_S2.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


img_before <- "Data/Part3/S2/Heatwaves_S2_before.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))

img_after <- "Data/Part3/S2/Heatwaves_S2_after.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


# NAflag(img) <- NA
img_list <- list.files("Data/Biolittoral", recursive = T, full.names = T, pattern = ".jpg") %>% 
  as_tibble() %>% 
  rename(path = "value") %>% 
  mutate(filenam = basename(path)) %>% 
  mutate(path = gsub("Data","../Data",path))

Unimpacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty =="Healthy_seagrass") %>% 
  dplyr::select(-path) %>% 
  left_join(img_list, by = "filenam")

Impacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty !="Healthy_seagrass")%>% 
  dplyr::select(-path) %>% 
  left_join(img_list, by = "filenam")

  
  
# points <- sf::st_transform(points, crs = 3857)

plot_S2_2 <- leaflet() %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 15)  %>% 
  addMapPane("right", zIndex = 1) %>%
  addMapPane("left", zIndex = 1) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100),
                                 pathOptions(pane = "left")),
                     layerId = "UnImpacted"
                     ) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100),
                                 pathOptions(pane = "right")),
                     layerId = "Impacted") %>% # Add raste
  addRasterRGB(img_during, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "right")),
                     layerId = "During") %>% 
  addRasterRGB(img_before, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "left")),
                     layerId = "Before") %>% 
  addRasterRGB(img_after, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "right")),
                     layerId = "Impacted",
                     group = "Image After") %>% 
  addRasterRGB(img_after, r = 1, g = 2, b = 3, na.color = "transparent",
                     options = c(pathOptions(pane = "left")),
                     layerId = "UnImpacted",
                     group = "Image After") %>% 
  addCircleMarkers(
    data        = Unimpacted,
    radius      = 2,
    color       = "lightgreen",
    fillColor   = "lightgreen",
    fillOpacity = 0.8,
    group       = "Unimpacted Points",   # <--- group name
    # options     = pathOptions(pane = "left"),
    popup = ~paste0("<img src='",path, "' width='1000'/>"),
    popupOptions = popupOptions(
    maxWidth  = 600*5,    # Maximum width of the popup
    minWidth  = 100*5,    # Minimum width of the popup
    maxHeight = 600*5)
  ) %>%
  addCircleMarkers(
    data        = Impacted,
    radius      = 2,
    color       = "goldenrod",
    fillColor   = "goldenrod",
    fillOpacity = 0.8,
    group       = "Impacted Points",     # <--- group name
    # options     = pathOptions(pane = "right"),
    popup = ~paste0("<img src='",path, "' width='1000'/>"),
    popupOptions = popupOptions(
    maxWidth  = 600*5,    # Maximum width of the popup
    minWidth  = 100*5,    # Minimum width of the popup
    maxHeight = 600*5)
  ) %>%
  leaflet.extras2::addSidebyside(leftId = "UnImpacted",
                                  rightId = "Impacted") %>% 
    addLegend(
    position = "bottomright",
    colors   = c("lightgreen", "goldenrod"),
    labels   = c("Unimpacted Points", "Impacted Points"),
    title    = "Legend"
  ) %>%
  
  # Add Layers Control to toggle point layers on/off
  addLayersControl(
    overlayGroups = c("Unimpacted Points", "Impacted Points", "Image After"),
    options = layersControlOptions(collapsed = FALSE)
  )%>%
  
  # Hide groups by default (turn them off at startup)
  # hideGroup("Unimpacted Points") %>%
  # hideGroup("Impacted Points") %>%
  hideGroup("Image After")


plot_S2_2

# htmlwidgets::saveWidget(plot_S2, file="maps/map_HW_Quiberon.html", selfcontained = F)

```
:::

::: {.absolute top="17%" left="0.5%" style="text-align: right; font-size: 50px;"}
[Before]{style="color:white;"}
:::

::: {.absolute top="17%" left="39%" style="text-align: right; font-size: 50px;"}
[During]{style="color:white;"}
:::

::: {.fragment .fade-in-then-out fragment-index="2" .absolute top="40%" right="8%"}
![](Images/Part3/Spectra_before.png){width="1000"}
:::

::: {.fragment .fade-in-then-out fragment-index="3" .absolute top="40%" right="8%"}
![](Images/Part3/Spectra_after.png){width="1000"}
:::

::: {.fragment .fade-in fragment-index="4" .absolute top="10%" right="0%"}
![](Images/Part3/plot_Temp_Quiberon5.png){width="1300"}
:::

::: {.fragment .fade-in fragment-index="4" .absolute top="44%" right="-3%"}
![](Images/Part3/SHSI_S2.png){width="1300"}
:::
:::






::: {.fragment .fade-out fragment-index="6"}
::: {.fragment .fade-in fragment-index="5" .absolute top="15%" left="0%" width="2300px" height="1100px"}

```{r Maps_SHSI}
#| echo: false
#| eval: true
#| warning: false
#| out-width: "2300px"
#| out-height: "1100px"

library(tidyverse)
library(leaflet)
library(sf)
library(leafem)
library(leaflet.extras2)
library(terra)
library(scico)
library(leafsync)


Index_rast <- rast("Data/Part3/Before_During_After_indices_meadowCropped.tif")[[7:9]]

names(Index_rast) <- c("SHSI_Before","SHSI_During","SHSI_After")


Unimpacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty =="Healthy_seagrass")

Impacted  <- sf::st_read("Data/Part3/S2/GCP_biolittoral.shp",quiet = T) %>% 
  dplyr::filter(Trgt_ty !="Healthy_seagrass")

  
Before <- Index_rast$SHSI_Before/100
values(Before)[values(Before) < -2] <- -2
values(Before)[values(Before) > 2] <- 2

During <- Index_rast$SHSI_During/100
values(During)[values(During) < -2] <- -2
values(During)[values(During) > 2] <- 2

After <- Index_rast$SHSI_After/100
values(After)[values(After) < -2] <- -2
values(After)[values(After) > 2] <- 2


img_during <- "Data/Part3/S2/Heatwaves_S2.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


img_before <- "Data/Part3/S2/Heatwaves_S2_before.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))

img_after <- "Data/Part3/S2/Heatwaves_S2_after.tif" %>% 
  raster::stack() %>% 
  raster::projectRaster(crs = raster::crs("+init=EPSG:3857"))


  
# pal2 <- colorNumeric("batlow", domain = c(-2,2),na.color = "transparent")
pal2 <- colorNumeric(scico(n = 256, palette = "batlow"), domain = c(-2, 2), na.color = "transparent")






m1 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>%
  addRasterImage(Before,
                   colors=pal2,
                   layerId = "Before")

m2 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>%
  addRasterImage(During,
                   colors=pal2,
                   layerId = "During")

m3 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>%
  addRasterImage(After,
                   colors=pal2,
                   layerId = "After")
m4 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>% 
  addRasterRGB(img_before, r = 1, g = 2, b = 3, na.color = "transparent",
                     layerId = "Before")

m5 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>% 
  addRasterRGB(img_during, r = 1, g = 2, b = 3, na.color = "transparent",
                     layerId = "During")

m6 <- leaflet(width = "100%", height = "600px") %>%   
  # addTiles() %>% 
  setView(lng =-3.121394, lat = 47.585714, zoom = 14) %>%
  addProviderTiles(providers$Esri.WorldImagery,
                     group = "Toner",
                     options = c(providerTileOptions(minZoom = 8, maxZoom = 100)))%>% 
  addRasterRGB(img_after, r = 1, g = 2, b = 3, na.color = "transparent",
                     layerId = "After")

sync(m1, m2, m3, m4, m5, m6, sync = "all",ncol = 3, no.initial.sync = T)


# htmlwidgets::saveWidget(plot, file="Slides/maps/map_Bathy_Quiberon.html", selfcontained = F)
```

:::

::: {.fragment .fade-in fragment-index="5" .absolute top="35%" right="5%"}
![](Images/Part3/Scale__SHSI.png){height="500"}
:::

::: {.absolute .fragment .fade-in fragment-index="5" top="10%" left="0%" style="text-align: left; font-size: 50px;"}
Before
:::

::: {.absolute .fragment .fade-in fragment-index="5" top="10%" left="43%" style="text-align: center; font-size: 50px;"}
During
:::

::: {.absolute .fragment .fade-in fragment-index="5" top="10%" right="9%" style="text-align: right; font-size: 50px;"}
After
:::
:::

::: {.fragment .fade-in fragment-index="6" .absolute top="10%" left="0%"}
![](Images/Part3/GAM_emersion.png){width="2400"}
:::


## Discussion {#discussion_part3} 

```{r Plot Spectra Stressed}
#| echo: false
#| eval: true
#| warning: false

library(MapRs)
library(lubridate)
library(patchwork)
library(hsdar)
library(gganimate)

df_spectra_exp <- read.csv("Data/Part3/df_experiment.csv") %>% 
  as_tibble() %>% 
  dplyr::filter(Scenario == "Treatment",
                Date != "07/17/2024") %>% 
  mutate(groups = case_when(Date == "07/16/2024" ~ "Unimpacted",
                            T ~ "Impacted")) %>% 
  group_by(groups,Wavelength) %>% 
  reframe(std_cor = mean(std_cor, na.rm = T))

Color_spectra = c("Unimpacted" = "darkgreen","Impacted" = "#73523E")


plot_Spectra_exp <- df_spectra_exp %>%
  mutate(cols = groups,
         groups = as_factor(groups)) %>% 
  ggplot()+
  geom_line(aes(x = Wavelength, y = std_cor, color = cols, group = 1L), linewidth = 1)+
  scale_color_manual(values = Color_spectra,
                        name = "Status",
                        guide = guide_legend(override.aes = list(linewidth = 1))
                     )  +
  theme_Bede() + 
  ylab("Standardized Reflectance")+
  xlab("Wavelength (nm)")+
    theme(
      strip.text.x = element_text(size =17),
      legend.title = element_text(size =17, hjust = 0.5),
      legend.title.position = "top",
      legend.text = element_text(size =13),

      # legend.text = element_text(hjust = 0, size =13),
      axis.text.x = element_text(size = 13),
      axis.text.y = element_text(size = 13),
      axis.title.x = element_text(size = 17),
      axis.title.y = element_text(size = 17),
      legend.position = "top",
      legend.key.width = unit(1,"cm"),
      legend.key.height = unit(5,"mm"),

    plot.margin = margin(t = 5, r = 5, b = 5, l = 5), # Adjusts plot margins
    legend.spacing.y = unit(0.1, "cm"),  # Reduces space between legend items vertically
    legend.margin = margin(t = 0, b = -10) 
    ) +

    # Animate sensor changes globally
    transition_states(cols)+
    ease_aes("sine-in-out")

rendered <- animate(plot_Spectra_exp, duration = 3, fps = 20, width = 10, height = 10, units = "in", res = 300, end_pause = 1, rewind = F, renderer = gifski_renderer(loop = T))


anim_save("Images/Part3/Figure_Impacted_Seagrass.gif", animation = rendered)
```

::: {.absolute top="6.5%"}
*Mapping Impacted meadows*
:::

::: {.absolute top="15%" left="50%" width="1200px"}
**Seagrasses impacted by heatwave have a distinct spectral signature**

::: {.fragment .fade-out fragment-index="2"}
- Reflectance drops at 560 and 740nm
:::
:::

::: {.fragment .fade-out fragment-index=2" .absolute top="10%" left="0%"}
![](Images/Part3/Figure_Impacted_Seagrass.gif){width="1200"}
:::


::: {.absolute .fragment .fade-in-then-out fragment-index="1" top="25%" left="55%" width="1O00px"}
**Thermal stress = Oxydative stress**

- Degradation of Chlorophyll-a
- Shift in pigment ratios = Carotenoids becoming more prominent

**Oxydative stress = Membrane damages**
:::

::: {.absolute .fragment .fade-in fragment-index="2" top="25%" left="50%" width="1O00px"}
**Possible to detect seagrass thermal stress using satellite remote sensing, using SHSI**

::: {.fragment .fade-out fragment-index="3"}
- Most Sensitive early-metric to flag damage over meadows 
- Designed to be used by most space missions (Sentinel-2, Pléiades, Wordview-3, SkySat, GeoSat-2...)
- but also by future missions (Sentinel-2 Next Generation, LandSat Next)
:::
:::

::: {.fragment .fade-in-then-out fragment-index="2"}
::: {.absolute top="10%" left="0%"}
![](Images/Part3/WordView3.png){width="600"}
:::

::: {.absolute top="45%" left="0%"}
![](Images/Part3/GEOSAT.png){width="600"}
:::

::: {.absolute top="27%" left="20%"}
![](Images/Part3/L8.png){width="600"}
:::

::: {.absolute bottom="15%" left="25%"}
![](Images/Part3/LS_Next.png){width="500"}
:::

::: {.absolute bottom="0%" left="50%"}
![](Images/Part3/Pleiades.png){width="600"}
:::

::: {.absolute bottom="0%" right="0%"}
![](Images/Part3/S2.png){width="600"}
:::
:::

::: {.absolute .fragment .fade-in fragment-index="3" top="40%" left="50%" width="1000px"}
**Satellite mapping reveals tide-modulated, patchy impacts**

::: {.fragment .fade-out fragment-index="4"}
- Upper intertidal areas are more impacted  
- 95% of darkened patches are above 3.9 m  
- Darkening occurs in seagrasses exposed more than 13 h per day  
:::
:::


```{r making DarkeningIndexMap}
#| echo: false
#| eval: false
#| warning: false

library(ggplot2)
library(sf)
library(cowplot)
library(tidyterra)

msk <- read_sf("Data/Part3/mask_study_quiberon_narrow.shp")

RGB_comp <- "Data/Part3/after_RGB_comp.tif" %>% 
  terra::rast() %>% 
  terra::crop(msk)

writeRaster(RGB_comp, "Data/Part3/after_RGB_comp_cropped.tif")
# 
# zoom2 <- "Data/shp/zoom_bathy_insert.shp" %>% 
#   read_sf()

# coltab_darkening <- c("darkseagrass" = c("#436EEE"))
coltab_darkening <- c("darkseagrass" = c("#009ACD"))


# 
# segment_darkening= data.frame(x1 = c(490524, 490925),
#                      x2 = c(490797,491540),
#                      y1 = c(5269905,5269905),
#                      y2 = c(5270467,5270448),
#                      id = c(1,2))

sf_darkseagrass <- read_sf("Data/Part3/darkening_patches_SDI.shp")

main_plot_darkening <- ggplot() +
  geom_spatraster_rgb(data = RGB_comp,interpolate = F,max_col_value = 220 ) +
  geom_sf(data = sf_darkseagrass, aes(color = "darkseagrass", fill = "darkseagrass"), linewidth = 0.7) +
  # geom_sf(data = bathy_line, color = "goldenrod2", linewidth = 0.7) +

  # geom_sf(data = zoom2, color = "red", fill = NA,linewidth = 1, linetype = "dashed")+
  # geom_segment(data = segment_bathy, aes(x = x1, xend = x2, y = y1, yend = y2, group = id), color = "red", linewidth = 0.8, linetype = "dashed")+
  # geom_label(aes(x = 490200, y = 5271680, label = "B"), alpha = 0.5, size = 10)+

  coord_sf(expand = FALSE,
          label_axes = list(
          bottom = "E", right = "N"
           )) +
  
  scale_color_manual(values = coltab_darkening,
                     label = "Dark Patches",
                     name = NULL) +
  scale_fill_manual(values = coltab_darkening,
                     label = "Dark Patches",
                     name = NULL) +
  theme_Bede_Map() +
  theme(
    legend.position = c(0.95, 0.98),
    legend.background = element_rect(fill = alpha("white", 0.5)),
    plot.background = element_rect(fill = "white"),

    # axis.text.y = element_text(vjust = 0.5,hjust = 0.5, angle = 90),
    axis.text.y.right = element_text(vjust = 0.5,hjust = 0.5, angle = 90),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )
main_plot_darkening

ggsave("Images/Part3/Map_darkening.png",main_plot_darkening, width = 5, height = 9, dpi = 400)

```

::: {.fragment .fade-in-then-out fragment-index="3" .absolute top="10%" left="5%"}
![](Images/Part3/Map_darkening.png){height="1250"}
:::



```{r data opening HW}
#| echo: false
#| eval: false
#| warning: false

library(tidyverse)

df <- list.files("Data/Part3/",pattern = "HOR_departement_56_*", full.names = TRUE) %>% 
  map(read.delim,
      sep = ";",
      .progress = TRUE) %>%
  list_rbind() %>% 
  dplyr::select(NOM_USUEL, LAT,LON,,AAAAMMJJHH,`T`, TN, TX, T10, T20, T50,T100) %>% 
  dplyr::filter(!is.na(`T`))
```

```{r first process HW}
#| echo: false
#| eval: false
#| warning: false

library(heatwaveR)
library(Utilities.Package)

df_date <- df  %>% 
  mutate(date = as.POSIXct(strptime(AAAAMMJJHH, format = "%Y%m%d%H"))) %>% 
  group_by(NOM_USUEL) %>% 
  reframe(min_date = min(date,na.rm = T),
          max_date = max(date,na.rm = T),
          n = n())

selected_site <- df_date %>% 
  filter(n ==max(n)) %>% 
  pull(NOM_USUEL)

df_sub <- df %>% 
  dplyr::filter(NOM_USUEL == "LORIENT-LANN BIHOUE",
                !is.na(`T`)) %>% 
  dplyr::select(NOM_USUEL, LAT,LON,,AAAAMMJJHH,`T`, TN, TX, T10, T20, T50,T100) %>% 
  mutate(date = as.POSIXct(as.character(AAAAMMJJHH), format = "%Y%m%d%H",tz = "UTC"))


ggplot(df_sub)+
  # geom_hex(aes(x = date, y = `T`), bins = 10)+
  geom_line(aes(x = date, y = `T`))+
  ylab("Temperature (°C)")+
  xlab("Date")+
  theme_Bede()+
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

df_heatwaveR <- df_sub %>% 
  rename(t = date,
         temp = `T`) %>% 
  dplyr::select(t,temp) %>% 
  mutate(t = as.Date(t)) %>% 
  group_by(t) %>% 
  reframe(temp = max(temp,na.rm = T)) %>% 
  dplyr::filter(t > as.Date("1948-12-31"))

  

  clim <- ts2clm(df_heatwaveR, climatologyPeriod = c(min(df_heatwaveR$t), max(df_heatwaveR$t)))
  
  event <- detect_event(clim,categories = T,minDuration = 3)
  
  res <- detect_event(clim, minDuration = 3)
  mhw <- res$clim
  
  mhw %>%
    filter(t> as.Date("2022-01-01") ) %>%
ggplot(aes(x = t, y = temp))+
    geom_line() +
  geom_flame(aes(y2 = thresh))
```

```{r frequency of heatwaves as define in Perkins and Alexander (2013)}
#| echo: false
#| eval: false
#| warning: false


library(tidyverse)
library(heatwaveR)
library(mgcv)
library(Utilities.Package)

freq_heatwave <- event %>% 
  mutate(year = substr(as.character(date_start),1,4)) %>% 
  group_by(year) %>% 
  reframe(value = n()) %>% 
  mutate(data = "Frequency")

intensity_heatwave <- event %>% 
  mutate(year = substr(as.character(date_start),1,4)) %>% 
  group_by(year) %>% 
  reframe(value = sum(intensity_cumulative)) %>% 
  mutate(data = "Intensity") %>% 
  mutate(value = sqrt(value*value))


df_heatwaves <- rbind(freq_heatwave,intensity_heatwave) %>% 
  pivot_wider(names_from = data, values_from = value)

# coeff=30
# ggplot(df_heatwaves, aes(x=as.numeric(year))) +
#   geom_point( aes(y=Frequency), color = "blue") +
#   geom_smooth( aes(y=Frequency), color = "blue",method = "gam")+
#   geom_point( aes(y=Intensity / coeff), color = "red") +
#   geom_smooth( aes(y=Intensity / coeff), color = "red",method = "gam")+
#   scale_y_continuous(
#     
#     # Features of the first axis
#     name = "Frequency",
#     
#     # Add a second axis and specify its features
#     sec.axis = sec_axis(~.*coeff, name="Intensity")
#   )+
#   theme_Bede()


df_freq_HW <- df_heatwaves %>% 
  dplyr::select(-Intensity) %>% 
  mutate(year = as.numeric(year))

gam_freq_HW <- mgcv::gam(Frequency ~ s(year,
                                       k=3), 
                 # family = poisson(),
                 data = df_freq_HW)

Utilities.Package::Model_Check(gam_freq_HW)


NewData_freq_HW<-expand_grid(year=unique(df_freq_HW$year))

pred_freq_HW <- predict(gam_freq_HW, NewData_freq_HW, se.fit = T, type = "link")


NewData_freq_HW <- NewData_freq_HW %>% 
  mutate(fit = pred_freq_HW$fit,
         se = pred_freq_HW$se.fit)

(heatwaves_frequency <- ggplot(df_freq_HW, aes(x=year))+
  geom_point(aes(y=Frequency), color = "darkred", alpha = 0.3)+
    geom_line(data = NewData_freq_HW, aes(x = year, y = fit),color = "darkred")+
    geom_ribbon(data = NewData_freq_HW, aes(x = year, y = fit, ymin = fit-se, ymax = fit+se),color = NA ,fill = "darkred",alpha = 0.2)+
    ylab(expression("Frequency of atmospheric heatwaves (year"^"-1" * ")"))+
    xlab(expression("Years"))+
    # scale_x_continuous(position = "top")+
    theme_Bede()+
    # scale_fill_manual(values = coltab)+
    theme(
      # strip.text.y= element_text(size =17),
       strip.text.y= element_blank(),
      # legend.title = element_text(size =17, hjust = 0.5),
      # legend.title = element_blank(),
      # legend.title.position = "top",
      legend.text = element_text(size =20),

      # legend.text = element_text(hjust = 0, size =13),
      axis.text.x = element_text(size = 20),
      axis.text.y = element_text(size = 20),
      axis.title.x = element_text(size = 20),
      axis.title.y = element_text(size = 20),
      
      legend.position = c(0.13, 0.92),
      # legend.position = "top",
      plot.background = element_rect(fill = "white", color =NA) ,
      legend.key.width = unit(1,"cm"),
      legend.key.height = unit(2,"mm")

    # plot.margin = margin(t = 5, r = 5, b = 5, l = 5), # Adjusts plot margins
    # legend.spacing.y = unit(0.1, "cm"),  # Reduces space between legend items vertically
    # legend.margin = margin(t = 0, b = -10)  
      # panel.border = element_blank(),
    )
)


df_Int_HW <- df_heatwaves %>% 
  dplyr::select(-Frequency) %>% 
  mutate(year = as.numeric(year))

gam_Int_HW <- mgcv::gam(Intensity ~ s(year,
                                       k=3), 
                 # family = poisson(),
                 data = df_Int_HW)

Utilities.Package::Model_Check(gam_Int_HW)


NewData_Int_HW<-expand_grid(year=unique(df_Int_HW$year))

pred_Int_HW <- predict(gam_Int_HW, NewData_Int_HW, se.fit = T, type = "link")


NewData_Int_HW <- NewData_Int_HW %>% 
  mutate(fit = pred_Int_HW$fit,
         se = pred_Int_HW$se.fit)

(heatwaves_Intensity <- ggplot(df_Int_HW, aes(x=year))+
  geom_point(aes(y=Intensity), color = "darkred", alpha = 0.3)+
    geom_line(data = NewData_Int_HW, aes(x = year, y = fit),color = "darkred")+
    geom_ribbon(data = NewData_Int_HW, aes(x = year, y = fit, ymin = fit-se, ymax = fit+se),color = NA ,fill = "darkred",alpha = 0.2)+
    ylab(expression("Cumulative intensity of atmospheric heatwaves (°C)"))+
    xlab(expression("Years"))+
    # scale_y_continuous(position = "right")+
    # scale_x_continuous(position = "top")+

    theme_Bede()+
    # scale_fill_manual(values = coltab)+
    theme(
      # strip.text.y= element_text(size =17),
       strip.text.y= element_blank(),
      # legend.title = element_text(size =17, hjust = 0.5),
      legend.title = element_blank(),
      legend.title.position = "top",
      legend.text = element_text(size =13),

      # legend.text = element_text(hjust = 0, size =13),
      axis.text.x = element_text(size = 13),
      axis.text.y = element_text(size = 13),
      axis.title.x = element_text(size = 13),
      axis.title.y = element_text(size = 13),
      
      legend.position = c(0.13, 0.92),
      # legend.position = "top",
      plot.background = element_rect(fill = "white", color =NA) ,
      legend.key.width = unit(1,"cm"),
      legend.key.height = unit(2,"mm")

    # plot.margin = margin(t = 5, r = 5, b = 5, l = 5), # Adjusts plot margins
    # legend.spacing.y = unit(0.1, "cm"),  # Reduces space between legend items vertically
    # legend.margin = margin(t = 0, b = -10)  
      # panel.border = element_blank(),
    )
)


plot <- heatwaves_frequency / heatwaves_Intensity

ggsave("Images/Part3/HW_Freq_Inten.png", heatwaves_frequency, height = 10, width = 9.57, dpi = 300)
```


::: {.fragment .fade-in fragment-index="4" .absolute top="10%" left="0%"}
![](Images/Part3/HW_Freq_Inten.png){height="1200"}
:::

::: {.absolute .fragment .fade-in fragment-index="4" top="50%" left="50%" width="1O00px"}
**Rapid global escalation of HW frequency, intensity and duration**

- How does increasing heatwave pressure affect recovery capacity of Z. noltii?
- Can seagrasses maintain resilience under more frequent aerial exposure?
- Are upper-intertidal meadows approaching a tipping point?

:::


# General conclusions and future perspectives {data-stack-name="Discussion" background-image="Images/Part4/Background_Part4.png"}

- [Macrophyte Discrimination](#macrophyte_descrimination)
- [Drone Technologies in Coastal Monitoring](#drone_tech)
- [Drone and Satellite Interactions](#drone_sat)
- [RS: A Powerful Lens on Coastal Changes](#ecosystem_threats)



## Macrophyte Discrimination: Successes & Challenges {#macrophyte_descrimination auto-animate="true"}

::: {.fragment .absolute width="1300" .fade-up fragment-index="1" data-id="success-mechanism"}
**Key Success:** Multispectral RS + ML effectively differentiate intertidal vegetation, even with similar pigments (e.g., seagrass vs. green macroalgae).
:::
::: {.fragment .absolute top="15%" width="1300" .fade-up fragment-index="1" data-id="success-mechanism" style="margin-top: 2em;"}
**Core Mechanism:** Relies on detecting subtle spectral variations (pigment proportions & concentrations).
:::


::: {.fragment .absolute top="30%" width="1300" .fade-up fragment-index="2" style="margin-top: 2em;"}
**DISCOV Algorithm – A Key Output:**

- Dynamic, adaptable, and open-source (GitHub).
- **Challenge:** Initial underperformance with Florideophyceae due to limited training data.
- **Solution:** Expanded training dataset significantly improved model accuracy & robustness.
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="1" bottom="0%" right="0%"}
![](Images/Part1/Figure_Hyperspectral_Faded_zoomed_out.gif){width="1200"}
:::

::: {.absolute .fragment .fade-in-then-out fragment-index="2" bottom="0%" right="0%"}
![](Images/Part4/DISCOV2.png){height="1200"}
:::

::: {.fragment .absolute top="65%" .fade-up fragment-index="3" style="margin-top: 1em;"}
**Ongoing Challenge:** Natural variability in pigment content (phenology, stress, intraspecies variation).
:::

::: {.fragment .absolute top="75%" .fade-up fragment-index="4" style="margin-top: 1em;"}
**Future Direction:** Continue expanding the training dataset (broader geographic/temporal range) to enhance algorithm generalisability.
:::

library 

<!-- ## Drone Technologies in Coastal Monitoring {#drone_tech auto-animate="true"} -->

<!-- ::: {.absolute top="-4%" right="-10%" style="z-index: -99;"} -->
<!-- <video src="Video/Intro/Drone_Flight.mp4" height="1450" autoplay loop muted playsinline></video> -->
<!-- ::: -->

<!-- **Significance of UAVs (Drones):** -->

<!-- ::: {.incremental} -->
<!-- - Provide **very high-resolution** spatial data. -->
<!-- - Offer **flexible and on-demand** deployment. -->
<!-- - Crucial for capturing **fine-scale habitat heterogeneity** and rapid environmental changes. -->
<!-- ::: -->

<!-- ::: {.fragment .absolute top="30%" .fade-in-then-out style="margin-top: 2em;"} -->
<!-- **Applications Demonstrated in Associated Research:** -->

<!-- **Aquaculture Monitoring:** -->
<!-- Estimating *Kappaphycus alvarezii* biomass & carrageenan (Nurdin et al., 2023). -->

<!-- ![](Images/Part4/Kappa_mapping-Long.png){height="700"} -->

<!-- ::: -->

<!-- ::: {.fragment .absolute top="30%" .fade-in-then-out style="margin-top: 2em;"} -->
<!-- **Applications Demonstrated in Associated Research:** -->

<!-- **Oyster Farm Assessment:** -->
<!-- Mapping intertidal oyster farm structures, mesh bag sizes, & table heights (A. Román et al., 2023). -->

<!-- ![](Images/Part4/oyster_mapping.jpg){height="700"} -->
<!-- ::: -->



<!-- --- -->

## Drone and Satellite Interactions: A Powerful Synergy {#drone_sat auto-animate="true"}


::: {.absolute .fragment .fade-out fragment-index="1" bottom="0%" left="0%"}
![](Images/Part4/Sentinel2.jpg){width="1200"}
:::

::: {.fragment .fade-in-then-out fragment-index="1" .absolute bottom="0%" right="10%"}
![](Images/Part4/WorkflowBede.jpg){width="900"}
:::

::: {.fragment .fade-in-then-out fragment-index="2" .absolute bottom="-5%" right="0%"}
![](Images/Part4/PhenologyBede.jpg){height="800"}
:::

<!-- ::: {.fragment .fade-in-then-out fragment-index="3" .absolute bottom="-5%" right="10%"} -->
<!-- ![](Images/Part4/TrendsBede.png){height="800"} -->
<!-- ::: -->


**Complementary Strengths:**

- **UAVs:** Unmatched spatial resolution, Flexible, ground-truth validation.
- **Satellites:** Broad spatial coverage, consistent temporal monitoring for large-scale trends.

::: {.fragment .fade-up fragment-index="1" style="margin-top: 1em;"}
**Example: The ICE CREAMS Model (Davies et al., 2024a,b):**

  - **Methodology:** DISCOV (drone-derived) classifications used to train and validate ICE CREAMS (Sentinel-2 satellite) model.
  
  - **Achievements:**
      - Mapped intertidal seagrass across diverse European sites.
      - Revealed latitudinal gradients in seagrass phenology.
      - Tracked inter-annual trends in seagrass extent.
      
:::

::: {.fragment .absolute bottom="10%" .fade-up fragment-index="4" style="margin-top: 1em;"}
**Key Benefit:** This synergistic approach balances local accuracy with regional/global scalability, optimising monitoring efforts.
:::

---

## RS: A Powerful Lens on Coastal Changes {#ecosystem_threats}

::: {.absolute top="6.5%" left="0%" }
*The DAPSI(W)R(M) framework*
:::

::: {.absolute .fragment .fade-out fragment-index="1" top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2.jpg){height="1200"}
:::

::: {.absolute top="15%" left="0%" width="1100px" style="font-size: 50px;"}
*DAPSI(W)R(M)*, a framework to connect human activities to environmental impacts
:::


::: {.fragment .fade-in-then-out fragment-index="1"}

::: {.absolute top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2_D.jpg){height="1200"}
:::

::: {.absolute top="28%" left="0%" width="1000px" style="font-size: 40px;"}
👥 **Driver**  
The growing population necessitates more sites for oyster production.

- 🛰 Study Sea Surface Temperature, Turbidity, Chlorophyll-a
- 🛸 Provide ultra-high-resolution topographic mapping of intertidal sediments.
:::

::: {.absolute top="60%" left="0%" width="1100px" style="font-size: 40px;"}
![](Images/Part2/Belon_Bathy.png)
:::
:::

::: {.fragment .fade-in-then-out fragment-index="2"}

::: {.absolute top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2_A.jpg){height="1200"}
:::

::: {.absolute top="28%" left="0%" width="1000px" style="font-size: 40px;"}
⚙️ **Activity**  

Expansion of oyster aquaculture in coastal and estuarine areas.

- 🛰 Study Sea Surface Temperature, Turbidity, Chlorophyll-a... associated is oyster production models  
- 🛸 Provide ultra-high-resolution mapping of farm structures on demand.
:::

::: {.absolute top="60%" left="0%" width="1100px" style="font-size: 40px;"}

:::{.absolute bottom="-5%" right="10%"}
[Román et al. (2023)](https://doi.org/10.1016/j.ecss.2023.108432)
:::

![](Images/Part4/oyster_mapping.jpg)
:::
:::

::: {.fragment .fade-in-then-out fragment-index="3"}

::: {.absolute top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2_P.jpg){height="1200"}
:::

::: {.absolute top="28%" left="0%" width="1000px" style="font-size: 40px;"}
⚠️ **Pressure**  

Waste, sediment resuspension, and nutrient input from farming operations.

- 🛰 Track turbidity and chlorophyll anomalies.
- 🛸 Mapping the spread of alien species
:::

::: {.absolute bottom="0%" left="0%"}
<video src="Video/Part4/coucou.mp4" height="600" autoplay loop muted playsinline></video>
:::
:::

::: {.fragment .fade-in-then-out fragment-index="4"}

::: {.absolute top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2_SW.jpg){height="1200"}
:::

::: {.absolute top="28%" left="0%" width="1000px" style="font-size: 40px;"}
🌿 **State & Impact**  

Altered water quality and degraded seagrass beds near farming sites.

- 🛰 Detect habitat trends over time and across regions.
- 🛸 Assess detailed plant cover, diversity and benthic healths.
:::

::: {.absolute top="60%" left="0%" width="1100px" style="font-size: 40px;"}
![](Images/Part2/Belon_DISCOV.png)
:::
:::

::: {.fragment .fade-in fragment-index="5"}

::: {.absolute top="10%"  right="0%"}
![](Images/Part4/Dapsiwrm2_R.jpg){height="1200"}
:::

::: {.absolute top="28%" left="0%" width="1000px" style="font-size: 40px;"}
🛠 **Responses (Measures)**  

Environmental regulations, site management, and restoration programs.

- 🛸 Provide metrics for restoration efforts and track their success.
:::

::: {.absolute top="50%" left="5%" width="800px" style="font-size: 40px;"}
![](Images/Part2/DISCOV_logoV2.png)
:::
:::



# {background-image="Images/Background_lastslide.png"}


















<!-- ## From case studies → A vision for resilient European coasts {auto-animate="true"} -->

<!-- <span style="font-size:130%; font-weight:bold;">Multi‑scale remote sensing now gives us the <em>where, when &amp; why</em> of intertidal change — fast enough for real‑time management.</span> -->

<!-- ::: {.incremental .absolute top="30%"} -->
<!-- - **RS proved accurate & scalable** across Europe -->
<!-- - **ML tools stay open & evolving** (DISCOV) -->
<!-- - **Bridges field ↔ drone ↔ satellite gaps** -->
<!-- ::: -->

<!-- ::: {.absolute top="30%" right="0%"} -->
<!-- ![](Images/Part4/Gafanha.png){.circular-fade height="430"} -->
<!-- ::: -->

<!-- ::: {.absolute top="30%" left="50%"} -->
<!-- ![](Images/Part4/ASD1.png){.circular-fade height="430"} -->
<!-- ::: -->

<!-- ::: {.absolute bottom="0%" right="0%" data-id="Map_europe"} -->
<!-- ![](Images/Part4/Map_europe.png){.circular-fade height="450"} -->
<!-- ::: -->

<!-- ::: {.absolute bottom="0%" left="50%"} -->
<!-- ![](Images/Part4/S2_HW.png){.circular-fade height="430"} -->
<!-- ::: -->

<!-- ## Outcomes of this PhD {auto-animate="true"} -->

<!-- <span style="font-size:120%; font-weight:bold;">From algorithm accuracy to Europe‑wide impact</span> -->

<!-- ::: {.fragment .fade-out fragment-index=1 .absolute top="15%"} -->
<!-- - **97 % taxonomic accuracy** with DISCOV -->
<!-- ::: -->

<!-- ::: {.fragment .fade-out fragment-index=3} -->
<!-- ::: {.fragment .fade-in fragment-index=1 .absolute top="15%"} -->
<!-- - **97 % taxonomic accuracy** with DISCOV and ICE CREAMS -->
<!-- - **Europe‑wide seagrass trends** 2017 – 2024 -->
<!-- ::: -->
<!-- ::: -->

<!-- ::: {.fragment .fade-in fragment-index=3 .absolute top="15%"} -->
<!-- - **97 % taxonomic accuracy** with DISCOV and ICE CREAMS -->
<!-- - **Europe‑wide seagrass trends** 2017 – 2024 -->
<!-- - **Open‑source assets** (code & data) accelerating adoption -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-out fragment-index=1 data-id="Map_europe" bottom="-8%" right="-7.6%"} -->
<!-- ![](Images/Part1/Map_Drone-01.png){height="1400"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-out fragment-index=1  bottom="-40%" left="0%"} -->
<!-- ![](Images/Part4/Gafanha_Low.png){height="1400"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-out fragment-index=1  bottom="-40%" left="30%"} -->
<!-- ![](Images/Part4/Gaf_Low_Pred.png){height="1400"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index=1 bottom="0%" right="0%"} -->
<!-- ![](Images/Part4/WorkflowBede.jpg){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index=2 bottom="0%" right="0%"} -->
<!-- ![](Images/Part4/TrendsBede.jpg){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in-then-out fragment-index=2 bottom="0%" left="0%"} -->
<!-- ![](Images/Part4/PhenologyBede.jpg){height="900"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index=3 bottom="0%" right="0%"} -->
<!-- ![](Images/Part4/DISCOV2.png){height="1200"} -->
<!-- ::: -->

<!-- ::: {.absolute .fragment .fade-in fragment-index=3 bottom="-2%" left="0%"} -->
<!-- ![](Images/Part4/ICECREAMS.png){height="900"} -->
<!-- ::: -->

